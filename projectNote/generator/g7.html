<div class="ant-card-body"><h1 class="ant-typography" style="font-size: 30px;" data-id="">7. 模板制作工具</h1><div class="ant-space ant-space-horizontal ant-space-align-center" style="margin-bottom: 15px; gap: 8px;"><div class="ant-space-item" style=""><a class="text-gray-500" target="_blank" href="/user/1601072287388278786">程序员鱼皮</a></div><span class="ant-space-item-split" style=""><div class="ant-divider ant-divider-vertical" role="separator"></div></span><div class="ant-space-item" style=""><span class="text-gray-500">2024-05-16 14:41</span></div><span class="ant-space-item-split" style=""><div class="ant-divider ant-divider-vertical" role="separator"></div></span><div class="ant-space-item"><span class="text-gray-500">阅读 712</span></div></div><div style="margin-bottom: 16px;"></div><div class="course-container"><div class="md-viewer "><div class="markdown-body"><h2 data-id="heading-0">前情回顾</h2>
<p>在上期教程中，我们首先明确了第二阶段的目标 —— 通过代码生成器制作工具快速生成 Spring Boot 项目模板代码生成器，并且介绍了示例生成的 Spring Boot 项目模板。然后我们分析得出了 7 种生成器应具备的功能，并且从中梳理除了几个制作工具应具备的通用配置能力，比如支持用一个参数同时控制多个文件的生成、定义可选开启的参数组等等。</p>
<p>但光有这些能力还是不够的，想更快地制作代码生成器，我们还可以从“根源”去解决问题，直接通过制作工具来生成项目模板和配置文件。</p>
<p>本期教程，就让我们来进一步增加制作工具的功能，实现上述目标吧！</p>
<h2 data-id="heading-1">本节重点</h2>
<p>本节教程属于项目的第二阶段 —— 开发代码生成器制作工具。</p>
<p>本节主要是开发模板制作工具，这一期的教程和代码甚至可以单独拿出来作为一个 <code>快速挖坑工具</code> 小项目了！</p>
<p>重点内容：</p>
<ol>
<li>模板制作工具 - 需求分析</li>
<li>模板制作工具 - 核心设计</li>
<li>模板制作工具 - 基础功能实现</li>
<li>模板制作工具 - 更多功能实现</li>
</ol>
<h2 data-id="heading-2">一、需求分析</h2>
<p>还记得么？在上期教程的最后，我们遇到了一个问题：当我们更改元信息数据模型配置，将模型参数进行分组后，我们之前已经编写的 FreeMarker 动态模板就无法正确生成内容了。这是因为使用的模型参数发生了变更，导致无法正确获得值。</p>
<p>通过这个问题，我们会发现，动态模板和元信息配置是有很强的绑定关系的，稍有不慎，就有可能导致代码生成异常。</p>
<p>此外，我们上期教程中，还遗留了一个需求无法解决 —— 替换生成的代码包名。</p>
<p>因为对于 Spring Boot 项目模板这种相对复杂的项目，里面用到包名的 Java 文件太多了，如果每个文件都要自己“挖坑”来制作模板，不仅成本高、也容易出现遗漏。</p>
<p>也就是说，虽然制作工具已经能够生成代码生成器了，但还是存在 2 大问题：</p>
<ol>
<li>需要人工提前准备动态模板，项目文件越多，使用成本越高</li>
<li>需要根据动态模板编写对应的配置，参数越多，越容易出现和模板不一致的风险</li>
</ol>
<p>如何解决这个问题呢？</p>
<p>答案很简单。我们可以让制作工具根据我们的想法，自动给项目文件“挖坑”，并生成相互对应的动态模板文件和元信息配置。提高效率的同时，减少模型参数和模板不一致的风险。</p>
<p>这就是我们本期教程需要完成的需求。</p>
<p>不过需要明确一点： <strong>制作工具的作用只是提高效率，无法覆盖所有的定制需求！</strong></p>
<p>因为想要如何制作代码生成器，还是取决于开发者。</p>
<h2 data-id="heading-3">二、核心设计</h2>
<p>我们先分析下如何实现上述需求。</p>
<p>经常跟大家提到这么一句话：程序的本质就是帮我们完成原本人工需要进行的操作。</p>
<p>所以想让程序自动制作模板和生成配置，我们就要先想一想：之前我们是怎么完成这些操作的？</p>
<p>在使用制作工具生成前，我们依次做了以下事情：</p>
<ol>
<li>先指定一个原始的、待“挖坑”的输入文件</li>
<li>明确文件中需要被动态替换的内容和模型参数</li>
<li>自己编写 FreeMarker FTL 模板文件</li>
<li>自己编写生成器的元信息配置，包括基本信息、文件配置、模型参数配置</li>
</ol>
<p>分析上面的步骤，第 1 - 2 步都是需要用户自主确认的内容，制作工具无法插手；而有了前两步的信息后，3 - 4 步就可以用制作工具来完成。</p>
<p>由此，我们可以分析出快速制作模板的 <strong>基本公式</strong> ：</p>
<ul>
<li>向制作工具输入：基本信息 + 输入文件 + 模型参数（+ 输出规则）</li>
<li>由制作工具输出：模板文件 + 元信息配置</li>
</ul>
<blockquote>
<p>跟编写算法题目一样，先明确算法的输入和输出，再去设计实现算法</p>
</blockquote>
<p>对应的算法流程图如下：</p>
<p><img src="https://pic.code-nav.cn/post_picture/1610518142000300034/3c2df898-a2ad-493d-bbf8-940dd3f264d4.png" alt="" class="medium-zoom-image"></p>
<p>分别解释一下上述输入参数：</p>
<p>1）基本信息：要制作的代码生成器的基本信息，对应元信息的名称、描述、版本号、作者等信息。</p>
<p>2）输入文件：要“挖坑”的原始文件。可能是一个文件、也可能是多个文件。</p>
<p>3）模型参数：要引导用户输入并填充到模板的模型参数，对应元信息的 modelConfig 模型配置。</p>
<p>4）输出规则：作为一个后续扩展功能的可选参数，比如多次制作时是否覆盖旧的配置等。</p>
<p>输出参数就比较好理解了，在指定目录下生成 FTL 模板文件、以及 <code>meta.json</code> 元信息配置文件。</p>
<p>明确了程序的输入输出后，下面我们就先实现一个最基础的模板制作工具，然后再陆续给工具增加功能。</p>
<blockquote>
<p>小技巧：开发复杂需求或新项目时，先一切从简，完成核心流程的开发。在这个过程中可以记录想法和扩展思路，后面再按需实现。</p>
</blockquote>
<h2 data-id="heading-4">三、基础功能实现</h2>
<p>首先打开制作工具（maker）项目，在 <code>maker</code> 包下新建 <code>template</code> 包，所有和模板制作相关的代码都放到该包下，实现功能隔离。</p>
<blockquote>
<p>目前项目中的 <code>maker.model</code> 目录和 <code>FileGenerator</code> 的 <code>main</code> 方法是多余的，可以删除。</p>
</blockquote>
<h3 data-id="heading-5">1、基本流程实现</h3>
<p>下面我们就以第一阶段准备好的 ACM 示例模板项目为例，来编写模板制作工具的基本流程代码。</p>
<p>预期是以 ACM 示例模板项目为根目录，使用 <code>outputText</code> 模型参数来替换其 <code>src/com/yupi/acm/MainTemplate.java</code> 文件中的 <code>Sum: </code> 输出信息，并在同包下生成 “挖好坑” 的 <code>MainTemplate.java.ftl</code> 模板文件，以及在根目录下生成 <code>meta.json</code> 元信息文件。</p>
<p>实现步骤如下：</p>
<ol>
<li>提供输入参数：包括生成器基本信息、原始项目目录、原始文件、模型参数</li>
<li>基于字符串替换算法，使用模型参数的字段名称来替换原始文件的指定内容，并使用替换后的内容来创建 FTL 动态模板文件</li>
<li>使用输入信息来创建 <code>meta.json</code> 元信息文件</li>
</ol>
<p>在 <code>template</code> 包下新建 <code>TemplateMaker.java</code> 文件，并依次在 main 方法中实现上述步骤。</p>
<p>1）输入信息</p>
<p>要格外注意输入文件的路径（win 系统需要对路径进行转义），代码如下：</p>
<pre style="position: relative; padding-top: 3em; overflow: auto;"><div class="code-block-extension-header" style="position: absolute; top: 0; left: 0; width: 100%; height:28px; font-size:1em; background-color: rgb(248, 248, 248); box-shadow: 0px 4px 5px -6px #888888; display: flex; justify-content: space-between; align-items: center; padding: 0.5em 1em;"><div class="code-block-extension-headerLeft" style="filter: invert(0.5); opacity: 0.6;"><span class="code-block-extension-lang">java</span></div><div class="code-block-extension-headerRight" style="cursor: pointer;"><div class="code-block-extension-copyCodeBtn" style="filter: invert(0.5); opacity: 0.6;">复制代码</div></div></div><code class="language-java hljs" data-highlighted="yes"><span class="hljs-comment">// 一、输入信息</span>
<span class="hljs-comment">// 1. 输入项目基本信息</span>
<span class="hljs-type">String</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> <span class="hljs-string">"acm-template-generator"</span>;
<span class="hljs-type">String</span> <span class="hljs-variable">description</span> <span class="hljs-operator">=</span> <span class="hljs-string">"ACM 示例模板生成器"</span>;

<span class="hljs-comment">// 2. 输入文件信息</span>
<span class="hljs-type">String</span> <span class="hljs-variable">projectPath</span> <span class="hljs-operator">=</span> System.getProperty(<span class="hljs-string">"user.dir"</span>);
<span class="hljs-type">String</span> <span class="hljs-variable">sourceRootPath</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(projectPath).getParent() + File.separator + <span class="hljs-string">"yuzi-generator-demo-projects/acm-template"</span>;
<span class="hljs-comment">// 注意 win 系统需要对路径进行转义</span>
sourceRootPath = sourceRootPath.replaceAll(<span class="hljs-string">"\\\\"</span>, <span class="hljs-string">"/"</span>);

<span class="hljs-type">String</span> <span class="hljs-variable">fileInputPath</span> <span class="hljs-operator">=</span> <span class="hljs-string">"src/com/yupi/acm/MainTemplate.java"</span>;
<span class="hljs-type">String</span> <span class="hljs-variable">fileOutputPath</span> <span class="hljs-operator">=</span> fileInputPath + <span class="hljs-string">".ftl"</span>;

<span class="hljs-comment">// 3. 输入模型参数信息</span>
Meta.ModelConfig.<span class="hljs-type">ModelInfo</span> <span class="hljs-variable">modelInfo</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Meta</span>.ModelConfig.ModelInfo();
modelInfo.setFieldName(<span class="hljs-string">"outputText"</span>);
modelInfo.setType(<span class="hljs-string">"String"</span>);
modelInfo.setDefaultValue(<span class="hljs-string">"sum = "</span>);
</code></pre>
<p>2）使用字符串替换，生成模板文件</p>
<p>代码如下：</p>
<pre style="position: relative; padding-top: 3em; overflow: auto;"><div class="code-block-extension-header" style="position: absolute; top: 0; left: 0; width: 100%; height:28px; font-size:1em; background-color: rgb(248, 248, 248); box-shadow: 0px 4px 5px -6px #888888; display: flex; justify-content: space-between; align-items: center; padding: 0.5em 1em;"><div class="code-block-extension-headerLeft" style="filter: invert(0.5); opacity: 0.6;"><span class="code-block-extension-lang">java</span></div><div class="code-block-extension-headerRight" style="cursor: pointer;"><div class="code-block-extension-copyCodeBtn" style="filter: invert(0.5); opacity: 0.6;">复制代码</div></div></div><code class="language-java hljs" data-highlighted="yes"><span class="hljs-comment">// 二、使用字符串替换，生成模板文件</span>
<span class="hljs-type">String</span> <span class="hljs-variable">fileInputAbsolutePath</span> <span class="hljs-operator">=</span> sourceRootPath + File.separator + fileInputPath;
<span class="hljs-type">String</span> <span class="hljs-variable">fileContent</span> <span class="hljs-operator">=</span> FileUtil.readUtf8String(fileInputAbsolutePath);
<span class="hljs-type">String</span> <span class="hljs-variable">replacement</span> <span class="hljs-operator">=</span> String.format(<span class="hljs-string">"${%s}"</span>, modelInfo.getFieldName());
<span class="hljs-type">String</span> <span class="hljs-variable">newFileContent</span> <span class="hljs-operator">=</span> StrUtil.replace(fileContent, <span class="hljs-string">"Sum: "</span>, replacement);

<span class="hljs-comment">// 输出模板文件</span>
<span class="hljs-type">String</span> <span class="hljs-variable">fileOutputAbsolutePath</span> <span class="hljs-operator">=</span> sourceRootPath + File.separator + fileOutputPath;
FileUtil.writeUtf8String(newFileContent, fileOutputAbsolutePath);
</code></pre>
<p>上述代码中，使用 <code>FileUtil.readUtf8String</code> 快速读取文件内容，使用 <code>StrUtil.replace</code> 快速替换指定的内容，最后使用 <code>FileUtil.writeUtf8String</code> 将替换后的内容快速写入到文件。</p>
<p>3）生成配置文件</p>
<p>思路是先构造 Meta 对象并填充属性，再使用 Hutool 工具库的 <code>JSONUtil.toJsonPrettyStr</code> 方法将对象转为格式化后的 JSON 字符串，最后再写入 <code>meta.json</code> 文件。</p>
<p>代码如下：</p>
<pre style="position: relative; padding-top: 3em; overflow: auto;"><div class="code-block-extension-header" style="position: absolute; top: 0; left: 0; width: 100%; height:28px; font-size:1em; background-color: rgb(248, 248, 248); box-shadow: 0px 4px 5px -6px #888888; display: flex; justify-content: space-between; align-items: center; padding: 0.5em 1em;"><div class="code-block-extension-headerLeft" style="filter: invert(0.5); opacity: 0.6;"><span class="code-block-extension-lang">java</span></div><div class="code-block-extension-headerRight" style="cursor: pointer;"><div class="code-block-extension-copyCodeBtn" style="filter: invert(0.5); opacity: 0.6;">复制代码</div></div></div><code class="language-java hljs" data-highlighted="yes"><span class="hljs-comment">// 三、生成配置文件</span>
<span class="hljs-type">String</span> <span class="hljs-variable">metaOutputPath</span> <span class="hljs-operator">=</span> sourceRootPath + File.separator + <span class="hljs-string">"meta.json"</span>;

<span class="hljs-comment">// 1. 构造配置参数</span>
<span class="hljs-type">Meta</span> <span class="hljs-variable">meta</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Meta</span>();
meta.setName(name);
meta.setDescription(description);

Meta.<span class="hljs-type">FileConfig</span> <span class="hljs-variable">fileConfig</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Meta</span>.FileConfig();
meta.setFileConfig(fileConfig);
fileConfig.setSourceRootPath(sourceRootPath);
List&lt;Meta.FileConfig.FileInfo&gt; fileInfoList = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();
fileConfig.setFiles(fileInfoList);
Meta.FileConfig.<span class="hljs-type">FileInfo</span> <span class="hljs-variable">fileInfo</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Meta</span>.FileConfig.FileInfo();
fileInfo.setInputPath(fileInputPath);
fileInfo.setOutputPath(fileOutputPath);
fileInfo.setType(FileTypeEnum.FILE.getValue());
fileInfo.setGenerateType(FileGenerateTypeEnum.DYNAMIC.getValue());
fileInfoList.add(fileInfo);

Meta.<span class="hljs-type">ModelConfig</span> <span class="hljs-variable">modelConfig</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Meta</span>.ModelConfig();
meta.setModelConfig(modelConfig);
List&lt;Meta.ModelConfig.ModelInfo&gt; modelInfoList = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();
modelConfig.setModels(modelInfoList);
modelInfoList.add(modelInfo);

<span class="hljs-comment">// 2. 输出元信息文件</span>
FileUtil.writeUtf8String(JSONUtil.toJsonPrettyStr(meta), metaOutputPath);
</code></pre>
<p>组合以上几个步骤的代码，完整代码如下：</p>
<pre style="position: relative; padding-top: 3em; overflow: auto;"><div class="code-block-extension-header" style="position: absolute; top: 0; left: 0; width: 100%; height:28px; font-size:1em; background-color: rgb(248, 248, 248); box-shadow: 0px 4px 5px -6px #888888; display: flex; justify-content: space-between; align-items: center; padding: 0.5em 1em;"><div class="code-block-extension-headerLeft" style="filter: invert(0.5); opacity: 0.6;"><span class="code-block-extension-lang">java</span></div><div class="code-block-extension-headerRight" style="cursor: pointer;"><div class="code-block-extension-copyCodeBtn" style="filter: invert(0.5); opacity: 0.6;">复制代码</div></div></div><code class="language-java hljs" data-highlighted="yes"><span class="hljs-keyword">package</span> com.yupi.maker.template;

<span class="hljs-keyword">import</span> cn.hutool.core.io.FileUtil;
<span class="hljs-keyword">import</span> cn.hutool.core.util.StrUtil;
<span class="hljs-keyword">import</span> cn.hutool.json.JSONUtil;
<span class="hljs-keyword">import</span> com.yupi.maker.meta.Meta;
<span class="hljs-keyword">import</span> com.yupi.maker.meta.enums.FileGenerateTypeEnum;
<span class="hljs-keyword">import</span> com.yupi.maker.meta.enums.FileTypeEnum;

<span class="hljs-keyword">import</span> java.io.File;
<span class="hljs-keyword">import</span> java.util.ArrayList;
<span class="hljs-keyword">import</span> java.util.List;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TemplateMaker</span> {

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-comment">// 一、输入信息</span>
        <span class="hljs-comment">// 1. 输入项目基本信息</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> <span class="hljs-string">"acm-template-generator"</span>;
        <span class="hljs-type">String</span> <span class="hljs-variable">description</span> <span class="hljs-operator">=</span> <span class="hljs-string">"ACM 示例模板生成器"</span>;

        <span class="hljs-comment">// 2. 输入文件信息</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">projectPath</span> <span class="hljs-operator">=</span> System.getProperty(<span class="hljs-string">"user.dir"</span>);
        <span class="hljs-type">String</span> <span class="hljs-variable">sourceRootPath</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(projectPath).getParent() + File.separator + <span class="hljs-string">"yuzi-generator-demo-projects/acm-template"</span>;
        <span class="hljs-comment">// 注意 win 系统需要对路径进行转义</span>
		sourceRootPath = sourceRootPath.replaceAll(<span class="hljs-string">"\\\\"</span>, <span class="hljs-string">"/"</span>);
        
        <span class="hljs-type">String</span> <span class="hljs-variable">fileInputPath</span> <span class="hljs-operator">=</span> <span class="hljs-string">"src/com/yupi/acm/MainTemplate.java"</span>;
        <span class="hljs-type">String</span> <span class="hljs-variable">fileOutputPath</span> <span class="hljs-operator">=</span> fileInputPath + <span class="hljs-string">".ftl"</span>;

        <span class="hljs-comment">// 3. 输入模型参数信息</span>
        Meta.ModelConfig.<span class="hljs-type">ModelInfo</span> <span class="hljs-variable">modelInfo</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Meta</span>.ModelConfig.ModelInfo();
        modelInfo.setFieldName(<span class="hljs-string">"outputText"</span>);
        modelInfo.setType(<span class="hljs-string">"String"</span>);
        modelInfo.setDefaultValue(<span class="hljs-string">"sum = "</span>);

        <span class="hljs-comment">// 二、使用字符串替换，生成模板文件</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">fileInputAbsolutePath</span> <span class="hljs-operator">=</span> sourceRootPath + File.separator + fileInputPath;
        <span class="hljs-type">String</span> <span class="hljs-variable">fileContent</span> <span class="hljs-operator">=</span> FileUtil.readUtf8String(fileInputAbsolutePath);
        <span class="hljs-type">String</span> <span class="hljs-variable">replacement</span> <span class="hljs-operator">=</span> String.format(<span class="hljs-string">"${%s}"</span>, modelInfo.getFieldName());
        <span class="hljs-type">String</span> <span class="hljs-variable">newFileContent</span> <span class="hljs-operator">=</span> StrUtil.replace(fileContent, <span class="hljs-string">"Sum: "</span>, replacement);

        <span class="hljs-comment">// 输出模板文件</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">fileOutputAbsolutePath</span> <span class="hljs-operator">=</span> sourceRootPath + File.separator + fileOutputPath;
        FileUtil.writeUtf8String(newFileContent, fileOutputAbsolutePath);

        <span class="hljs-comment">// 三、生成配置文件</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">metaOutputPath</span> <span class="hljs-operator">=</span> sourceRootPath + File.separator + <span class="hljs-string">"meta.json"</span>;

        <span class="hljs-comment">// 1. 构造配置参数</span>
        <span class="hljs-type">Meta</span> <span class="hljs-variable">meta</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Meta</span>();
        meta.setName(name);
        meta.setDescription(description);

        Meta.<span class="hljs-type">FileConfig</span> <span class="hljs-variable">fileConfig</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Meta</span>.FileConfig();
        meta.setFileConfig(fileConfig);
        fileConfig.setSourceRootPath(sourceRootPath);
        List&lt;Meta.FileConfig.FileInfo&gt; fileInfoList = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();
        fileConfig.setFiles(fileInfoList);
        Meta.FileConfig.<span class="hljs-type">FileInfo</span> <span class="hljs-variable">fileInfo</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Meta</span>.FileConfig.FileInfo();
        fileInfo.setInputPath(fileInputPath);
        fileInfo.setOutputPath(fileOutputPath);
        fileInfo.setType(FileTypeEnum.FILE.getValue());
        fileInfo.setGenerateType(FileGenerateTypeEnum.DYNAMIC.getValue());
        fileInfoList.add(fileInfo);

        Meta.<span class="hljs-type">ModelConfig</span> <span class="hljs-variable">modelConfig</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Meta</span>.ModelConfig();
        meta.setModelConfig(modelConfig);
        List&lt;Meta.ModelConfig.ModelInfo&gt; modelInfoList = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();
        modelConfig.setModels(modelInfoList);
        modelInfoList.add(modelInfo);

        <span class="hljs-comment">// 2. 输出元信息文件</span>
        FileUtil.writeUtf8String(JSONUtil.toJsonPrettyStr(meta), metaOutputPath);
    }
}
</code></pre>
<p>运行 main 方法，测试执行，成功生成了需要的模板和元信息文件：</p>
<p><img src="https://pic.code-nav.cn/post_picture/1610518142000300034/268fc2f2-8bcb-44a0-9c2a-1ebac0cd7f45.png" alt="image.png" class="medium-zoom-image"></p>
<p>虽然制作模板的流程是跑通了，但我们会发现一个问题：上述代码直接在原始项目内生成了模板和元信息配置，其实是对原项目的污染。如果我们想重新生成，就得一个个删除上次生成的文件。</p>
<h3 data-id="heading-6">2、工作空间隔离</h3>
<p>想解决上面的问题，其实很简单。每次制作模板时，我们都不直接修改原始项目的任何文件，而是先复制原项目到一个临时的、专门用于制作模板的目录，然后在该目录下完成文件的生成和处理。</p>
<p>可以将上述临时目录称为 <code>工作空间</code>，每次模板制作应该属于不同的工作空间，互不影响。</p>
<p>我们约定将 <code>maker</code> 项目下的 <code>.temp</code> 临时目录作为工作空间的根目录，并且在项目的 <code>.gitignore</code> 文件中忽略该目录。</p>
<p>在 <code>TemplateMaker</code> 原有代码的基础上新增复制目录的逻辑：</p>
<ol>
<li>需要用户传入 <code>originProjectPath</code> 变量代表原始项目路径</li>
<li>每次制作分配一个唯一 id（使用雪花算法），作为工作空间的名称，从而实现隔离</li>
<li>通过 <code>FileUtil.copy</code> 复制目录</li>
<li>修改变量 <code>sourceRootPath</code> 的值为复制后的工作空间内的项目根目录</li>
</ol>
<p>对应修改的代码如下：</p>
<pre style="position: relative; padding-top: 3em; overflow: auto;"><div class="code-block-extension-header" style="position: absolute; top: 0; left: 0; width: 100%; height:28px; font-size:1em; background-color: rgb(248, 248, 248); box-shadow: 0px 4px 5px -6px #888888; display: flex; justify-content: space-between; align-items: center; padding: 0.5em 1em;"><div class="code-block-extension-headerLeft" style="filter: invert(0.5); opacity: 0.6;"><span class="code-block-extension-lang">java</span></div><div class="code-block-extension-headerRight" style="cursor: pointer;"><div class="code-block-extension-copyCodeBtn" style="filter: invert(0.5); opacity: 0.6;">复制代码</div></div></div><code class="language-java hljs" data-highlighted="yes"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
    <span class="hljs-comment">// 指定原始项目路径</span>
    <span class="hljs-type">String</span> <span class="hljs-variable">projectPath</span> <span class="hljs-operator">=</span> System.getProperty(<span class="hljs-string">"user.dir"</span>);
    <span class="hljs-type">String</span> <span class="hljs-variable">originProjectPath</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(projectPath).getParent() + File.separator + <span class="hljs-string">"yuzi-generator-demo-projects/acm-template"</span>;

    <span class="hljs-comment">// 复制目录</span>
    <span class="hljs-type">long</span> <span class="hljs-variable">id</span> <span class="hljs-operator">=</span> IdUtil.getSnowflakeNextId();
    <span class="hljs-type">String</span> <span class="hljs-variable">tempDirPath</span> <span class="hljs-operator">=</span> projectPath + File.separator + <span class="hljs-string">".temp"</span>;
    <span class="hljs-type">String</span> <span class="hljs-variable">templatePath</span> <span class="hljs-operator">=</span> tempDirPath + File.separator + id;
    <span class="hljs-keyword">if</span> (!FileUtil.exist(templatePath)) {
        FileUtil.mkdir(templatePath);
    }
    FileUtil.copy(originProjectPath, templatePath, <span class="hljs-literal">true</span>);

    <span class="hljs-comment">// 一、输入信息</span>
    <span class="hljs-comment">// 1. 输入项目基本信息</span>
    <span class="hljs-type">String</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> <span class="hljs-string">"acm-template-generator"</span>;
    <span class="hljs-type">String</span> <span class="hljs-variable">description</span> <span class="hljs-operator">=</span> <span class="hljs-string">"ACM 示例模板生成器"</span>;

    <span class="hljs-comment">// 2. 输入文件信息</span>
    <span class="hljs-type">String</span> <span class="hljs-variable">sourceRootPath</span> <span class="hljs-operator">=</span> templatePath + File.separator + FileUtil.getLastPathEle(Paths.get(originProjectPath)).toString();
    <span class="hljs-type">String</span> <span class="hljs-variable">fileInputPath</span> <span class="hljs-operator">=</span> <span class="hljs-string">"src/com/yupi/acm/MainTemplate.java"</span>;
    <span class="hljs-type">String</span> <span class="hljs-variable">fileOutputPath</span> <span class="hljs-operator">=</span> fileInputPath + <span class="hljs-string">".ftl"</span>;

    ...
}
</code></pre>
<p>再次测试执行，可以看到 maker 项目下新建了一个工作空间，并且生成了模板和元信息配置文件，如下图：</p>
<p><img src="https://pic.code-nav.cn/post_picture/1610518142000300034/fe77a6d5-c747-495a-8b8a-2ec45adcaf8b.png" alt="image.png" class="medium-zoom-image"></p>
<h3 data-id="heading-7">3、分步制作能力</h3>
<p>一般来说，我们在制作模板时，不可能只 “挖一个坑”，只允许用户自定义输入一个参数；也不可能一次性 “挖完所有坑”。而是一步一步地替换参数、制作模板。</p>
<p>所以，我们的制作工具要有分步制作、追加配置的能力，具体要做到以下 3 点：</p>
<ol>
<li>输入过一次的信息，不用重复输入，比如基本的项目信息</li>
<li>后续制作时，不用再次复制原始项目；而是可以在原有文件的基础上，多次追加或覆盖新的文件</li>
<li>后续制作时，可以在原有配置的基础上，多次追加或覆盖配置</li>
</ol>
<p>想要实现这个能力，我们首先要让制作工具 “有状态”。</p>
<h4 data-id="heading-8">有状态和无状态</h4>
<p>什么是有状态？</p>
<p>是指程序或请求多次执行时，下一次执行保留对上一次执行的记忆。比如用户登录后服务器会记住用户的信息，下一次请求就能正常使用系统。</p>
<p>与之相对的是无状态。是指每次程序或请求执行，都像是第一次执行一样，没有任何历史信息。很多 Restful API 会采用无状态的设计，能够节省服务器的资源占用。</p>
<h4 data-id="heading-9">有状态实现</h4>
<p>想实现有状态，往往需要 2 个要素：唯一标识和存储。</p>
<p>其实在上一步 “工作空间隔离” 中，我们已经给每个工作空间分配了一个唯一的 id 作为标识；并且将 id 作为工作空间的目录名称，相当于使用本地文件系统作为了 id 的存储。</p>
<p>那么我们只要在第一次制作时，生成唯一的 id；然后在后续制作时，使用相同的 id，就能找到之前的工作空间目录，从而追加文件或配置。</p>
<p>修改 <code>TemplateMaker</code> 文件，新建 <code>makeTemplate</code> 方法，并将 id 作为参数，先实现 id 的生成逻辑。</p>
<p>代码如下：</p>
<pre style="position: relative; padding-top: 3em; overflow: auto;"><div class="code-block-extension-header" style="position: absolute; top: 0; left: 0; width: 100%; height:28px; font-size:1em; background-color: rgb(248, 248, 248); box-shadow: 0px 4px 5px -6px #888888; display: flex; justify-content: space-between; align-items: center; padding: 0.5em 1em;"><div class="code-block-extension-headerLeft" style="filter: invert(0.5); opacity: 0.6;"><span class="code-block-extension-lang">java</span></div><div class="code-block-extension-headerRight" style="cursor: pointer;"><div class="code-block-extension-copyCodeBtn" style="filter: invert(0.5); opacity: 0.6;">复制代码</div></div></div><code class="language-java hljs" data-highlighted="yes"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-type">long</span> <span class="hljs-title function_">makeTemplate</span><span class="hljs-params">(Long id)</span> {
    <span class="hljs-comment">// 没有 id 则生成</span>
    <span class="hljs-keyword">if</span> (id == <span class="hljs-literal">null</span>) {
        id = IdUtil.getSnowflakeNextId();
    }
    
    <span class="hljs-comment">// 业务逻辑...</span>
    
    <span class="hljs-keyword">return</span> id;
}
</code></pre>
<h4 data-id="heading-10">多次制作实现</h4>
<p>如果根据 id 判断出并非首次制作，我们又应该做哪些调整呢？应该如何追加配置和文件呢？</p>
<p>这里我考虑到 3 点：</p>
<ol>
<li>非首次制作，不需要复制原始项目文件</li>
<li>非首次制作，可以在已有模板的基础上再次挖坑</li>
<li>非首次制作，不需要重复输入已有元信息，而是在此基础上覆盖和追加元信息配置</li>
</ol>
<p>下面分别实现这几点。</p>
<p>1）非首次制作，不需要复制原始项目文件</p>
<p>之前的 <code>TemplateMaker</code> 代码已经判断了某 id 对应的工作空间目录是否存在，现在只需要把复制原始项目文件的逻辑移到 “首次制作” 的 if 条件中即可。</p>
<p>修改后的代码如下：</p>
<pre style="position: relative; padding-top: 3em; overflow: auto;"><div class="code-block-extension-header" style="position: absolute; top: 0; left: 0; width: 100%; height:28px; font-size:1em; background-color: rgb(248, 248, 248); box-shadow: 0px 4px 5px -6px #888888; display: flex; justify-content: space-between; align-items: center; padding: 0.5em 1em;"><div class="code-block-extension-headerLeft" style="filter: invert(0.5); opacity: 0.6;"><span class="code-block-extension-lang">java</span></div><div class="code-block-extension-headerRight" style="cursor: pointer;"><div class="code-block-extension-copyCodeBtn" style="filter: invert(0.5); opacity: 0.6;">复制代码</div></div></div><code class="language-java hljs" data-highlighted="yes"><span class="hljs-comment">// 复制目录</span>
<span class="hljs-type">long</span> <span class="hljs-variable">id</span> <span class="hljs-operator">=</span> IdUtil.getSnowflakeNextId();
<span class="hljs-type">String</span> <span class="hljs-variable">tempDirPath</span> <span class="hljs-operator">=</span> projectPath + File.separator + <span class="hljs-string">".temp"</span>;
<span class="hljs-type">String</span> <span class="hljs-variable">templatePath</span> <span class="hljs-operator">=</span> tempDirPath + File.separator + id;

<span class="hljs-comment">// 是否为首次制作模板</span>
<span class="hljs-comment">// 目录不存在，则是首次制作</span>
<span class="hljs-keyword">if</span> (!FileUtil.exist(templatePath)) {
    FileUtil.mkdir(templatePath);
    FileUtil.copy(originProjectPath, templatePath, <span class="hljs-literal">true</span>);
}
</code></pre>
<p>2）非首次制作，可以在已有模板的基础上再次挖坑</p>
<p>由于制作好的模板文件名称就是在原始文件名称后增加 <code>.ftl</code> 后缀，所以我们可以将输出文件路径（包含 <code>.ftl</code> 后缀的路径）作为文件是否重复的判断条件。如果已有 <code>.ftl</code> 文件，表示不是第一次制作，可以在这个模板文件的基础上再去替换内容。</p>
<p>修改后的代码如下：</p>
<pre style="position: relative; padding-top: 3em; overflow: auto;"><div class="code-block-extension-header" style="position: absolute; top: 0; left: 0; width: 100%; height:28px; font-size:1em; background-color: rgb(248, 248, 248); box-shadow: 0px 4px 5px -6px #888888; display: flex; justify-content: space-between; align-items: center; padding: 0.5em 1em;"><div class="code-block-extension-headerLeft" style="filter: invert(0.5); opacity: 0.6;"><span class="code-block-extension-lang">java</span></div><div class="code-block-extension-headerRight" style="cursor: pointer;"><div class="code-block-extension-copyCodeBtn" style="filter: invert(0.5); opacity: 0.6;">复制代码</div></div></div><code class="language-java hljs" data-highlighted="yes"><span class="hljs-comment">// 二、使用字符串替换，生成模板文件</span>
<span class="hljs-type">String</span> <span class="hljs-variable">fileInputAbsolutePath</span> <span class="hljs-operator">=</span> sourceRootPath + File.separator + fileInputPath;
<span class="hljs-type">String</span> <span class="hljs-variable">fileOutputAbsolutePath</span> <span class="hljs-operator">=</span> sourceRootPath + File.separator + fileOutputPath;

<span class="hljs-type">String</span> <span class="hljs-variable">fileContent</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;
<span class="hljs-comment">// 如果已有模板文件，说明不是第一次制作，则在模板基础上再次挖坑</span>
<span class="hljs-keyword">if</span> (FileUtil.exist(fileOutputAbsolutePath)) {
    fileContent = FileUtil.readUtf8String(fileOutputAbsolutePath);
} <span class="hljs-keyword">else</span> {
    fileContent = FileUtil.readUtf8String(fileInputAbsolutePath);
}
<span class="hljs-type">String</span> <span class="hljs-variable">replacement</span> <span class="hljs-operator">=</span> String.format(<span class="hljs-string">"${%s}"</span>, modelInfo.getFieldName());
<span class="hljs-type">String</span> <span class="hljs-variable">newFileContent</span> <span class="hljs-operator">=</span> StrUtil.replace(fileContent, <span class="hljs-string">"Sum: "</span>, replacement);

<span class="hljs-comment">// 输出模板文件</span>
FileUtil.writeUtf8String(newFileContent, fileOutputAbsolutePath);
</code></pre>
<p>3）非首次制作，不需要重复输入已有元信息，而是在此基础上覆盖和追加元信息配置。</p>
<p>和判断文件模板是否重复的逻辑一致，我们可以通过是否已存在 <code>meta.json</code> 配置文件来判断应该新增还是修改配置。</p>
<p>修改后的代码如下：</p>
<blockquote>
<p>我们将 fileInfo 对象的构造移到了前面，使得无论是新增还是修改元信息都能使用该对象</p>
</blockquote>
<pre style="position: relative; padding-top: 3em; overflow: auto;"><div class="code-block-extension-header" style="position: absolute; top: 0; left: 0; width: 100%; height:28px; font-size:1em; background-color: rgb(248, 248, 248); box-shadow: 0px 4px 5px -6px #888888; display: flex; justify-content: space-between; align-items: center; padding: 0.5em 1em;"><div class="code-block-extension-headerLeft" style="filter: invert(0.5); opacity: 0.6;"><span class="code-block-extension-lang">java</span></div><div class="code-block-extension-headerRight" style="cursor: pointer;"><div class="code-block-extension-copyCodeBtn" style="filter: invert(0.5); opacity: 0.6;">复制代码</div></div></div><code class="language-java hljs" data-highlighted="yes"><span class="hljs-comment">// 文件配置信息</span>
Meta.FileConfig.<span class="hljs-type">FileInfo</span> <span class="hljs-variable">fileInfo</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Meta</span>.FileConfig.FileInfo();
fileInfo.setInputPath(fileInputPath);
fileInfo.setOutputPath(fileOutputPath);
fileInfo.setType(FileTypeEnum.FILE.getValue());
fileInfo.setGenerateType(FileGenerateTypeEnum.DYNAMIC.getValue());

<span class="hljs-comment">// 三、生成配置文件</span>
<span class="hljs-type">String</span> <span class="hljs-variable">metaOutputPath</span> <span class="hljs-operator">=</span> sourceRootPath + File.separator + <span class="hljs-string">"meta.json"</span>;

<span class="hljs-comment">// 如果已有 meta 文件，说明不是第一次制作，则在 meta 基础上进行修改</span>
<span class="hljs-keyword">if</span> (FileUtil.exist(metaOutputPath)) {
    <span class="hljs-type">Meta</span> <span class="hljs-variable">oldMeta</span> <span class="hljs-operator">=</span> JSONUtil.toBean(FileUtil.readUtf8String(metaOutputPath), Meta.class);
    <span class="hljs-comment">// 1. 追加配置参数</span>
    List&lt;Meta.FileConfig.FileInfo&gt; fileInfoList = oldMeta.getFileConfig().getFiles();
    fileInfoList.add(fileInfo);
    List&lt;Meta.ModelConfig.ModelInfo&gt; modelInfoList = oldMeta.getModelConfig().getModels();
    modelInfoList.add(modelInfo);

    <span class="hljs-comment">// 2.更新元信息文件</span>
    FileUtil.writeUtf8String(JSONUtil.toJsonPrettyStr(oldMeta), metaOutputPath);
} <span class="hljs-keyword">else</span> {
    <span class="hljs-comment">// 1. 构造配置参数</span>
    <span class="hljs-type">Meta</span> <span class="hljs-variable">meta</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Meta</span>();
    meta.setName(name);
    meta.setDescription(description);

    Meta.<span class="hljs-type">FileConfig</span> <span class="hljs-variable">fileConfig</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Meta</span>.FileConfig();
    meta.setFileConfig(fileConfig);
    fileConfig.setSourceRootPath(sourceRootPath);
    List&lt;Meta.FileConfig.FileInfo&gt; fileInfoList = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();
    fileConfig.setFiles(fileInfoList);
    fileInfoList.add(fileInfo);

    Meta.<span class="hljs-type">ModelConfig</span> <span class="hljs-variable">modelConfig</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Meta</span>.ModelConfig();
    meta.setModelConfig(modelConfig);
    List&lt;Meta.ModelConfig.ModelInfo&gt; modelInfoList = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();
    modelConfig.setModels(modelInfoList);
    modelInfoList.add(modelInfo);

    <span class="hljs-comment">// 2. 输出元信息文件</span>
    FileUtil.writeUtf8String(JSONUtil.toJsonPrettyStr(meta), metaOutputPath);
}
</code></pre>
<p>一定要注意，追加完配置后，需要去重！否则可能出现多个一模一样的模型参数或文件信息。</p>
<p>文件信息根据输入路径 <code>inputPath</code> 去重，使用新值覆盖旧值。代码如下：</p>
<pre style="position: relative; padding-top: 3em; overflow: auto;"><div class="code-block-extension-header" style="position: absolute; top: 0; left: 0; width: 100%; height:28px; font-size:1em; background-color: rgb(248, 248, 248); box-shadow: 0px 4px 5px -6px #888888; display: flex; justify-content: space-between; align-items: center; padding: 0.5em 1em;"><div class="code-block-extension-headerLeft" style="filter: invert(0.5); opacity: 0.6;"><span class="code-block-extension-lang">java</span></div><div class="code-block-extension-headerRight" style="cursor: pointer;"><div class="code-block-extension-copyCodeBtn" style="filter: invert(0.5); opacity: 0.6;">复制代码</div></div></div><code class="language-java hljs" data-highlighted="yes"><span class="hljs-comment">/**
 * 文件去重
 *
 * <span class="hljs-doctag">@param</span> fileInfoList
 * <span class="hljs-doctag">@return</span>
 */</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> List&lt;Meta.FileConfig.FileInfo&gt; distinctFiles(List&lt;Meta.FileConfig.FileInfo&gt; fileInfoList) {
    List&lt;Meta.FileConfig.FileInfo&gt; newFileInfoList = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;(
            fileInfoList.stream()
                    .collect(
                            Collectors.toMap(Meta.FileConfig.FileInfo::getInputPath, o -&gt; o, (e, r) -&gt; r)
                    ).values()
    );
    <span class="hljs-keyword">return</span> newFileInfoList;
}
</code></pre>
<p>上述代码中，用到了 Java 8 的 Stream API 和 Lambda 表达式来简化代码，其中 <code>Collectors.toMap</code> 表示将列表转换为 Map，详细解释一下：</p>
<ul>
<li>通过第一个参数（inputPath）作为 key 进行分组</li>
<li>通过第二个参数作为 value 存储值（<code>o -&gt; o</code> 表示使用原对象作为 value）</li>
<li>最后的 <code>(e, r) -&gt; r</code> 其实是 <code>(exist, replacement) -&gt; replacement</code> 的缩写，表示遇到重复的值是保留新值，返回 exist 表示保留旧值。</li>
</ul>
<p>这样一来，相同 key 对应的文件信息只会保留一个，最后再取所有的 values 拿到所有的文件信息列表即可。</p>
<p>模型参数根据属性名称 <code>fieldName</code> 去重，使用新值覆盖旧值。和文件信息去重的实现方式完全一致，代码如下：</p>
<pre style="position: relative; padding-top: 3em; overflow: auto;"><div class="code-block-extension-header" style="position: absolute; top: 0; left: 0; width: 100%; height:28px; font-size:1em; background-color: rgb(248, 248, 248); box-shadow: 0px 4px 5px -6px #888888; display: flex; justify-content: space-between; align-items: center; padding: 0.5em 1em;"><div class="code-block-extension-headerLeft" style="filter: invert(0.5); opacity: 0.6;"><span class="code-block-extension-lang">java</span></div><div class="code-block-extension-headerRight" style="cursor: pointer;"><div class="code-block-extension-copyCodeBtn" style="filter: invert(0.5); opacity: 0.6;">复制代码</div></div></div><code class="language-java hljs" data-highlighted="yes"><span class="hljs-comment">/**
 * 模型去重
 *
 * <span class="hljs-doctag">@param</span> modelInfoList
 * <span class="hljs-doctag">@return</span>
 */</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> List&lt;Meta.ModelConfig.ModelInfo&gt; distinctModels(List&lt;Meta.ModelConfig.ModelInfo&gt; modelInfoList) {
    List&lt;Meta.ModelConfig.ModelInfo&gt; newModelInfoList = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;(
            modelInfoList.stream()
                    .collect(
                            Collectors.toMap(Meta.ModelConfig.ModelInfo::getFieldName, o -&gt; o, (e, r) -&gt; r)
                    ).values()
    );
    <span class="hljs-keyword">return</span> newModelInfoList;
}
</code></pre>
<p>然后修改生成配置文件的代码，使用去重方法，并将去重后的配置更新到元信息中：</p>
<pre style="position: relative; padding-top: 3em; overflow: auto;"><div class="code-block-extension-header" style="position: absolute; top: 0; left: 0; width: 100%; height:28px; font-size:1em; background-color: rgb(248, 248, 248); box-shadow: 0px 4px 5px -6px #888888; display: flex; justify-content: space-between; align-items: center; padding: 0.5em 1em;"><div class="code-block-extension-headerLeft" style="filter: invert(0.5); opacity: 0.6;"><span class="code-block-extension-lang">java</span></div><div class="code-block-extension-headerRight" style="cursor: pointer;"><div class="code-block-extension-copyCodeBtn" style="filter: invert(0.5); opacity: 0.6;">复制代码</div></div></div><code class="language-java hljs" data-highlighted="yes"><span class="hljs-comment">// 如果已有 meta 文件，说明不是第一次制作，则在 meta 基础上进行修改</span>
<span class="hljs-keyword">if</span> (FileUtil.exist(metaOutputPath)) {
    <span class="hljs-type">Meta</span> <span class="hljs-variable">oldMeta</span> <span class="hljs-operator">=</span> JSONUtil.toBean(FileUtil.readUtf8String(metaOutputPath), Meta.class);
    <span class="hljs-comment">// 1. 追加配置参数</span>
    List&lt;Meta.FileConfig.FileInfo&gt; fileInfoList = oldMeta.getFileConfig().getFiles();
    fileInfoList.add(fileInfo);
    List&lt;Meta.ModelConfig.ModelInfo&gt; modelInfoList = oldMeta.getModelConfig().getModels();
    modelInfoList.add(modelInfo);

    <span class="hljs-comment">// 配置去重</span>
    oldMeta.getFileConfig().setFiles(distinctFiles(fileInfoList));
    oldMeta.getModelConfig().setModels(distinctModels(modelInfoList));

    <span class="hljs-comment">// 2.更新元信息文件</span>
    FileUtil.writeUtf8String(JSONUtil.toJsonPrettyStr(oldMeta), metaOutputPath);
}
</code></pre>
<h4 data-id="heading-11">抽象方法</h4>
<p>由于我们在接下来的测试中，要多次传入不同的参数执行制作，所以可以先抽象出通用的方法，将所有之前我们在 main 方法中硬编码的值都作为方法的参数。包括 originProjectPath（原始项目路径）、inputFilePath（要制作模板的输入文件相对路径）、modelInfo（模型信息）、searchStr（要替换的模板内容）等。</p>
<p>我们还要把所有基本信息配置直接用 Meta 类封装，可以节约方法的参数个数，比如：</p>
<pre style="position: relative; padding-top: 3em; overflow: auto;"><div class="code-block-extension-header" style="position: absolute; top: 0; left: 0; width: 100%; height:28px; font-size:1em; background-color: rgb(248, 248, 248); box-shadow: 0px 4px 5px -6px #888888; display: flex; justify-content: space-between; align-items: center; padding: 0.5em 1em;"><div class="code-block-extension-headerLeft" style="filter: invert(0.5); opacity: 0.6;"><span class="code-block-extension-lang">java</span></div><div class="code-block-extension-headerRight" style="cursor: pointer;"><div class="code-block-extension-copyCodeBtn" style="filter: invert(0.5); opacity: 0.6;">复制代码</div></div></div><code class="language-java hljs" data-highlighted="yes"><span class="hljs-type">String</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> <span class="hljs-string">"acm-template-generator"</span>;
<span class="hljs-type">String</span> <span class="hljs-variable">description</span> <span class="hljs-operator">=</span> <span class="hljs-string">"ACM 示例模板生成器"</span>;
</code></pre>
<p>改为：</p>
<pre style="position: relative; padding-top: 3em; overflow: auto;"><div class="code-block-extension-header" style="position: absolute; top: 0; left: 0; width: 100%; height:28px; font-size:1em; background-color: rgb(248, 248, 248); box-shadow: 0px 4px 5px -6px #888888; display: flex; justify-content: space-between; align-items: center; padding: 0.5em 1em;"><div class="code-block-extension-headerLeft" style="filter: invert(0.5); opacity: 0.6;"><span class="code-block-extension-lang">java</span></div><div class="code-block-extension-headerRight" style="cursor: pointer;"><div class="code-block-extension-copyCodeBtn" style="filter: invert(0.5); opacity: 0.6;">复制代码</div></div></div><code class="language-java hljs" data-highlighted="yes"><span class="hljs-type">Meta</span> <span class="hljs-variable">meta</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Meta</span>();
meta.setName(<span class="hljs-string">"acm-template-generator"</span>);
meta.setDescription(<span class="hljs-string">"ACM 示例模板生成器"</span>);
</code></pre>
<p>如果非首次制作，我们还要能使用最后传入的 meta 对象更新元信息的基本配置。可以通过 <code>BeanUtil.copyProperties</code> 复制新对象的属性到老对象（如果属性为空则不复制），从而实现新老 meta 对象的合并。</p>
<p>代码如下：</p>
<pre style="position: relative; padding-top: 3em; overflow: auto;"><div class="code-block-extension-header" style="position: absolute; top: 0; left: 0; width: 100%; height:28px; font-size:1em; background-color: rgb(248, 248, 248); box-shadow: 0px 4px 5px -6px #888888; display: flex; justify-content: space-between; align-items: center; padding: 0.5em 1em;"><div class="code-block-extension-headerLeft" style="filter: invert(0.5); opacity: 0.6;"><span class="code-block-extension-lang">java</span></div><div class="code-block-extension-headerRight" style="cursor: pointer;"><div class="code-block-extension-copyCodeBtn" style="filter: invert(0.5); opacity: 0.6;">复制代码</div></div></div><code class="language-java hljs" data-highlighted="yes"><span class="hljs-type">Meta</span> <span class="hljs-variable">oldMeta</span> <span class="hljs-operator">=</span> JSONUtil.toBean(FileUtil.readUtf8String(metaOutputPath), Meta.class);
BeanUtil.copyProperties(meta, oldMeta, CopyOptions.create().ignoreNullValue());
</code></pre>
<p>抽象方法后的完整代码如下：</p>
<pre style="position: relative; padding-top: 3em; overflow: auto;"><div class="code-block-extension-header" style="position: absolute; top: 0; left: 0; width: 100%; height:28px; font-size:1em; background-color: rgb(248, 248, 248); box-shadow: 0px 4px 5px -6px #888888; display: flex; justify-content: space-between; align-items: center; padding: 0.5em 1em;"><div class="code-block-extension-headerLeft" style="filter: invert(0.5); opacity: 0.6;"><span class="code-block-extension-lang">java</span></div><div class="code-block-extension-headerRight" style="cursor: pointer;"><div class="code-block-extension-copyCodeBtn" style="filter: invert(0.5); opacity: 0.6;">复制代码</div></div></div><code class="language-java hljs" data-highlighted="yes"><span class="hljs-comment">/**
 * 制作模板
 *
 * <span class="hljs-doctag">@param</span> newMeta
 * <span class="hljs-doctag">@param</span> originProjectPath
 * <span class="hljs-doctag">@param</span> inputFilePath
 * <span class="hljs-doctag">@param</span> modelInfo
 * <span class="hljs-doctag">@param</span> searchStr
 * <span class="hljs-doctag">@param</span> id
 * <span class="hljs-doctag">@return</span>
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">long</span> <span class="hljs-title function_">makeTemplate</span><span class="hljs-params">(Meta newMeta, String originProjectPath, String inputFilePath, Meta.ModelConfig.ModelInfo modelInfo, String searchStr, Long id)</span> {
    <span class="hljs-comment">// 没有 id 则生成</span>
    <span class="hljs-keyword">if</span> (id == <span class="hljs-literal">null</span>) {
        id = IdUtil.getSnowflakeNextId();
    }

    <span class="hljs-comment">// 复制目录</span>
    <span class="hljs-type">String</span> <span class="hljs-variable">projectPath</span> <span class="hljs-operator">=</span> System.getProperty(<span class="hljs-string">"user.dir"</span>);
    <span class="hljs-type">String</span> <span class="hljs-variable">tempDirPath</span> <span class="hljs-operator">=</span> projectPath + File.separator + <span class="hljs-string">".temp"</span>;
    <span class="hljs-type">String</span> <span class="hljs-variable">templatePath</span> <span class="hljs-operator">=</span> tempDirPath + File.separator + id;

    <span class="hljs-comment">// 是否为首次制作模板</span>
    <span class="hljs-comment">// 目录不存在，则是首次制作</span>
    <span class="hljs-keyword">if</span> (!FileUtil.exist(templatePath)) {
        FileUtil.mkdir(templatePath);
        FileUtil.copy(originProjectPath, templatePath, <span class="hljs-literal">true</span>);
    }

    <span class="hljs-comment">// 一、输入信息</span>
    <span class="hljs-comment">// 输入文件信息</span>
    <span class="hljs-type">String</span> <span class="hljs-variable">sourceRootPath</span> <span class="hljs-operator">=</span> templatePath + File.separator + FileUtil.getLastPathEle(Paths.get(originProjectPath)).toString();
    <span class="hljs-comment">// 注意 win 系统需要对路径进行转义</span>
	sourceRootPath = sourceRootPath.replaceAll(<span class="hljs-string">"\\\\"</span>, <span class="hljs-string">"/"</span>);
    
    <span class="hljs-type">String</span> <span class="hljs-variable">fileInputPath</span> <span class="hljs-operator">=</span> inputFilePath;
    <span class="hljs-type">String</span> <span class="hljs-variable">fileOutputPath</span> <span class="hljs-operator">=</span> fileInputPath + <span class="hljs-string">".ftl"</span>;

    <span class="hljs-comment">// 二、使用字符串替换，生成模板文件</span>
    <span class="hljs-type">String</span> <span class="hljs-variable">fileInputAbsolutePath</span> <span class="hljs-operator">=</span> sourceRootPath + File.separator + fileInputPath;
    <span class="hljs-type">String</span> <span class="hljs-variable">fileOutputAbsolutePath</span> <span class="hljs-operator">=</span> sourceRootPath + File.separator + fileOutputPath;

    <span class="hljs-type">String</span> <span class="hljs-variable">fileContent</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;
    <span class="hljs-comment">// 如果已有模板文件，说明不是第一次制作，则在模板基础上再次挖坑</span>
    <span class="hljs-keyword">if</span> (FileUtil.exist(fileOutputAbsolutePath)) {
        fileContent = FileUtil.readUtf8String(fileOutputAbsolutePath);
    } <span class="hljs-keyword">else</span> {
        fileContent = FileUtil.readUtf8String(fileInputAbsolutePath);
    }
    <span class="hljs-type">String</span> <span class="hljs-variable">replacement</span> <span class="hljs-operator">=</span> String.format(<span class="hljs-string">"${%s}"</span>, modelInfo.getFieldName());
    <span class="hljs-type">String</span> <span class="hljs-variable">newFileContent</span> <span class="hljs-operator">=</span> StrUtil.replace(fileContent, searchStr, replacement);

    <span class="hljs-comment">// 输出模板文件</span>
    FileUtil.writeUtf8String(newFileContent, fileOutputAbsolutePath);

    <span class="hljs-comment">// 文件配置信息</span>
    Meta.FileConfig.<span class="hljs-type">FileInfo</span> <span class="hljs-variable">fileInfo</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Meta</span>.FileConfig.FileInfo();
    fileInfo.setInputPath(fileInputPath);
    fileInfo.setOutputPath(fileOutputPath);
    fileInfo.setType(FileTypeEnum.FILE.getValue());
    fileInfo.setGenerateType(FileGenerateTypeEnum.DYNAMIC.getValue());

    <span class="hljs-comment">// 三、生成配置文件</span>
    <span class="hljs-type">String</span> <span class="hljs-variable">metaOutputPath</span> <span class="hljs-operator">=</span> sourceRootPath + File.separator + <span class="hljs-string">"meta.json"</span>;

    <span class="hljs-comment">// 如果已有 meta 文件，说明不是第一次制作，则在 meta 基础上进行修改</span>
    <span class="hljs-keyword">if</span> (FileUtil.exist(metaOutputPath)) {
        <span class="hljs-type">Meta</span> <span class="hljs-variable">oldMeta</span> <span class="hljs-operator">=</span> JSONUtil.toBean(FileUtil.readUtf8String(metaOutputPath), Meta.class);
        BeanUtil.copyProperties(newMeta, oldMeta, CopyOptions.create().ignoreNullValue());
        newMeta = oldMeta;

        <span class="hljs-comment">// 1. 追加配置参数</span>
        List&lt;Meta.FileConfig.FileInfo&gt; fileInfoList = newMeta.getFileConfig().getFiles();
        fileInfoList.add(fileInfo);
        List&lt;Meta.ModelConfig.ModelInfo&gt; modelInfoList = newMeta.getModelConfig().getModels();
        modelInfoList.add(modelInfo);

        <span class="hljs-comment">// 配置去重</span>
        newMeta.getFileConfig().setFiles(distinctFiles(fileInfoList));
        newMeta.getModelConfig().setModels(distinctModels(modelInfoList));
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-comment">// 1. 构造配置参数</span>
        Meta.<span class="hljs-type">FileConfig</span> <span class="hljs-variable">fileConfig</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Meta</span>.FileConfig();
        newMeta.setFileConfig(fileConfig);
        fileConfig.setSourceRootPath(sourceRootPath);
        List&lt;Meta.FileConfig.FileInfo&gt; fileInfoList = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();
        fileConfig.setFiles(fileInfoList);
        fileInfoList.add(fileInfo);

        Meta.<span class="hljs-type">ModelConfig</span> <span class="hljs-variable">modelConfig</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Meta</span>.ModelConfig();
        newMeta.setModelConfig(modelConfig);
        List&lt;Meta.ModelConfig.ModelInfo&gt; modelInfoList = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();
        modelConfig.setModels(modelInfoList);
        modelInfoList.add(modelInfo);
    }

    <span class="hljs-comment">// 2. 输出元信息文件</span>
    FileUtil.writeUtf8String(JSONUtil.toJsonPrettyStr(newMeta), metaOutputPath);
    <span class="hljs-keyword">return</span> id;
}
</code></pre>
<h4 data-id="heading-12">测试</h4>
<p>最后，在 main 方法中指定 2 套不同的模型参数信息作为测试数据，并调用 <code>makeTemplate</code> 方法。</p>
<p>代码如下：</p>
<pre style="position: relative; padding-top: 3em; overflow: auto;"><div class="code-block-extension-header" style="position: absolute; top: 0; left: 0; width: 100%; height:28px; font-size:1em; background-color: rgb(248, 248, 248); box-shadow: 0px 4px 5px -6px #888888; display: flex; justify-content: space-between; align-items: center; padding: 0.5em 1em;"><div class="code-block-extension-headerLeft" style="filter: invert(0.5); opacity: 0.6;"><span class="code-block-extension-lang">java</span></div><div class="code-block-extension-headerRight" style="cursor: pointer;"><div class="code-block-extension-copyCodeBtn" style="filter: invert(0.5); opacity: 0.6;">复制代码</div></div></div><code class="language-java hljs" data-highlighted="yes"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
    <span class="hljs-type">Meta</span> <span class="hljs-variable">meta</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Meta</span>();
    meta.setName(<span class="hljs-string">"acm-template-generator"</span>);
    meta.setDescription(<span class="hljs-string">"ACM 示例模板生成器"</span>);

    <span class="hljs-type">String</span> <span class="hljs-variable">projectPath</span> <span class="hljs-operator">=</span> System.getProperty(<span class="hljs-string">"user.dir"</span>);
    <span class="hljs-type">String</span> <span class="hljs-variable">originProjectPath</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(projectPath).getParent() + File.separator + <span class="hljs-string">"yuzi-generator-demo-projects/acm-template"</span>;
    <span class="hljs-type">String</span> <span class="hljs-variable">inputFilePath</span> <span class="hljs-operator">=</span> <span class="hljs-string">"src/com/yupi/acm/MainTemplate.java"</span>;


    <span class="hljs-comment">// 模型参数信息（首次）</span>
    Meta.ModelConfig.<span class="hljs-type">ModelInfo</span> <span class="hljs-variable">modelInfo</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Meta</span>.ModelConfig.ModelInfo();
    modelInfo.setFieldName(<span class="hljs-string">"outputText"</span>);
    modelInfo.setType(<span class="hljs-string">"String"</span>);
    modelInfo.setDefaultValue(<span class="hljs-string">"sum = "</span>);

    <span class="hljs-comment">// 模型参数信息（第二次）</span>
<span class="hljs-comment">//        Meta.ModelConfig.ModelInfo modelInfo = new Meta.ModelConfig.ModelInfo();</span>
<span class="hljs-comment">//        modelInfo.setFieldName("className");</span>
<span class="hljs-comment">//        modelInfo.setType("String");</span>

    <span class="hljs-comment">// 替换变量（首次）</span>
    <span class="hljs-type">String</span> <span class="hljs-variable">searchStr</span> <span class="hljs-operator">=</span> <span class="hljs-string">"Sum: "</span>;
    <span class="hljs-comment">// 替换变量（第二次）</span>
<span class="hljs-comment">//        String searchStr = "MainTemplate";</span>

    <span class="hljs-type">long</span> <span class="hljs-variable">id</span> <span class="hljs-operator">=</span> makeTemplate(meta, originProjectPath, inputFilePath, modelInfo, searchStr, <span class="hljs-literal">null</span>);
    System.out.println(id);
}
</code></pre>
<p>第一次执行，成功制作模板并生成元信息，返回了一个新的 id：</p>
<p><img src="https://pic.code-nav.cn/post_picture/1610518142000300034/b0e22dea-ff38-4d41-80b4-8784f3b072e6.png" alt="image.png" class="medium-zoom-image"></p>
<p>将得到的 id 作为 <code>makeTemplate</code> 方法的参数，修改传入的模型信息和替换变量：</p>
<p><img src="https://pic.code-nav.cn/post_picture/1610518142000300034/d2e7ab2e-bf8e-4059-b805-ad803eb0afa0.png" alt="image.png" class="medium-zoom-image"></p>
<p>然后再次执行，可以发现模板文件又多 “挖了一个坑”，并且元信息配置多加了一个模型参数：</p>
<p><img src="https://pic.code-nav.cn/post_picture/1610518142000300034/17a23b77-68fe-40b9-b803-7c0e93406afc.png" alt="image.png" class="medium-zoom-image"></p>
<h4 data-id="heading-13">完整代码</h4>
<p><code>TemplateMaker</code> 的完整代码如下：</p>
<pre style="position: relative; padding-top: 3em; overflow: auto;"><div class="code-block-extension-header" style="position: absolute; top: 0; left: 0; width: 100%; height:28px; font-size:1em; background-color: rgb(248, 248, 248); box-shadow: 0px 4px 5px -6px #888888; display: flex; justify-content: space-between; align-items: center; padding: 0.5em 1em;"><div class="code-block-extension-headerLeft" style="filter: invert(0.5); opacity: 0.6;"><span class="code-block-extension-lang">java</span></div><div class="code-block-extension-headerRight" style="cursor: pointer;"><div class="code-block-extension-copyCodeBtn" style="filter: invert(0.5); opacity: 0.6;">复制代码</div></div></div><code class="language-java hljs" data-highlighted="yes"><span class="hljs-keyword">package</span> com.yupi.maker.template;

<span class="hljs-keyword">import</span> cn.hutool.core.bean.BeanUtil;
<span class="hljs-keyword">import</span> cn.hutool.core.bean.copier.CopyOptions;
<span class="hljs-keyword">import</span> cn.hutool.core.io.FileUtil;
<span class="hljs-keyword">import</span> cn.hutool.core.util.IdUtil;
<span class="hljs-keyword">import</span> cn.hutool.core.util.StrUtil;
<span class="hljs-keyword">import</span> cn.hutool.json.JSONUtil;
<span class="hljs-keyword">import</span> com.yupi.maker.meta.Meta;
<span class="hljs-keyword">import</span> com.yupi.maker.meta.enums.FileGenerateTypeEnum;
<span class="hljs-keyword">import</span> com.yupi.maker.meta.enums.FileTypeEnum;

<span class="hljs-keyword">import</span> java.io.File;
<span class="hljs-keyword">import</span> java.nio.file.Paths;
<span class="hljs-keyword">import</span> java.util.ArrayList;
<span class="hljs-keyword">import</span> java.util.List;
<span class="hljs-keyword">import</span> java.util.stream.Collectors;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TemplateMaker</span> {

    <span class="hljs-comment">/**
     * 制作模板
     *
     * <span class="hljs-doctag">@param</span> newMeta
     * <span class="hljs-doctag">@param</span> originProjectPath
     * <span class="hljs-doctag">@param</span> inputFilePath
     * <span class="hljs-doctag">@param</span> modelInfo
     * <span class="hljs-doctag">@param</span> searchStr
     * <span class="hljs-doctag">@param</span> id
     * <span class="hljs-doctag">@return</span>
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">long</span> <span class="hljs-title function_">makeTemplate</span><span class="hljs-params">(Meta newMeta, String originProjectPath, String inputFilePath, Meta.ModelConfig.ModelInfo modelInfo, String searchStr, Long id)</span> {
        <span class="hljs-comment">// 没有 id 则生成</span>
        <span class="hljs-keyword">if</span> (id == <span class="hljs-literal">null</span>) {
            id = IdUtil.getSnowflakeNextId();
        }

        <span class="hljs-comment">// 复制目录</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">projectPath</span> <span class="hljs-operator">=</span> System.getProperty(<span class="hljs-string">"user.dir"</span>);
        <span class="hljs-type">String</span> <span class="hljs-variable">tempDirPath</span> <span class="hljs-operator">=</span> projectPath + File.separator + <span class="hljs-string">".temp"</span>;
        <span class="hljs-type">String</span> <span class="hljs-variable">templatePath</span> <span class="hljs-operator">=</span> tempDirPath + File.separator + id;

        <span class="hljs-comment">// 是否为首次制作模板</span>
        <span class="hljs-comment">// 目录不存在，则是首次制作</span>
        <span class="hljs-keyword">if</span> (!FileUtil.exist(templatePath)) {
            FileUtil.mkdir(templatePath);
            FileUtil.copy(originProjectPath, templatePath, <span class="hljs-literal">true</span>);
        }

        <span class="hljs-comment">// 一、输入信息</span>
        <span class="hljs-comment">// 输入文件信息</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">sourceRootPath</span> <span class="hljs-operator">=</span> templatePath + File.separator + FileUtil.getLastPathEle(Paths.get(originProjectPath)).toString();
        <span class="hljs-comment">// 注意 win 系统需要对路径进行转义</span>
		sourceRootPath = sourceRootPath.replaceAll(<span class="hljs-string">"\\\\"</span>, <span class="hljs-string">"/"</span>);
        <span class="hljs-type">String</span> <span class="hljs-variable">fileInputPath</span> <span class="hljs-operator">=</span> inputFilePath;
        <span class="hljs-type">String</span> <span class="hljs-variable">fileOutputPath</span> <span class="hljs-operator">=</span> fileInputPath + <span class="hljs-string">".ftl"</span>;

        <span class="hljs-comment">// 二、使用字符串替换，生成模板文件</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">fileInputAbsolutePath</span> <span class="hljs-operator">=</span> sourceRootPath + File.separator + fileInputPath;
        <span class="hljs-type">String</span> <span class="hljs-variable">fileOutputAbsolutePath</span> <span class="hljs-operator">=</span> sourceRootPath + File.separator + fileOutputPath;

        <span class="hljs-type">String</span> <span class="hljs-variable">fileContent</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;
        <span class="hljs-comment">// 如果已有模板文件，说明不是第一次制作，则在模板基础上再次挖坑</span>
        <span class="hljs-keyword">if</span> (FileUtil.exist(fileOutputAbsolutePath)) {
            fileContent = FileUtil.readUtf8String(fileOutputAbsolutePath);
        } <span class="hljs-keyword">else</span> {
            fileContent = FileUtil.readUtf8String(fileInputAbsolutePath);
        }
        <span class="hljs-type">String</span> <span class="hljs-variable">replacement</span> <span class="hljs-operator">=</span> String.format(<span class="hljs-string">"${%s}"</span>, modelInfo.getFieldName());
        <span class="hljs-type">String</span> <span class="hljs-variable">newFileContent</span> <span class="hljs-operator">=</span> StrUtil.replace(fileContent, searchStr, replacement);

        <span class="hljs-comment">// 输出模板文件</span>
        FileUtil.writeUtf8String(newFileContent, fileOutputAbsolutePath);

        <span class="hljs-comment">// 文件配置信息</span>
        Meta.FileConfig.<span class="hljs-type">FileInfo</span> <span class="hljs-variable">fileInfo</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Meta</span>.FileConfig.FileInfo();
        fileInfo.setInputPath(fileInputPath);
        fileInfo.setOutputPath(fileOutputPath);
        fileInfo.setType(FileTypeEnum.FILE.getValue());
        fileInfo.setGenerateType(FileGenerateTypeEnum.DYNAMIC.getValue());

        <span class="hljs-comment">// 三、生成配置文件</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">metaOutputPath</span> <span class="hljs-operator">=</span> sourceRootPath + File.separator + <span class="hljs-string">"meta.json"</span>;

        <span class="hljs-comment">// 如果已有 meta 文件，说明不是第一次制作，则在 meta 基础上进行修改</span>
        <span class="hljs-keyword">if</span> (FileUtil.exist(metaOutputPath)) {
            <span class="hljs-type">Meta</span> <span class="hljs-variable">oldMeta</span> <span class="hljs-operator">=</span> JSONUtil.toBean(FileUtil.readUtf8String(metaOutputPath), Meta.class);
            BeanUtil.copyProperties(newMeta, oldMeta, CopyOptions.create().ignoreNullValue());
            newMeta = oldMeta;

            <span class="hljs-comment">// 1. 追加配置参数</span>
            List&lt;Meta.FileConfig.FileInfo&gt; fileInfoList = newMeta.getFileConfig().getFiles();
            fileInfoList.add(fileInfo);
            List&lt;Meta.ModelConfig.ModelInfo&gt; modelInfoList = newMeta.getModelConfig().getModels();
            modelInfoList.add(modelInfo);

            <span class="hljs-comment">// 配置去重</span>
            newMeta.getFileConfig().setFiles(distinctFiles(fileInfoList));
            newMeta.getModelConfig().setModels(distinctModels(modelInfoList));
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-comment">// 1. 构造配置参数</span>
            Meta.<span class="hljs-type">FileConfig</span> <span class="hljs-variable">fileConfig</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Meta</span>.FileConfig();
            newMeta.setFileConfig(fileConfig);
            fileConfig.setSourceRootPath(sourceRootPath);
            List&lt;Meta.FileConfig.FileInfo&gt; fileInfoList = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();
            fileConfig.setFiles(fileInfoList);
            fileInfoList.add(fileInfo);

            Meta.<span class="hljs-type">ModelConfig</span> <span class="hljs-variable">modelConfig</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Meta</span>.ModelConfig();
            newMeta.setModelConfig(modelConfig);
            List&lt;Meta.ModelConfig.ModelInfo&gt; modelInfoList = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();
            modelConfig.setModels(modelInfoList);
            modelInfoList.add(modelInfo);
        }

        <span class="hljs-comment">// 2. 输出元信息文件</span>
        FileUtil.writeUtf8String(JSONUtil.toJsonPrettyStr(newMeta), metaOutputPath);
        <span class="hljs-keyword">return</span> id;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-type">Meta</span> <span class="hljs-variable">meta</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Meta</span>();
        meta.setName(<span class="hljs-string">"acm-template-generator"</span>);
        meta.setDescription(<span class="hljs-string">"ACM 示例模板生成器"</span>);

        <span class="hljs-type">String</span> <span class="hljs-variable">projectPath</span> <span class="hljs-operator">=</span> System.getProperty(<span class="hljs-string">"user.dir"</span>);
        <span class="hljs-type">String</span> <span class="hljs-variable">originProjectPath</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(projectPath).getParent() + File.separator + <span class="hljs-string">"yuzi-generator-demo-projects/acm-template"</span>;
        <span class="hljs-type">String</span> <span class="hljs-variable">inputFilePath</span> <span class="hljs-operator">=</span> <span class="hljs-string">"src/com/yupi/acm/MainTemplate.java"</span>;


        <span class="hljs-comment">// 模型参数信息（首次）</span>
<span class="hljs-comment">//        Meta.ModelConfig.ModelInfo modelInfo = new Meta.ModelConfig.ModelInfo();</span>
<span class="hljs-comment">//        modelInfo.setFieldName("outputText");</span>
<span class="hljs-comment">//        modelInfo.setType("String");</span>
<span class="hljs-comment">//        modelInfo.setDefaultValue("sum = ");</span>

        <span class="hljs-comment">// 模型参数信息（第二次）</span>
        Meta.ModelConfig.<span class="hljs-type">ModelInfo</span> <span class="hljs-variable">modelInfo</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Meta</span>.ModelConfig.ModelInfo();
        modelInfo.setFieldName(<span class="hljs-string">"className"</span>);
        modelInfo.setType(<span class="hljs-string">"String"</span>);

        <span class="hljs-comment">// 替换变量（首次）</span>
<span class="hljs-comment">//        String searchStr = "Sum: ";</span>
        <span class="hljs-comment">// 替换变量（第二次）</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">searchStr</span> <span class="hljs-operator">=</span> <span class="hljs-string">"MainTemplate"</span>;

        <span class="hljs-type">long</span> <span class="hljs-variable">id</span> <span class="hljs-operator">=</span> makeTemplate(meta, originProjectPath, inputFilePath, modelInfo, searchStr, <span class="hljs-number">1735281524670181376L</span>);
        System.out.println(id);
    }

    <span class="hljs-comment">/**
     * 模型去重
     *
     * <span class="hljs-doctag">@param</span> modelInfoList
     * <span class="hljs-doctag">@return</span>
     */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> List&lt;Meta.ModelConfig.ModelInfo&gt; distinctModels(List&lt;Meta.ModelConfig.ModelInfo&gt; modelInfoList) {
        List&lt;Meta.ModelConfig.ModelInfo&gt; newModelInfoList = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;(modelInfoList.stream().collect(Collectors.toMap(Meta.ModelConfig.ModelInfo::getFieldName, o -&gt; o, (e, r) -&gt; r)).values());
        <span class="hljs-keyword">return</span> newModelInfoList;
    }

    <span class="hljs-comment">/**
     * 文件去重
     *
     * <span class="hljs-doctag">@param</span> fileInfoList
     * <span class="hljs-doctag">@return</span>
     */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> List&lt;Meta.FileConfig.FileInfo&gt; distinctFiles(List&lt;Meta.FileConfig.FileInfo&gt; fileInfoList) {
        List&lt;Meta.FileConfig.FileInfo&gt; newFileInfoList = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;(fileInfoList.stream().collect(Collectors.toMap(Meta.FileConfig.FileInfo::getInputPath, o -&gt; o, (e, r) -&gt; r)).values());
        <span class="hljs-keyword">return</span> newFileInfoList;
    }
}
</code></pre>
<hr>
<p>至此，分步制作能力开发完成。你还可以试着多次修改 meta 的基本信息，也是可以正确更新的。</p>
<p>实现了这个能力后，我们不仅可以依次使用多个模型参数对同一个文件 “挖坑”，也可以使用同一个模型参数依次对多个不同的文件挖坑。已经能够满足像 ACM 示例模板这种简单的项目了。</p>
<p>接下来，我们要给模板制作工具增加更多的功能，进一步提高使用的效率、并尽力满足 Spring Boot 模板项目代码生成器所需的能力。</p>
<h2 data-id="heading-14">四、更多功能实现</h2>
<h3 data-id="heading-15">1、单次制作多个模板文件</h3>
<p>虽然现在模板制作工具可以通过多次执行来制作多个模板文件，但还是比较麻烦。对于我们之前提到的 “批量替换项目下所有文件包名” 的需求，可能需要制作几十个模板文件，难道要执行几十次么？</p>
<p>所以我们需要实现多模板文件同时制作的能力。</p>
<p>有 2 种方法：</p>
<ol>
<li>支持输入文件目录，同时处理该目录下的所有文件</li>
<li>支持输入多个文件路径，同时处理这些文件</li>
</ol>
<p>下面依次实现这两种方法。</p>
<h4 data-id="heading-16">支持输入文件目录</h4>
<p>实现思路很简单，之前我们已经能针对单个文件制作模板了。那么对于文件目录下的多个文件，只要循环遍历 “单个文件制作模板” 的操作，不就能轻松实现了么？</p>
<p>1）所以我们首先需要抽象出制作单个文件模板的方法 <code>makeFileTemplate</code>，接受单个文件、模型信息、替换文本、sourceRootPath 等参数，返回 FileInfo 文件信息。</p>
<p>由于之前的输入文件路径是相对路径，而之后我们要遍历文件目录下的所有文件时，传来的文件是绝对路径。所以最好将方法接受的参数，由 String 类型的输入文件路径，修改为 File 类型的输入文件对象。但还要注意一点，在方法内部，要将绝对路径再转换为相对路径，以适配元信息文件的规则。</p>
<p>完整代码如下：</p>
<pre style="position: relative; padding-top: 3em; overflow: auto;"><div class="code-block-extension-header" style="position: absolute; top: 0; left: 0; width: 100%; height:28px; font-size:1em; background-color: rgb(248, 248, 248); box-shadow: 0px 4px 5px -6px #888888; display: flex; justify-content: space-between; align-items: center; padding: 0.5em 1em;"><div class="code-block-extension-headerLeft" style="filter: invert(0.5); opacity: 0.6;"><span class="code-block-extension-lang">java</span></div><div class="code-block-extension-headerRight" style="cursor: pointer;"><div class="code-block-extension-copyCodeBtn" style="filter: invert(0.5); opacity: 0.6;">复制代码</div></div></div><code class="language-java hljs" data-highlighted="yes"><span class="hljs-comment">/**
 * 制作文件模板
 *
 * <span class="hljs-doctag">@param</span> modelInfo
 * <span class="hljs-doctag">@param</span> searchStr
 * <span class="hljs-doctag">@param</span> sourceRootPath
 * <span class="hljs-doctag">@param</span> inputFile
 * <span class="hljs-doctag">@return</span>
 */</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Meta.FileConfig.FileInfo <span class="hljs-title function_">makeFileTemplate</span><span class="hljs-params">(Meta.ModelConfig.ModelInfo modelInfo, String searchStr, String sourceRootPath, File inputFile)</span> {
    <span class="hljs-comment">// 要挖坑的文件绝对路径（用于制作模板）</span>
    <span class="hljs-comment">// 注意 win 系统需要对路径进行转义</span>
    <span class="hljs-type">String</span> <span class="hljs-variable">fileInputAbsolutePath</span> <span class="hljs-operator">=</span> inputFile.getAbsolutePath().replaceAll(<span class="hljs-string">"\\\\"</span>, <span class="hljs-string">"/"</span>);
    <span class="hljs-type">String</span> <span class="hljs-variable">fileOutputAbsolutePath</span> <span class="hljs-operator">=</span> fileInputAbsolutePath + <span class="hljs-string">".ftl"</span>;

    <span class="hljs-comment">// 文件输入输出相对路径（用于生成配置）</span>
    <span class="hljs-type">String</span> <span class="hljs-variable">fileInputPath</span> <span class="hljs-operator">=</span> fileInputAbsolutePath.replace(sourceRootPath + <span class="hljs-string">"/"</span>, <span class="hljs-string">""</span>);
    <span class="hljs-type">String</span> <span class="hljs-variable">fileOutputPath</span> <span class="hljs-operator">=</span> fileInputPath + <span class="hljs-string">".ftl"</span>;

    <span class="hljs-comment">// 使用字符串替换，生成模板文件</span>
    String fileContent;
    <span class="hljs-comment">// 如果已有模板文件，说明不是第一次制作，则在模板基础上再次挖坑</span>
    <span class="hljs-keyword">if</span> (FileUtil.exist(fileOutputAbsolutePath)) {
        fileContent = FileUtil.readUtf8String(fileOutputAbsolutePath);
    } <span class="hljs-keyword">else</span> {
        fileContent = FileUtil.readUtf8String(fileInputAbsolutePath);
    }
    <span class="hljs-type">String</span> <span class="hljs-variable">replacement</span> <span class="hljs-operator">=</span> String.format(<span class="hljs-string">"${%s}"</span>, modelInfo.getFieldName());
    <span class="hljs-type">String</span> <span class="hljs-variable">newFileContent</span> <span class="hljs-operator">=</span> StrUtil.replace(fileContent, searchStr, replacement);

    <span class="hljs-comment">// 输出模板文件</span>
    FileUtil.writeUtf8String(newFileContent, fileOutputAbsolutePath);

    <span class="hljs-comment">// 文件配置信息</span>
    Meta.FileConfig.<span class="hljs-type">FileInfo</span> <span class="hljs-variable">fileInfo</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Meta</span>.FileConfig.FileInfo();
    fileInfo.setInputPath(fileInputPath);
    fileInfo.setOutputPath(fileOutputPath);
    fileInfo.setType(FileTypeEnum.FILE.getValue());
    fileInfo.setGenerateType(FileGenerateTypeEnum.DYNAMIC.getValue());
    <span class="hljs-keyword">return</span> fileInfo;
}
</code></pre>
<p>2）如果输入的文件路径是目录，那么使用 Hutool 的 <code>loopFiles</code> 方法递归遍历并获取目录下的所有文件列表。</p>
<p>修改 <code>makeTemplate</code> 方法中生成文件的相关代码，如下：</p>
<pre style="position: relative; padding-top: 3em; overflow: auto;"><div class="code-block-extension-header" style="position: absolute; top: 0; left: 0; width: 100%; height:28px; font-size:1em; background-color: rgb(248, 248, 248); box-shadow: 0px 4px 5px -6px #888888; display: flex; justify-content: space-between; align-items: center; padding: 0.5em 1em;"><div class="code-block-extension-headerLeft" style="filter: invert(0.5); opacity: 0.6;"><span class="code-block-extension-lang">java</span></div><div class="code-block-extension-headerRight" style="cursor: pointer;"><div class="code-block-extension-copyCodeBtn" style="filter: invert(0.5); opacity: 0.6;">复制代码</div></div></div><code class="language-java hljs" data-highlighted="yes"><span class="hljs-comment">// 一、输入信息</span>
<span class="hljs-comment">// 输入文件信息</span>
<span class="hljs-type">String</span> <span class="hljs-variable">sourceRootPath</span> <span class="hljs-operator">=</span> templatePath + File.separator + FileUtil.getLastPathEle(Paths.get(originProjectPath)).toString();

<span class="hljs-comment">// 二、生成文件模板</span>
<span class="hljs-comment">// 输入文件为目录</span>
List&lt;Meta.FileConfig.FileInfo&gt; newFileInfoList = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();
<span class="hljs-type">String</span> <span class="hljs-variable">inputFileAbsolutePath</span> <span class="hljs-operator">=</span> sourceRootPath + File.separator + inputFilePath;
<span class="hljs-keyword">if</span> (FileUtil.isDirectory(inputFileAbsolutePath)) {
    List&lt;File&gt; fileList = FileUtil.loopFiles(inputFileAbsolutePath);
    <span class="hljs-keyword">for</span> (File file : fileList) {
        Meta.FileConfig.<span class="hljs-type">FileInfo</span> <span class="hljs-variable">fileInfo</span> <span class="hljs-operator">=</span> makeFileTemplate(modelInfo, searchStr, sourceRootPath, file);
        newFileInfoList.add(fileInfo);
    }
} <span class="hljs-keyword">else</span> {
    <span class="hljs-comment">// 输入的是文件</span>
    Meta.FileConfig.<span class="hljs-type">FileInfo</span> <span class="hljs-variable">fileInfo</span> <span class="hljs-operator">=</span> makeFileTemplate(modelInfo, searchStr, sourceRootPath, <span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(inputFileAbsolutePath));
    newFileInfoList.add(fileInfo);
}

<span class="hljs-comment">// 三、生成配置文件</span>
<span class="hljs-type">String</span> <span class="hljs-variable">metaOutputPath</span> <span class="hljs-operator">=</span> sourceRootPath + File.separator + <span class="hljs-string">"meta.json"</span>;
</code></pre>
<p>其中，使用 <code>newFileInfoList</code> 来存储所有文件的信息列表。</p>
<p>在生成配置文件时，以前是使用 <code>fileInfoList.add</code> 添加一个文件信息对象，现在要改为 <code>fileInfoList.addAll</code> 添加 <code>newFileInfoList</code> 文件信息列表。</p>
<p>修改后的代码如下：</p>
<pre style="position: relative; padding-top: 3em; overflow: auto;"><div class="code-block-extension-header" style="position: absolute; top: 0; left: 0; width: 100%; height:28px; font-size:1em; background-color: rgb(248, 248, 248); box-shadow: 0px 4px 5px -6px #888888; display: flex; justify-content: space-between; align-items: center; padding: 0.5em 1em;"><div class="code-block-extension-headerLeft" style="filter: invert(0.5); opacity: 0.6;"><span class="code-block-extension-lang">java</span></div><div class="code-block-extension-headerRight" style="cursor: pointer;"><div class="code-block-extension-copyCodeBtn" style="filter: invert(0.5); opacity: 0.6;">复制代码</div></div></div><code class="language-java hljs" data-highlighted="yes"><span class="hljs-comment">// 三、生成配置文件</span>
<span class="hljs-type">String</span> <span class="hljs-variable">metaOutputPath</span> <span class="hljs-operator">=</span> sourceRootPath + File.separator + <span class="hljs-string">"meta.json"</span>;

<span class="hljs-comment">// 如果已有 meta 文件，说明不是第一次制作，则在 meta 基础上进行修改</span>
<span class="hljs-keyword">if</span> (FileUtil.exist(metaOutputPath)) {
    <span class="hljs-type">Meta</span> <span class="hljs-variable">oldMeta</span> <span class="hljs-operator">=</span> JSONUtil.toBean(FileUtil.readUtf8String(metaOutputPath), Meta.class);
    BeanUtil.copyProperties(newMeta, oldMeta, CopyOptions.create().ignoreNullValue());
    newMeta = oldMeta;

    <span class="hljs-comment">// 1. 追加配置参数</span>
    List&lt;Meta.FileConfig.FileInfo&gt; fileInfoList = newMeta.getFileConfig().getFiles();
    fileInfoList.addAll(newFileInfoList);
    List&lt;Meta.ModelConfig.ModelInfo&gt; modelInfoList = newMeta.getModelConfig().getModels();
    modelInfoList.add(modelInfo);

    <span class="hljs-comment">// 配置去重</span>
    newMeta.getFileConfig().setFiles(distinctFiles(fileInfoList));
    newMeta.getModelConfig().setModels(distinctModels(modelInfoList));
} <span class="hljs-keyword">else</span> {
    <span class="hljs-comment">// 1. 构造配置参数</span>
    Meta.<span class="hljs-type">FileConfig</span> <span class="hljs-variable">fileConfig</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Meta</span>.FileConfig();
    newMeta.setFileConfig(fileConfig);
    fileConfig.setSourceRootPath(sourceRootPath);
    List&lt;Meta.FileConfig.FileInfo&gt; fileInfoList = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();
    fileConfig.setFiles(fileInfoList);
    fileInfoList.addAll(newFileInfoList);

    Meta.<span class="hljs-type">ModelConfig</span> <span class="hljs-variable">modelConfig</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Meta</span>.ModelConfig();
    newMeta.setModelConfig(modelConfig);
    List&lt;Meta.ModelConfig.ModelInfo&gt; modelInfoList = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();
    modelConfig.setModels(modelInfoList);
    modelInfoList.add(modelInfo);
}
</code></pre>
<p>3）修改 main 方法中传入的原始项目路径为 <code>springboot-init</code> 项目，输入文件路径改为 <code>springbootinit</code> 目录：</p>
<pre style="position: relative; padding-top: 3em; overflow: auto;"><div class="code-block-extension-header" style="position: absolute; top: 0; left: 0; width: 100%; height:28px; font-size:1em; background-color: rgb(248, 248, 248); box-shadow: 0px 4px 5px -6px #888888; display: flex; justify-content: space-between; align-items: center; padding: 0.5em 1em;"><div class="code-block-extension-headerLeft" style="filter: invert(0.5); opacity: 0.6;"><span class="code-block-extension-lang">java</span></div><div class="code-block-extension-headerRight" style="cursor: pointer;"><div class="code-block-extension-copyCodeBtn" style="filter: invert(0.5); opacity: 0.6;">复制代码</div></div></div><code class="language-java hljs" data-highlighted="yes"><span class="hljs-type">String</span> <span class="hljs-variable">originProjectPath</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(projectPath).getParent() + File.separator + <span class="hljs-string">"yuzi-generator-demo-projects/springboot-init"</span>;
<span class="hljs-type">String</span> <span class="hljs-variable">inputFilePath</span> <span class="hljs-operator">=</span> <span class="hljs-string">"src/main/java/com/yupi/springbootinit"</span>;
</code></pre>
<p>然后执行测试，目录下的所有文件都生成了模板：</p>
<p><img src="https://pic.code-nav.cn/post_picture/1610518142000300034/cc7e7ef0-ffbf-49e2-b4ea-e6746136e3f9.png" alt="image.png" class="medium-zoom-image"></p>
<p>但是貌似生成的模板有点太多了。。。明明这些文件内没有任何内容被模型参数替换了，但也生成了模板？</p>
<p>4）所以这里我们需要优化下逻辑，如果某个文件内容没有被参数替换，那么就不生成模板，而是以静态生成的方式记录到元信息配置中。</p>
<p>修改 <code>makeFileTemplate</code> 方法，通过对比替换前后的内容是否一致来更改生成方式。</p>
<p>注意，如果是静态生成，文件输出路径（outputPath）要设置为和输入路径（inputPath）相同。</p>
<p>修改后的方法代码如下（主要修改了后半段）：</p>
<pre style="position: relative; padding-top: 3em; overflow: auto;"><div class="code-block-extension-header" style="position: absolute; top: 0; left: 0; width: 100%; height:28px; font-size:1em; background-color: rgb(248, 248, 248); box-shadow: 0px 4px 5px -6px #888888; display: flex; justify-content: space-between; align-items: center; padding: 0.5em 1em;"><div class="code-block-extension-headerLeft" style="filter: invert(0.5); opacity: 0.6;"><span class="code-block-extension-lang">java</span></div><div class="code-block-extension-headerRight" style="cursor: pointer;"><div class="code-block-extension-copyCodeBtn" style="filter: invert(0.5); opacity: 0.6;">复制代码</div></div></div><code class="language-java hljs" data-highlighted="yes"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Meta.FileConfig.FileInfo <span class="hljs-title function_">makeFileTemplate</span><span class="hljs-params">(Meta.ModelConfig.ModelInfo modelInfo, String searchStr, String sourceRootPath, File inputFile)</span> {
    <span class="hljs-comment">// 要挖坑的文件绝对路径（用于制作模板）</span>
    <span class="hljs-comment">// 注意 win 系统需要对路径进行转义</span>
    <span class="hljs-type">String</span> <span class="hljs-variable">fileInputAbsolutePath</span> <span class="hljs-operator">=</span> inputFile.getAbsolutePath().replaceAll(<span class="hljs-string">"\\\\"</span>, <span class="hljs-string">"/"</span>);
    <span class="hljs-type">String</span> <span class="hljs-variable">fileOutputAbsolutePath</span> <span class="hljs-operator">=</span> fileInputAbsolutePath + <span class="hljs-string">".ftl"</span>;

    <span class="hljs-comment">// 文件输入输出相对路径（用于生成配置）</span>
    <span class="hljs-type">String</span> <span class="hljs-variable">fileInputPath</span> <span class="hljs-operator">=</span> fileInputAbsolutePath.replace(sourceRootPath + <span class="hljs-string">"/"</span>, <span class="hljs-string">""</span>);
    <span class="hljs-type">String</span> <span class="hljs-variable">fileOutputPath</span> <span class="hljs-operator">=</span> fileInputPath + <span class="hljs-string">".ftl"</span>;

    <span class="hljs-comment">// 使用字符串替换，生成模板文件</span>
    String fileContent;
    <span class="hljs-comment">// 如果已有模板文件，说明不是第一次制作，则在模板基础上再次挖坑</span>
    <span class="hljs-keyword">if</span> (FileUtil.exist(fileOutputAbsolutePath)) {
        fileContent = FileUtil.readUtf8String(fileOutputAbsolutePath);
    } <span class="hljs-keyword">else</span> {
        fileContent = FileUtil.readUtf8String(fileInputAbsolutePath);
    }
    <span class="hljs-type">String</span> <span class="hljs-variable">replacement</span> <span class="hljs-operator">=</span> String.format(<span class="hljs-string">"${%s}"</span>, modelInfo.getFieldName());
    <span class="hljs-type">String</span> <span class="hljs-variable">newFileContent</span> <span class="hljs-operator">=</span> StrUtil.replace(fileContent, searchStr, replacement);
    
    <span class="hljs-comment">// 文件配置信息</span>
    Meta.FileConfig.<span class="hljs-type">FileInfo</span> <span class="hljs-variable">fileInfo</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Meta</span>.FileConfig.FileInfo();
    fileInfo.setInputPath(fileInputPath);
    fileInfo.setOutputPath(fileOutputPath);
    fileInfo.setType(FileTypeEnum.FILE.getValue());

    <span class="hljs-comment">// 和原文件一致，没有挖坑，则为静态生成</span>
    <span class="hljs-keyword">if</span> (newFileContent.equals(fileContent)) {
        <span class="hljs-comment">// 输出路径 = 输入路径</span>
        fileInfo.setOutputPath(fileInputPath);
        fileInfo.setGenerateType(FileGenerateTypeEnum.STATIC.getValue());
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-comment">// 生成模板文件</span>
        fileInfo.setGenerateType(FileGenerateTypeEnum.DYNAMIC.getValue());
        FileUtil.writeUtf8String(newFileContent, fileOutputAbsolutePath);
    }
    <span class="hljs-keyword">return</span> fileInfo;
}
</code></pre>
<p>5）更改 main 方法中的 <code>searchStr</code> 为 <code>BaseResponse</code>，然后再次执行测试。</p>
<p>效果符合预期，springbootinit 包中，包含该字符串的文件才生成了模板：</p>
<p><img src="https://pic.code-nav.cn/post_picture/1610518142000300034/ff74271f-9e7b-4a94-a833-cd06f3c3646a.png" alt="image.png" class="medium-zoom-image"></p>
<p>查看生成的元信息配置文件，生成了符合要求的静态和动态文件配置：</p>
<p><img src="https://pic.code-nav.cn/post_picture/1610518142000300034/d8eb5dc6-e190-4180-a7e8-271b8e276d3a.png" alt="image.png" class="medium-zoom-image"></p>
<h4 data-id="heading-17">支持输入多个文件</h4>
<p>如果想在单次制作时支持输入多个文件，其实只要把 <code>makeTemplate</code> 方法的输入参数 <code>inputFilePath</code>（单数）改为 <code>inputFilePathList</code>（复数），再多加一层循环处理即可。</p>
<p>修改 <code>makeTemplate</code> 方法中生成文件模板的代码如下：</p>
<pre style="position: relative; padding-top: 3em; overflow: auto;"><div class="code-block-extension-header" style="position: absolute; top: 0; left: 0; width: 100%; height:28px; font-size:1em; background-color: rgb(248, 248, 248); box-shadow: 0px 4px 5px -6px #888888; display: flex; justify-content: space-between; align-items: center; padding: 0.5em 1em;"><div class="code-block-extension-headerLeft" style="filter: invert(0.5); opacity: 0.6;"><span class="code-block-extension-lang">java</span></div><div class="code-block-extension-headerRight" style="cursor: pointer;"><div class="code-block-extension-copyCodeBtn" style="filter: invert(0.5); opacity: 0.6;">复制代码</div></div></div><code class="language-java hljs" data-highlighted="yes"><span class="hljs-comment">// 二、生成文件模板</span>
<span class="hljs-comment">// 遍历输入文件</span>
List&lt;Meta.FileConfig.FileInfo&gt; newFileInfoList = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();
<span class="hljs-keyword">for</span> (String inputFilePath : inputFilePathList) {
    <span class="hljs-type">String</span> <span class="hljs-variable">inputFileAbsolutePath</span> <span class="hljs-operator">=</span> sourceRootPath + File.separator + inputFilePath;
    <span class="hljs-comment">// 输入的是目录</span>
    <span class="hljs-keyword">if</span> (FileUtil.isDirectory(inputFileAbsolutePath)) {
        List&lt;File&gt; fileList = FileUtil.loopFiles(inputFileAbsolutePath);
        <span class="hljs-keyword">for</span> (File file : fileList) {
            Meta.FileConfig.<span class="hljs-type">FileInfo</span> <span class="hljs-variable">fileInfo</span> <span class="hljs-operator">=</span> makeFileTemplate(modelInfo, searchStr, sourceRootPath, file);
            newFileInfoList.add(fileInfo);
        }
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-comment">// 输入的是文件</span>
        Meta.FileConfig.<span class="hljs-type">FileInfo</span> <span class="hljs-variable">fileInfo</span> <span class="hljs-operator">=</span> makeFileTemplate(modelInfo, searchStr, sourceRootPath, <span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(inputFileAbsolutePath));
        newFileInfoList.add(fileInfo);
    }
}
</code></pre>
<p>然后修改 main 方法中的测试条件为文件列表，验证效果：</p>
<pre style="position: relative; padding-top: 3em; overflow: auto;"><div class="code-block-extension-header" style="position: absolute; top: 0; left: 0; width: 100%; height:28px; font-size:1em; background-color: rgb(248, 248, 248); box-shadow: 0px 4px 5px -6px #888888; display: flex; justify-content: space-between; align-items: center; padding: 0.5em 1em;"><div class="code-block-extension-headerLeft" style="filter: invert(0.5); opacity: 0.6;"><span class="code-block-extension-lang">java</span></div><div class="code-block-extension-headerRight" style="cursor: pointer;"><div class="code-block-extension-copyCodeBtn" style="filter: invert(0.5); opacity: 0.6;">复制代码</div></div></div><code class="language-java hljs" data-highlighted="yes"><span class="hljs-type">String</span> <span class="hljs-variable">inputFilePath1</span> <span class="hljs-operator">=</span> <span class="hljs-string">"src/main/java/com/yupi/springbootinit/common"</span>;
<span class="hljs-type">String</span> <span class="hljs-variable">inputFilePath2</span> <span class="hljs-operator">=</span> <span class="hljs-string">"src/main/java/com/yupi/springbootinit/controller"</span>;
List&lt;String&gt; inputFilePathList = Arrays.asList(inputFilePath1, inputFilePath2);
</code></pre>
<p>结果符合预期，同时将多个指定目录下的文件制作成了模板：</p>
<p><img src="https://pic.code-nav.cn/post_picture/1610518142000300034/a0a6e54c-5f55-4cd1-b251-a1af03275fe1.png" alt="image.png" class="medium-zoom-image"></p>
<h4 data-id="heading-18">完整代码</h4>
<p>至此，已经实现了单次制作多个模板文件的功能。</p>
<p><code>TemplateMaker</code> 的完整代码如下：</p>
<pre style="position: relative; padding-top: 3em; overflow: auto;"><div class="code-block-extension-header" style="position: absolute; top: 0; left: 0; width: 100%; height:28px; font-size:1em; background-color: rgb(248, 248, 248); box-shadow: 0px 4px 5px -6px #888888; display: flex; justify-content: space-between; align-items: center; padding: 0.5em 1em;"><div class="code-block-extension-headerLeft" style="filter: invert(0.5); opacity: 0.6;"><span class="code-block-extension-lang">java</span></div><div class="code-block-extension-headerRight" style="cursor: pointer;"><div class="code-block-extension-copyCodeBtn" style="filter: invert(0.5); opacity: 0.6;">复制代码</div></div></div><code class="language-java hljs" data-highlighted="yes"><span class="hljs-keyword">package</span> com.yupi.maker.template;

<span class="hljs-keyword">import</span> cn.hutool.core.bean.BeanUtil;
<span class="hljs-keyword">import</span> cn.hutool.core.bean.copier.CopyOptions;
<span class="hljs-keyword">import</span> cn.hutool.core.io.FileUtil;
<span class="hljs-keyword">import</span> cn.hutool.core.util.IdUtil;
<span class="hljs-keyword">import</span> cn.hutool.core.util.StrUtil;
<span class="hljs-keyword">import</span> cn.hutool.json.JSONUtil;
<span class="hljs-keyword">import</span> com.yupi.maker.meta.Meta;
<span class="hljs-keyword">import</span> com.yupi.maker.meta.enums.FileGenerateTypeEnum;
<span class="hljs-keyword">import</span> com.yupi.maker.meta.enums.FileTypeEnum;

<span class="hljs-keyword">import</span> java.io.File;
<span class="hljs-keyword">import</span> java.nio.file.Paths;
<span class="hljs-keyword">import</span> java.util.ArrayList;
<span class="hljs-keyword">import</span> java.util.Arrays;
<span class="hljs-keyword">import</span> java.util.List;
<span class="hljs-keyword">import</span> java.util.stream.Collectors;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TemplateMaker</span> {

    <span class="hljs-comment">/**
     * 制作模板
     *
     * <span class="hljs-doctag">@param</span> newMeta
     * <span class="hljs-doctag">@param</span> originProjectPath
     * <span class="hljs-doctag">@param</span> inputFilePathList
     * <span class="hljs-doctag">@param</span> modelInfo
     * <span class="hljs-doctag">@param</span> searchStr
     * <span class="hljs-doctag">@param</span> id
     * <span class="hljs-doctag">@return</span>
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">long</span> <span class="hljs-title function_">makeTemplate</span><span class="hljs-params">(Meta newMeta, String originProjectPath, List&lt;String&gt; inputFilePathList, Meta.ModelConfig.ModelInfo modelInfo, String searchStr, Long id)</span> {
        <span class="hljs-comment">// 没有 id 则生成</span>
        <span class="hljs-keyword">if</span> (id == <span class="hljs-literal">null</span>) {
            id = IdUtil.getSnowflakeNextId();
        }

        <span class="hljs-comment">// 复制目录</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">projectPath</span> <span class="hljs-operator">=</span> System.getProperty(<span class="hljs-string">"user.dir"</span>);
        <span class="hljs-type">String</span> <span class="hljs-variable">tempDirPath</span> <span class="hljs-operator">=</span> projectPath + File.separator + <span class="hljs-string">".temp"</span>;
        <span class="hljs-type">String</span> <span class="hljs-variable">templatePath</span> <span class="hljs-operator">=</span> tempDirPath + File.separator + id;

        <span class="hljs-comment">// 是否为首次制作模板</span>
        <span class="hljs-comment">// 目录不存在，则是首次制作</span>
        <span class="hljs-keyword">if</span> (!FileUtil.exist(templatePath)) {
            FileUtil.mkdir(templatePath);
            FileUtil.copy(originProjectPath, templatePath, <span class="hljs-literal">true</span>);
        }

        <span class="hljs-comment">// 一、输入信息</span>
        <span class="hljs-comment">// 输入文件信息</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">sourceRootPath</span> <span class="hljs-operator">=</span> templatePath + File.separator + FileUtil.getLastPathEle(Paths.get(originProjectPath)).toString();
        <span class="hljs-comment">// 注意 win 系统需要对路径进行转义</span>
    	sourceRootPath = sourceRootPath.replaceAll(<span class="hljs-string">"\\\\"</span>, <span class="hljs-string">"/"</span>);
        
        <span class="hljs-comment">// 二、生成文件模板</span>
        <span class="hljs-comment">// 遍历输入文件</span>
        List&lt;Meta.FileConfig.FileInfo&gt; newFileInfoList = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();
        <span class="hljs-keyword">for</span> (String inputFilePath : inputFilePathList) {
            <span class="hljs-type">String</span> <span class="hljs-variable">inputFileAbsolutePath</span> <span class="hljs-operator">=</span> sourceRootPath + File.separator + inputFilePath;
            <span class="hljs-comment">// 输入的是目录</span>
            <span class="hljs-keyword">if</span> (FileUtil.isDirectory(inputFileAbsolutePath)) {
                List&lt;File&gt; fileList = FileUtil.loopFiles(inputFileAbsolutePath);
                <span class="hljs-keyword">for</span> (File file : fileList) {
                    Meta.FileConfig.<span class="hljs-type">FileInfo</span> <span class="hljs-variable">fileInfo</span> <span class="hljs-operator">=</span> makeFileTemplate(modelInfo, searchStr, sourceRootPath, file);
                    newFileInfoList.add(fileInfo);
                }
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-comment">// 输入的是文件</span>
                Meta.FileConfig.<span class="hljs-type">FileInfo</span> <span class="hljs-variable">fileInfo</span> <span class="hljs-operator">=</span> makeFileTemplate(modelInfo, searchStr, sourceRootPath, <span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(inputFileAbsolutePath));
                newFileInfoList.add(fileInfo);
            }
        }

        <span class="hljs-comment">// 三、生成配置文件</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">metaOutputPath</span> <span class="hljs-operator">=</span> sourceRootPath + File.separator + <span class="hljs-string">"meta.json"</span>;

        <span class="hljs-comment">// 如果已有 meta 文件，说明不是第一次制作，则在 meta 基础上进行修改</span>
        <span class="hljs-keyword">if</span> (FileUtil.exist(metaOutputPath)) {
            <span class="hljs-type">Meta</span> <span class="hljs-variable">oldMeta</span> <span class="hljs-operator">=</span> JSONUtil.toBean(FileUtil.readUtf8String(metaOutputPath), Meta.class);
            BeanUtil.copyProperties(newMeta, oldMeta, CopyOptions.create().ignoreNullValue());
            newMeta = oldMeta;

            <span class="hljs-comment">// 1. 追加配置参数</span>
            List&lt;Meta.FileConfig.FileInfo&gt; fileInfoList = newMeta.getFileConfig().getFiles();
            fileInfoList.addAll(newFileInfoList);
            List&lt;Meta.ModelConfig.ModelInfo&gt; modelInfoList = newMeta.getModelConfig().getModels();
            modelInfoList.add(modelInfo);

            <span class="hljs-comment">// 配置去重</span>
            newMeta.getFileConfig().setFiles(distinctFiles(fileInfoList));
            newMeta.getModelConfig().setModels(distinctModels(modelInfoList));
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-comment">// 1. 构造配置参数</span>
            Meta.<span class="hljs-type">FileConfig</span> <span class="hljs-variable">fileConfig</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Meta</span>.FileConfig();
            newMeta.setFileConfig(fileConfig);
            fileConfig.setSourceRootPath(sourceRootPath);
            List&lt;Meta.FileConfig.FileInfo&gt; fileInfoList = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();
            fileConfig.setFiles(fileInfoList);
            fileInfoList.addAll(newFileInfoList);

            Meta.<span class="hljs-type">ModelConfig</span> <span class="hljs-variable">modelConfig</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Meta</span>.ModelConfig();
            newMeta.setModelConfig(modelConfig);
            List&lt;Meta.ModelConfig.ModelInfo&gt; modelInfoList = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();
            modelConfig.setModels(modelInfoList);
            modelInfoList.add(modelInfo);
        }

        <span class="hljs-comment">// 2. 输出元信息文件</span>
        FileUtil.writeUtf8String(JSONUtil.toJsonPrettyStr(newMeta), metaOutputPath);
        <span class="hljs-keyword">return</span> id;
    }

    <span class="hljs-comment">/**
     * 制作文件模板
     *
     * <span class="hljs-doctag">@param</span> modelInfo
     * <span class="hljs-doctag">@param</span> searchStr
     * <span class="hljs-doctag">@param</span> sourceRootPath
     * <span class="hljs-doctag">@param</span> inputFile
     * <span class="hljs-doctag">@return</span>
     */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Meta.FileConfig.FileInfo <span class="hljs-title function_">makeFileTemplate</span><span class="hljs-params">(Meta.ModelConfig.ModelInfo modelInfo, String searchStr, String sourceRootPath, File inputFile)</span> {
        <span class="hljs-comment">// 要挖坑的文件绝对路径（用于制作模板）</span>
        <span class="hljs-comment">// 注意 win 系统需要对路径进行转义</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">fileInputAbsolutePath</span> <span class="hljs-operator">=</span> inputFile.getAbsolutePath().replaceAll(<span class="hljs-string">"\\\\"</span>, <span class="hljs-string">"/"</span>);
        <span class="hljs-type">String</span> <span class="hljs-variable">fileOutputAbsolutePath</span> <span class="hljs-operator">=</span> fileInputAbsolutePath + <span class="hljs-string">".ftl"</span>;
    
        <span class="hljs-comment">// 文件输入输出相对路径（用于生成配置）</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">fileInputPath</span> <span class="hljs-operator">=</span> fileInputAbsolutePath.replace(sourceRootPath + <span class="hljs-string">"/"</span>, <span class="hljs-string">""</span>);
        <span class="hljs-type">String</span> <span class="hljs-variable">fileOutputPath</span> <span class="hljs-operator">=</span> fileInputPath + <span class="hljs-string">".ftl"</span>;
        
        <span class="hljs-comment">// 使用字符串替换，生成模板文件</span>
        String fileContent;
        <span class="hljs-comment">// 如果已有模板文件，说明不是第一次制作，则在模板基础上再次挖坑</span>
        <span class="hljs-keyword">if</span> (FileUtil.exist(fileOutputAbsolutePath)) {
            fileContent = FileUtil.readUtf8String(fileOutputAbsolutePath);
        } <span class="hljs-keyword">else</span> {
            fileContent = FileUtil.readUtf8String(fileInputAbsolutePath);
        }
        <span class="hljs-type">String</span> <span class="hljs-variable">replacement</span> <span class="hljs-operator">=</span> String.format(<span class="hljs-string">"${%s}"</span>, modelInfo.getFieldName());
        <span class="hljs-type">String</span> <span class="hljs-variable">newFileContent</span> <span class="hljs-operator">=</span> StrUtil.replace(fileContent, searchStr, replacement);

        <span class="hljs-comment">// 文件配置信息</span>
        Meta.FileConfig.<span class="hljs-type">FileInfo</span> <span class="hljs-variable">fileInfo</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Meta</span>.FileConfig.FileInfo();
        fileInfo.setInputPath(fileInputPath);
        fileInfo.setOutputPath(fileOutputPath);
        fileInfo.setType(FileTypeEnum.FILE.getValue());

        <span class="hljs-comment">// 和原文件一致，没有挖坑，则为静态生成</span>
        <span class="hljs-keyword">if</span> (newFileContent.equals(fileContent)) {
            <span class="hljs-comment">// 输出路径 = 输入路径</span>
            fileInfo.setOutputPath(fileInputPath);
            fileInfo.setGenerateType(FileGenerateTypeEnum.STATIC.getValue());
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-comment">// 生成模板文件</span>
            fileInfo.setGenerateType(FileGenerateTypeEnum.DYNAMIC.getValue());
            FileUtil.writeUtf8String(newFileContent, fileOutputAbsolutePath);
        }
        <span class="hljs-keyword">return</span> fileInfo;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-type">Meta</span> <span class="hljs-variable">meta</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Meta</span>();
        meta.setName(<span class="hljs-string">"acm-template-generator"</span>);
        meta.setDescription(<span class="hljs-string">"ACM 示例模板生成器"</span>);

        <span class="hljs-type">String</span> <span class="hljs-variable">projectPath</span> <span class="hljs-operator">=</span> System.getProperty(<span class="hljs-string">"user.dir"</span>);
        <span class="hljs-type">String</span> <span class="hljs-variable">originProjectPath</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(projectPath).getParent() + File.separator + <span class="hljs-string">"yuzi-generator-demo-projects/springboot-init"</span>;
        <span class="hljs-type">String</span> <span class="hljs-variable">inputFilePath1</span> <span class="hljs-operator">=</span> <span class="hljs-string">"src/main/java/com/yupi/springbootinit/common"</span>;
        <span class="hljs-type">String</span> <span class="hljs-variable">inputFilePath2</span> <span class="hljs-operator">=</span> <span class="hljs-string">"src/main/java/com/yupi/springbootinit/controller"</span>;
        List&lt;String&gt; inputFilePathList = Arrays.asList(inputFilePath1, inputFilePath2);

        <span class="hljs-comment">// 模型参数信息（首次）</span>
<span class="hljs-comment">//        Meta.ModelConfig.ModelInfo modelInfo = new Meta.ModelConfig.ModelInfo();</span>
<span class="hljs-comment">//        modelInfo.setFieldName("outputText");</span>
<span class="hljs-comment">//        modelInfo.setType("String");</span>
<span class="hljs-comment">//        modelInfo.setDefaultValue("sum = ");</span>

        <span class="hljs-comment">// 模型参数信息（第二次）</span>
        Meta.ModelConfig.<span class="hljs-type">ModelInfo</span> <span class="hljs-variable">modelInfo</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Meta</span>.ModelConfig.ModelInfo();
        modelInfo.setFieldName(<span class="hljs-string">"className"</span>);
        modelInfo.setType(<span class="hljs-string">"String"</span>);

        <span class="hljs-comment">// 替换变量（首次）</span>
<span class="hljs-comment">//        String searchStr = "Sum: ";</span>
        <span class="hljs-comment">// 替换变量（第二次）</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">searchStr</span> <span class="hljs-operator">=</span> <span class="hljs-string">"BaseResponse"</span>;

        <span class="hljs-type">long</span> <span class="hljs-variable">id</span> <span class="hljs-operator">=</span> makeTemplate(meta, originProjectPath, inputFilePathList, modelInfo, searchStr, <span class="hljs-number">1735281524670181376L</span>);
        System.out.println(id);
    }

    <span class="hljs-comment">/**
     * 模型去重
     *
     * <span class="hljs-doctag">@param</span> modelInfoList
     * <span class="hljs-doctag">@return</span>
     */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> List&lt;Meta.ModelConfig.ModelInfo&gt; distinctModels(List&lt;Meta.ModelConfig.ModelInfo&gt; modelInfoList) {
        List&lt;Meta.ModelConfig.ModelInfo&gt; newModelInfoList = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;(modelInfoList.stream().collect(Collectors.toMap(Meta.ModelConfig.ModelInfo::getFieldName, o -&gt; o, (e, r) -&gt; r)).values());
        <span class="hljs-keyword">return</span> newModelInfoList;
    }

    <span class="hljs-comment">/**
     * 文件去重
     *
     * <span class="hljs-doctag">@param</span> fileInfoList
     * <span class="hljs-doctag">@return</span>
     */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> List&lt;Meta.FileConfig.FileInfo&gt; distinctFiles(List&lt;Meta.FileConfig.FileInfo&gt; fileInfoList) {
        List&lt;Meta.FileConfig.FileInfo&gt; newFileInfoList = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;(fileInfoList.stream().collect(Collectors.toMap(Meta.FileConfig.FileInfo::getInputPath, o -&gt; o, (e, r) -&gt; r)).values());
        <span class="hljs-keyword">return</span> newFileInfoList;
    }
}
</code></pre>
<h3 data-id="heading-19">2、文件过滤</h3>
<p>回忆下我们之前梳理的 Spring Boot 模板生成器需要的一个功能：</p>
<blockquote>
<p>需求：控制是否生成帖子相关功能
实现思路：允许用户输入一个开关参数来控制帖子功能相关的文件是否生成，比如 PostController、PostService、PostMapper、PostMapper.xml、Post 实体类等。
通用能力：某个范围下的多个指定文件挖坑 =&gt; 绑定同个参数</p>
</blockquote>
<p>为了实现这个需求，我们要同时对多个名称包含 <code>Post</code> 的文件进行处理。由于这些文件分散在不同的目录中，我们没有办法通过直接指定一个目录完成制作。单次制作时输入多个文件是可行的提效方式，但如果文件数量再多一些，依次去写文件的路径也会成为一种麻烦。</p>
<p>有没有更优雅的方式呢？</p>
<p>答案是肯定的，想想我们平时查找文件时会怎么办？肯定是输入一些关键词来过滤文件对吧。</p>
<p>没错，我们可以给模板制作工具增加 <strong>文件过滤</strong> 功能，通过多种不同的过滤方式帮助用户选择文件，更灵活地完成批量模板制作。</p>
<h4 data-id="heading-20">文件过滤机制设计</h4>
<p>文件过滤可以有很多种不同的配置方式，鱼皮梳理归纳了 2 类配置：</p>
<ul>
<li>过滤范围：根据文件名称、或者文件内容过滤。</li>
<li>过滤规则：包含 contains、前缀匹配 startsWith、后缀匹配 endsWith、正则 regex、相等 equals。</li>
</ul>
<p>由于制作工具已经支持输入多个文件 / 目录，所以其实每个文件 / 目录都可以指定自己的过滤规则，而且能同时指定多条过滤规则（必须同时满足才保留），进一步提高灵活性。</p>
<p>参考文件过滤机制的 JSON 结构如下：</p>
<pre style="position: relative; padding-top: 3em; overflow: auto;"><div class="code-block-extension-header" style="position: absolute; top: 0; left: 0; width: 100%; height:28px; font-size:1em; background-color: rgb(248, 248, 248); box-shadow: 0px 4px 5px -6px #888888; display: flex; justify-content: space-between; align-items: center; padding: 0.5em 1em;"><div class="code-block-extension-headerLeft" style="filter: invert(0.5); opacity: 0.6;"><span class="code-block-extension-lang">json</span></div><div class="code-block-extension-headerRight" style="cursor: pointer;"><div class="code-block-extension-copyCodeBtn" style="filter: invert(0.5); opacity: 0.6;">复制代码</div></div></div><code class="language-json hljs" data-highlighted="yes"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"files"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
    <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"path"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"文件（目录）路径"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"filters"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
        <span class="hljs-punctuation">{</span>
          <span class="hljs-attr">"range"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"fileName"</span><span class="hljs-punctuation">,</span>
          <span class="hljs-attr">"rule"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"regex"</span><span class="hljs-punctuation">,</span>
          <span class="hljs-attr">"value"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">".*lala.*"</span>
        <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
        <span class="hljs-punctuation">{</span>
          <span class="hljs-attr">"range"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"fileContent"</span><span class="hljs-punctuation">,</span>
          <span class="hljs-attr">"rule"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"contains"</span><span class="hljs-punctuation">,</span>
          <span class="hljs-attr">"value"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"haha"</span>
        <span class="hljs-punctuation">}</span>
      <span class="hljs-punctuation">]</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>上面的 JSON 表示：该文件的名称必须符合正则并且内容必须包含 <code>haha</code>。</p>
<p>通过这种设计，可以非常灵活地筛选文件。如果想使用 or 逻辑（有一个过滤条件符合要求就保留），可以定义多个重复的 file，并且每个 file 指定一个过滤条件来实现。哪怕同时满足了多个过滤器，我们的去重逻辑也能搞定。</p>
<h4 data-id="heading-21">开发实现</h4>
<p>1）设计好了机制后，我们可以编写对应的配置类。</p>
<p>在 <code>template.model</code> 包下新建 <code>FileFilterConfig</code> 类，对应上面设计好的 JSON 结构。</p>
<p>代码如下：</p>
<pre style="position: relative; padding-top: 3em; overflow: auto;"><div class="code-block-extension-header" style="position: absolute; top: 0; left: 0; width: 100%; height:28px; font-size:1em; background-color: rgb(248, 248, 248); box-shadow: 0px 4px 5px -6px #888888; display: flex; justify-content: space-between; align-items: center; padding: 0.5em 1em;"><div class="code-block-extension-headerLeft" style="filter: invert(0.5); opacity: 0.6;"><span class="code-block-extension-lang">java</span></div><div class="code-block-extension-headerRight" style="cursor: pointer;"><div class="code-block-extension-copyCodeBtn" style="filter: invert(0.5); opacity: 0.6;">复制代码</div></div></div><code class="language-java hljs" data-highlighted="yes"><span class="hljs-keyword">package</span> com.yupi.maker.template.model;

<span class="hljs-keyword">import</span> lombok.Builder;
<span class="hljs-keyword">import</span> lombok.Data;

<span class="hljs-comment">/**
 * 文件过滤配置
 */</span>
<span class="hljs-meta">@Data</span>
<span class="hljs-meta">@Builder</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FileFilterConfig</span> {

    <span class="hljs-comment">/**
     * 过滤范围
     */</span>
    <span class="hljs-keyword">private</span> String range;

    <span class="hljs-comment">/**
     * 过滤规则
     */</span>
    <span class="hljs-keyword">private</span> String rule;

    <span class="hljs-comment">/**
     * 过滤值
     */</span>
    <span class="hljs-keyword">private</span> String value;

}
</code></pre>
<p>在 <code>template.model</code> 包下新建 <code>TemplateMakerFileConfig</code> 类，用来封装所有和文件相关的配置。</p>
<p>代码如下：</p>
<pre style="position: relative; padding-top: 3em; overflow: auto;"><div class="code-block-extension-header" style="position: absolute; top: 0; left: 0; width: 100%; height:28px; font-size:1em; background-color: rgb(248, 248, 248); box-shadow: 0px 4px 5px -6px #888888; display: flex; justify-content: space-between; align-items: center; padding: 0.5em 1em;"><div class="code-block-extension-headerLeft" style="filter: invert(0.5); opacity: 0.6;"><span class="code-block-extension-lang">java</span></div><div class="code-block-extension-headerRight" style="cursor: pointer;"><div class="code-block-extension-copyCodeBtn" style="filter: invert(0.5); opacity: 0.6;">复制代码</div></div></div><code class="language-java hljs" data-highlighted="yes"><span class="hljs-keyword">package</span> com.yupi.maker.template.model;

<span class="hljs-keyword">import</span> lombok.Data;
<span class="hljs-keyword">import</span> lombok.NoArgsConstructor;

<span class="hljs-keyword">import</span> java.util.List;

<span class="hljs-meta">@Data</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TemplateMakerFileConfig</span> {

    <span class="hljs-keyword">private</span> List&lt;FileInfoConfig&gt; files;

    <span class="hljs-meta">@NoArgsConstructor</span>
    <span class="hljs-meta">@Data</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FileInfoConfig</span> {

        <span class="hljs-keyword">private</span> String path;

        <span class="hljs-keyword">private</span> List&lt;FileFilterConfig&gt; filterConfigList;
    }
}
</code></pre>
<p>2）针对过滤配置中的枚举值，编写对应的枚举类</p>
<p>在 <code>template.enums</code> 包下新建 <code>FileFilterRangeEnum</code> 枚举类，表示文件过滤范围枚举。需要提供根据 value 获取枚举的方法，便于根据字符串获取对应的枚举。</p>
<p>代码如下：</p>
<pre style="position: relative; padding-top: 3em; overflow: auto;"><div class="code-block-extension-header" style="position: absolute; top: 0; left: 0; width: 100%; height:28px; font-size:1em; background-color: rgb(248, 248, 248); box-shadow: 0px 4px 5px -6px #888888; display: flex; justify-content: space-between; align-items: center; padding: 0.5em 1em;"><div class="code-block-extension-headerLeft" style="filter: invert(0.5); opacity: 0.6;"><span class="code-block-extension-lang">java</span></div><div class="code-block-extension-headerRight" style="cursor: pointer;"><div class="code-block-extension-copyCodeBtn" style="filter: invert(0.5); opacity: 0.6;">复制代码</div></div></div><code class="language-java hljs" data-highlighted="yes"><span class="hljs-keyword">package</span> com.yupi.maker.template.enums;

<span class="hljs-keyword">import</span> cn.hutool.core.util.ObjectUtil;
<span class="hljs-keyword">import</span> lombok.Getter;

<span class="hljs-comment">/**
 * 文件过滤范围枚举
 */</span>
<span class="hljs-meta">@Getter</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">enum</span> <span class="hljs-title class_">FileFilterRangeEnum</span> {

    FILE_NAME(<span class="hljs-string">"文件名称"</span>, <span class="hljs-string">"fileName"</span>),
    FILE_CONTENT(<span class="hljs-string">"文件内容"</span>, <span class="hljs-string">"fileContent"</span>);

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String text;

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String value;

    FileFilterRangeEnum(String text, String value) {
        <span class="hljs-built_in">this</span>.text = text;
        <span class="hljs-built_in">this</span>.value = value;
    }

    <span class="hljs-comment">/**
     * 根据 value 获取枚举
     *
     * <span class="hljs-doctag">@param</span> value
     * <span class="hljs-doctag">@return</span>
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> FileFilterRangeEnum <span class="hljs-title function_">getEnumByValue</span><span class="hljs-params">(String value)</span> {
        <span class="hljs-keyword">if</span> (ObjectUtil.isEmpty(value)) {
            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
        }
        <span class="hljs-keyword">for</span> (FileFilterRangeEnum anEnum : FileFilterRangeEnum.values()) {
            <span class="hljs-keyword">if</span> (anEnum.value.equals(value)) {
                <span class="hljs-keyword">return</span> anEnum;
            }
        }
        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
    }
}
</code></pre>
<p>在 <code>template.enums</code> 包下再新建 <code>FileFilterRuleEnum</code> 枚举类，表示文件过滤规则枚举。</p>
<p>代码如下：</p>
<pre style="position: relative; padding-top: 3em; overflow: auto;"><div class="code-block-extension-header" style="position: absolute; top: 0; left: 0; width: 100%; height:28px; font-size:1em; background-color: rgb(248, 248, 248); box-shadow: 0px 4px 5px -6px #888888; display: flex; justify-content: space-between; align-items: center; padding: 0.5em 1em;"><div class="code-block-extension-headerLeft" style="filter: invert(0.5); opacity: 0.6;"><span class="code-block-extension-lang">java</span></div><div class="code-block-extension-headerRight" style="cursor: pointer;"><div class="code-block-extension-copyCodeBtn" style="filter: invert(0.5); opacity: 0.6;">复制代码</div></div></div><code class="language-java hljs" data-highlighted="yes"><span class="hljs-keyword">package</span> com.yupi.maker.template.enums;

<span class="hljs-keyword">import</span> cn.hutool.core.util.ObjectUtil;
<span class="hljs-keyword">import</span> lombok.Getter;

<span class="hljs-comment">/**
 * 文件过滤规则枚举
 */</span>
<span class="hljs-meta">@Getter</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">enum</span> <span class="hljs-title class_">FileFilterRuleEnum</span> {

    CONTAINS(<span class="hljs-string">"包含"</span>, <span class="hljs-string">"contains"</span>),
    STARTS_WITH(<span class="hljs-string">"前缀匹配"</span>, <span class="hljs-string">"startsWith"</span>),
    ENDS_WITH(<span class="hljs-string">"后缀匹配"</span>, <span class="hljs-string">"endsWith"</span>),
    REGEX(<span class="hljs-string">"正则"</span>, <span class="hljs-string">"regex"</span>),
    EQUALS(<span class="hljs-string">"相等"</span>, <span class="hljs-string">"equals"</span>);

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String text;

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String value;

    FileFilterRuleEnum(String text, String value) {
        <span class="hljs-built_in">this</span>.text = text;
        <span class="hljs-built_in">this</span>.value = value;
    }

    <span class="hljs-comment">/**
     * 根据 value 获取枚举
     *
     * <span class="hljs-doctag">@param</span> value
     * <span class="hljs-doctag">@return</span>
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> FileFilterRuleEnum <span class="hljs-title function_">getEnumByValue</span><span class="hljs-params">(String value)</span> {
        <span class="hljs-keyword">if</span> (ObjectUtil.isEmpty(value)) {
            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
        }
        <span class="hljs-keyword">for</span> (FileFilterRuleEnum anEnum : FileFilterRuleEnum.values()) {
            <span class="hljs-keyword">if</span> (anEnum.value.equals(value)) {
                <span class="hljs-keyword">return</span> anEnum;
            }
        }
        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
    }
}
</code></pre>
<p>3）有了配置类后，我们来开发文件过滤功能</p>
<p>在 <code>template</code> 包下新建 <code>FileFilter</code> 类，首先开发针对单个文件过滤的方法 <code>doSingleFileFilter</code>。实现思路是遍历传入的文件过滤配置列表，并按照规则进行校验，如果有一个过滤配置不满足，就返回 false 表示不保留该文件，反之为 true 表示通过所有校验。</p>
<p>代码如下：</p>
<pre style="position: relative; padding-top: 3em; overflow: auto;"><div class="code-block-extension-header" style="position: absolute; top: 0; left: 0; width: 100%; height:28px; font-size:1em; background-color: rgb(248, 248, 248); box-shadow: 0px 4px 5px -6px #888888; display: flex; justify-content: space-between; align-items: center; padding: 0.5em 1em;"><div class="code-block-extension-headerLeft" style="filter: invert(0.5); opacity: 0.6;"><span class="code-block-extension-lang">java</span></div><div class="code-block-extension-headerRight" style="cursor: pointer;"><div class="code-block-extension-copyCodeBtn" style="filter: invert(0.5); opacity: 0.6;">复制代码</div></div></div><code class="language-java hljs" data-highlighted="yes"><span class="hljs-comment">/**
 * 单个文件过滤
 *
 * <span class="hljs-doctag">@param</span> fileFilterConfigList 过滤规则
 * <span class="hljs-doctag">@param</span> file 单个文件
 * <span class="hljs-doctag">@return</span> 是否保留
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">doSingleFileFilter</span><span class="hljs-params">(List&lt;FileFilterConfig&gt; fileFilterConfigList, File file)</span> {
    <span class="hljs-type">String</span> <span class="hljs-variable">fileName</span> <span class="hljs-operator">=</span> file.getName();
    <span class="hljs-type">String</span> <span class="hljs-variable">fileContent</span> <span class="hljs-operator">=</span> FileUtil.readUtf8String(file);

    <span class="hljs-comment">// 所有过滤器校验结束的结果</span>
    <span class="hljs-type">boolean</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> <span class="hljs-literal">true</span>;

    <span class="hljs-keyword">if</span> (CollUtil.isEmpty(fileFilterConfigList)) {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    }

    <span class="hljs-keyword">for</span> (FileFilterConfig fileFilterConfig : fileFilterConfigList) {
        <span class="hljs-type">String</span> <span class="hljs-variable">range</span> <span class="hljs-operator">=</span> fileFilterConfig.getRange();
        <span class="hljs-type">String</span> <span class="hljs-variable">rule</span> <span class="hljs-operator">=</span> fileFilterConfig.getRule();
        <span class="hljs-type">String</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> fileFilterConfig.getValue();

        <span class="hljs-type">FileFilterRangeEnum</span> <span class="hljs-variable">fileFilterRangeEnum</span> <span class="hljs-operator">=</span> FileFilterRangeEnum.getEnumByValue(range);
        <span class="hljs-keyword">if</span> (fileFilterRangeEnum == <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">continue</span>;
        }

        <span class="hljs-comment">// 要过滤的原内容</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">content</span> <span class="hljs-operator">=</span> fileName;
        <span class="hljs-keyword">switch</span> (fileFilterRangeEnum) {
            <span class="hljs-keyword">case</span> FILE_NAME:
                content = fileName;
                <span class="hljs-keyword">break</span>;
            <span class="hljs-keyword">case</span> FILE_CONTENT:
                content = fileContent;
                <span class="hljs-keyword">break</span>;
            <span class="hljs-keyword">default</span>:
        }

        <span class="hljs-type">FileFilterRuleEnum</span> <span class="hljs-variable">filterRuleEnum</span> <span class="hljs-operator">=</span> FileFilterRuleEnum.getEnumByValue(rule);
        <span class="hljs-keyword">if</span> (filterRuleEnum == <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">continue</span>;
        }
        <span class="hljs-keyword">switch</span> (filterRuleEnum) {
            <span class="hljs-keyword">case</span> CONTAINS:
                result = content.contains(value);
                <span class="hljs-keyword">break</span>;
            <span class="hljs-keyword">case</span> STARTS_WITH:
                result = content.startsWith(value);
                <span class="hljs-keyword">break</span>;
            <span class="hljs-keyword">case</span> ENDS_WITH:
                result = content.endsWith(value);
                <span class="hljs-keyword">break</span>;
            <span class="hljs-keyword">case</span> REGEX:
                result = content.matches(value);
                <span class="hljs-keyword">break</span>;
            <span class="hljs-keyword">case</span> EQUALS:
                result = content.equals(value);
                <span class="hljs-keyword">break</span>;
            <span class="hljs-keyword">default</span>:
        }

        <span class="hljs-comment">// 有一个不满足，就直接返回</span>
        <span class="hljs-keyword">if</span> (!result) {
            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
        }
    }

    <span class="hljs-comment">// 都满足</span>
    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
}
</code></pre>
<p>然后编写过滤器的主方法 <code>doFilter</code>，方法接受 <code>filePath</code> 文件路径参数，支持传入文件或目录，能够同时对多个文件进行过滤。</p>
<p>实现思路很简单，通过 Hutool 的 <code>FileUtil.loopFiles</code> 获取到所有文件列表，再依次调用过滤单个文件的方法即可。</p>
<blockquote>
<p>即使传入的是单个文件，也能通过该方法获取到列表，保持一致</p>
</blockquote>
<p>代码如下：</p>
<pre style="position: relative; padding-top: 3em; overflow: auto;"><div class="code-block-extension-header" style="position: absolute; top: 0; left: 0; width: 100%; height:28px; font-size:1em; background-color: rgb(248, 248, 248); box-shadow: 0px 4px 5px -6px #888888; display: flex; justify-content: space-between; align-items: center; padding: 0.5em 1em;"><div class="code-block-extension-headerLeft" style="filter: invert(0.5); opacity: 0.6;"><span class="code-block-extension-lang">java</span></div><div class="code-block-extension-headerRight" style="cursor: pointer;"><div class="code-block-extension-copyCodeBtn" style="filter: invert(0.5); opacity: 0.6;">复制代码</div></div></div><code class="language-java hljs" data-highlighted="yes"><span class="hljs-comment">/**
 * 对某个文件或目录进行过滤，返回文件列表
 *
 * <span class="hljs-doctag">@param</span> filePath
 * <span class="hljs-doctag">@param</span> fileFilterConfigList
 * <span class="hljs-doctag">@return</span>
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> List&lt;File&gt; <span class="hljs-title function_">doFilter</span><span class="hljs-params">(String filePath, List&lt;FileFilterConfig&gt; fileFilterConfigList)</span> {
    <span class="hljs-comment">// 根据路径获取所有文件</span>
    List&lt;File&gt; fileList = FileUtil.loopFiles(filePath);
    <span class="hljs-keyword">return</span> fileList.stream()
            .filter(file -&gt; doSingleFileFilter(fileFilterConfigList, file))
            .collect(Collectors.toList());
}
</code></pre>
<p><code>FileFilter</code> 的完整代码如下：</p>
<pre style="position: relative; padding-top: 3em; overflow: auto;"><div class="code-block-extension-header" style="position: absolute; top: 0; left: 0; width: 100%; height:28px; font-size:1em; background-color: rgb(248, 248, 248); box-shadow: 0px 4px 5px -6px #888888; display: flex; justify-content: space-between; align-items: center; padding: 0.5em 1em;"><div class="code-block-extension-headerLeft" style="filter: invert(0.5); opacity: 0.6;"><span class="code-block-extension-lang">java</span></div><div class="code-block-extension-headerRight" style="cursor: pointer;"><div class="code-block-extension-copyCodeBtn" style="filter: invert(0.5); opacity: 0.6;">复制代码</div></div></div><code class="language-java hljs" data-highlighted="yes"><span class="hljs-keyword">package</span> com.yupi.maker.template;

<span class="hljs-keyword">import</span> cn.hutool.core.collection.CollUtil;
<span class="hljs-keyword">import</span> cn.hutool.core.io.FileUtil;
<span class="hljs-keyword">import</span> com.yupi.maker.template.enums.FileFilterRangeEnum;
<span class="hljs-keyword">import</span> com.yupi.maker.template.enums.FileFilterRuleEnum;
<span class="hljs-keyword">import</span> com.yupi.maker.template.model.FileFilterConfig;

<span class="hljs-keyword">import</span> java.io.File;
<span class="hljs-keyword">import</span> java.util.List;
<span class="hljs-keyword">import</span> java.util.stream.Collectors;

<span class="hljs-comment">/**
 * 文件过滤器
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FileFilter</span> {

    <span class="hljs-comment">/**
     * 对某个文件或目录进行过滤，返回文件列表
     *
     * <span class="hljs-doctag">@param</span> filePath
     * <span class="hljs-doctag">@param</span> fileFilterConfigList
     * <span class="hljs-doctag">@return</span>
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> List&lt;File&gt; <span class="hljs-title function_">doFilter</span><span class="hljs-params">(String filePath, List&lt;FileFilterConfig&gt; fileFilterConfigList)</span> {
        <span class="hljs-comment">// 根据路径获取所有文件</span>
        List&lt;File&gt; fileList = FileUtil.loopFiles(filePath);
        <span class="hljs-keyword">return</span> fileList.stream()
                .filter(file -&gt; doSingleFileFilter(fileFilterConfigList, file))
                .collect(Collectors.toList());
    }

    <span class="hljs-comment">/**
     * 单个文件过滤
     *
     * <span class="hljs-doctag">@param</span> fileFilterConfigList 过滤规则
     * <span class="hljs-doctag">@param</span> file 单个文件
     * <span class="hljs-doctag">@return</span> 是否保留
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">doSingleFileFilter</span><span class="hljs-params">(List&lt;FileFilterConfig&gt; fileFilterConfigList, File file)</span> {
        <span class="hljs-type">String</span> <span class="hljs-variable">fileName</span> <span class="hljs-operator">=</span> file.getName();
        <span class="hljs-type">String</span> <span class="hljs-variable">fileContent</span> <span class="hljs-operator">=</span> FileUtil.readUtf8String(file);

        <span class="hljs-comment">// 所有过滤器校验结束的结果</span>
        <span class="hljs-type">boolean</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> <span class="hljs-literal">true</span>;

        <span class="hljs-keyword">if</span> (CollUtil.isEmpty(fileFilterConfigList)) {
            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
        }

        <span class="hljs-keyword">for</span> (FileFilterConfig fileFilterConfig : fileFilterConfigList) {
            <span class="hljs-type">String</span> <span class="hljs-variable">range</span> <span class="hljs-operator">=</span> fileFilterConfig.getRange();
            <span class="hljs-type">String</span> <span class="hljs-variable">rule</span> <span class="hljs-operator">=</span> fileFilterConfig.getRule();
            <span class="hljs-type">String</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> fileFilterConfig.getValue();

            <span class="hljs-type">FileFilterRangeEnum</span> <span class="hljs-variable">fileFilterRangeEnum</span> <span class="hljs-operator">=</span> FileFilterRangeEnum.getEnumByValue(range);
            <span class="hljs-keyword">if</span> (fileFilterRangeEnum == <span class="hljs-literal">null</span>) {
                <span class="hljs-keyword">continue</span>;
            }

            <span class="hljs-comment">// 要过滤的原内容</span>
            <span class="hljs-type">String</span> <span class="hljs-variable">content</span> <span class="hljs-operator">=</span> fileName;
            <span class="hljs-keyword">switch</span> (fileFilterRangeEnum) {
                <span class="hljs-keyword">case</span> FILE_NAME:
                    content = fileName;
                    <span class="hljs-keyword">break</span>;
                <span class="hljs-keyword">case</span> FILE_CONTENT:
                    content = fileContent;
                    <span class="hljs-keyword">break</span>;
                <span class="hljs-keyword">default</span>:
            }

            <span class="hljs-type">FileFilterRuleEnum</span> <span class="hljs-variable">filterRuleEnum</span> <span class="hljs-operator">=</span> FileFilterRuleEnum.getEnumByValue(rule);
            <span class="hljs-keyword">if</span> (filterRuleEnum == <span class="hljs-literal">null</span>) {
                <span class="hljs-keyword">continue</span>;
            }
            <span class="hljs-keyword">switch</span> (filterRuleEnum) {
                <span class="hljs-keyword">case</span> CONTAINS:
                    result = content.contains(value);
                    <span class="hljs-keyword">break</span>;
                <span class="hljs-keyword">case</span> STARTS_WITH:
                    result = content.startsWith(value);
                    <span class="hljs-keyword">break</span>;
                <span class="hljs-keyword">case</span> ENDS_WITH:
                    result = content.endsWith(value);
                    <span class="hljs-keyword">break</span>;
                <span class="hljs-keyword">case</span> REGEX:
                    result = content.matches(value);
                    <span class="hljs-keyword">break</span>;
                <span class="hljs-keyword">case</span> EQUALS:
                    result = content.equals(value);
                    <span class="hljs-keyword">break</span>;
                <span class="hljs-keyword">default</span>:
            }

            <span class="hljs-comment">// 有一个不满足，就直接返回</span>
            <span class="hljs-keyword">if</span> (!result) {
                <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
            }
        }

        <span class="hljs-comment">// 都满足</span>
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    }
}

</code></pre>
<p>4）模板制作工具类使用过滤器</p>
<p>将 <code>makeTemplate</code> 方法接受的 <code>inputFilePathList</code> 参数改为我们新封装的 <code>TemplateMakerFileConfig</code> 类，相当于同时传入了文件列表和过滤规则。</p>
<pre style="position: relative; padding-top: 3em; overflow: auto;"><div class="code-block-extension-header" style="position: absolute; top: 0; left: 0; width: 100%; height:28px; font-size:1em; background-color: rgb(248, 248, 248); box-shadow: 0px 4px 5px -6px #888888; display: flex; justify-content: space-between; align-items: center; padding: 0.5em 1em;"><div class="code-block-extension-headerLeft" style="filter: invert(0.5); opacity: 0.6;"><span class="code-block-extension-lang">java</span></div><div class="code-block-extension-headerRight" style="cursor: pointer;"><div class="code-block-extension-copyCodeBtn" style="filter: invert(0.5); opacity: 0.6;">复制代码</div></div></div><code class="language-java hljs" data-highlighted="yes"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">long</span> <span class="hljs-title function_">makeTemplate</span><span class="hljs-params">(Meta newMeta, 
                                String originProjectPath,
                                TemplateMakerFileConfig templateMakerFileConfig,
                                Meta.ModelConfig.ModelInfo modelInfo,
                                String searchStr,
                                Long id)</span> {}
</code></pre>
<p>然后修改遍历输入文件的代码，改为遍历 <code>fileConfigInfoList</code> 获取文件信息：</p>
<pre style="position: relative; padding-top: 3em; overflow: auto;"><div class="code-block-extension-header" style="position: absolute; top: 0; left: 0; width: 100%; height:28px; font-size:1em; background-color: rgb(248, 248, 248); box-shadow: 0px 4px 5px -6px #888888; display: flex; justify-content: space-between; align-items: center; padding: 0.5em 1em;"><div class="code-block-extension-headerLeft" style="filter: invert(0.5); opacity: 0.6;"><span class="code-block-extension-lang">java</span></div><div class="code-block-extension-headerRight" style="cursor: pointer;"><div class="code-block-extension-copyCodeBtn" style="filter: invert(0.5); opacity: 0.6;">复制代码</div></div></div><code class="language-java hljs" data-highlighted="yes"><span class="hljs-comment">// 输入文件信息</span>
<span class="hljs-type">String</span> <span class="hljs-variable">sourceRootPath</span> <span class="hljs-operator">=</span> templatePath + File.separator + FileUtil.getLastPathEle(Paths.get(originProjectPath)).toString();
<span class="hljs-comment">// 注意 win 系统需要对路径进行转义</span>
sourceRootPath = sourceRootPath.replaceAll(<span class="hljs-string">"\\\\"</span>, <span class="hljs-string">"/"</span>);
List&lt;TemplateMakerFileConfig.FileInfoConfig&gt; fileConfigInfoList = templateMakerFileConfig.getFiles();

<span class="hljs-comment">// 二、生成文件模板</span>
<span class="hljs-comment">// 遍历输入文件</span>
List&lt;Meta.FileConfig.FileInfo&gt; newFileInfoList = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();
<span class="hljs-keyword">for</span> (TemplateMakerFileConfig.FileInfoConfig fileInfoConfig : fileConfigInfoList) {
    <span class="hljs-type">String</span> <span class="hljs-variable">inputFilePath</span> <span class="hljs-operator">=</span> fileInfoConfig.getPath();
    <span class="hljs-type">String</span> <span class="hljs-variable">inputFileAbsolutePath</span> <span class="hljs-operator">=</span> sourceRootPath + File.separator + inputFilePath;
    <span class="hljs-comment">// 输入的是目录</span>
    <span class="hljs-keyword">if</span> (FileUtil.isDirectory(inputFileAbsolutePath)) {
        List&lt;File&gt; fileList = FileUtil.loopFiles(inputFileAbsolutePath);
        <span class="hljs-keyword">for</span> (File file : fileList) {
            Meta.FileConfig.<span class="hljs-type">FileInfo</span> <span class="hljs-variable">fileInfo</span> <span class="hljs-operator">=</span> makeFileTemplate(modelInfo, searchStr, sourceRootPath, file);
            newFileInfoList.add(fileInfo);
        }
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-comment">// 输入的是文件</span>
        Meta.FileConfig.<span class="hljs-type">FileInfo</span> <span class="hljs-variable">fileInfo</span> <span class="hljs-operator">=</span> makeFileTemplate(modelInfo, searchStr, sourceRootPath, <span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(inputFileAbsolutePath));
        newFileInfoList.add(fileInfo);
    }
}
</code></pre>
<p>应用过滤器。将文件信息配置中的 <strong>相对路径转化为绝对路径</strong> 作为调用过滤器的参数，并通过过滤器获取到所有文件列表（注意，这里不可能是目录），再遍历文件列表来制作模板。</p>
<p>修改生成文件模板的部分代码，如下：</p>
<pre style="position: relative; padding-top: 3em; overflow: auto;"><div class="code-block-extension-header" style="position: absolute; top: 0; left: 0; width: 100%; height:28px; font-size:1em; background-color: rgb(248, 248, 248); box-shadow: 0px 4px 5px -6px #888888; display: flex; justify-content: space-between; align-items: center; padding: 0.5em 1em;"><div class="code-block-extension-headerLeft" style="filter: invert(0.5); opacity: 0.6;"><span class="code-block-extension-lang">java</span></div><div class="code-block-extension-headerRight" style="cursor: pointer;"><div class="code-block-extension-copyCodeBtn" style="filter: invert(0.5); opacity: 0.6;">复制代码</div></div></div><code class="language-java hljs" data-highlighted="yes"><span class="hljs-comment">// 二、生成文件模板</span>
<span class="hljs-comment">// 遍历输入文件</span>
List&lt;Meta.FileConfig.FileInfo&gt; newFileInfoList = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();
<span class="hljs-keyword">for</span> (TemplateMakerFileConfig.FileInfoConfig fileInfoConfig : fileConfigInfoList) {
    <span class="hljs-type">String</span> <span class="hljs-variable">inputFilePath</span> <span class="hljs-operator">=</span> fileInfoConfig.getPath();

    <span class="hljs-comment">// 如果填的是相对路径，要改为绝对路径</span>
    <span class="hljs-keyword">if</span> (!inputFilePath.startsWith(sourceRootPath)) {
        inputFilePath = sourceRootPath + File.separator + inputFilePath;
    }

    <span class="hljs-comment">// 获取过滤后的文件列表（不会存在目录）</span>
    List&lt;File&gt; fileList = FileFilter.doFilter(inputFilePath, fileInfoConfig.getFilterConfigList());
    <span class="hljs-keyword">for</span> (File file : fileList) {
        Meta.FileConfig.<span class="hljs-type">FileInfo</span> <span class="hljs-variable">fileInfo</span> <span class="hljs-operator">=</span> makeFileTemplate(modelInfo, searchStr, sourceRootPath, file);
        newFileInfoList.add(fileInfo);
    }
}
</code></pre>
<p>5）在 main 方法中编写文件过滤测试代码，只处理 common 包下文件名称包含 <code>Base</code> 的文件和 controller 包下的文件。</p>
<p>在 main 方法的最后追加代码，如下：</p>
<pre style="position: relative; padding-top: 3em; overflow: auto;"><div class="code-block-extension-header" style="position: absolute; top: 0; left: 0; width: 100%; height:28px; font-size:1em; background-color: rgb(248, 248, 248); box-shadow: 0px 4px 5px -6px #888888; display: flex; justify-content: space-between; align-items: center; padding: 0.5em 1em;"><div class="code-block-extension-headerLeft" style="filter: invert(0.5); opacity: 0.6;"><span class="code-block-extension-lang">java</span></div><div class="code-block-extension-headerRight" style="cursor: pointer;"><div class="code-block-extension-copyCodeBtn" style="filter: invert(0.5); opacity: 0.6;">复制代码</div></div></div><code class="language-java hljs" data-highlighted="yes"><span class="hljs-comment">// 文件过滤</span>
<span class="hljs-type">TemplateMakerFileConfig</span> <span class="hljs-variable">templateMakerFileConfig</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TemplateMakerFileConfig</span>();
TemplateMakerFileConfig.<span class="hljs-type">FileInfoConfig</span> <span class="hljs-variable">fileInfoConfig1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TemplateMakerFileConfig</span>.FileInfoConfig();
fileInfoConfig1.setPath(inputFilePath1);
List&lt;FileFilterConfig&gt; fileFilterConfigList = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();
<span class="hljs-type">FileFilterConfig</span> <span class="hljs-variable">fileFilterConfig</span> <span class="hljs-operator">=</span> FileFilterConfig.builder()
        .range(FileFilterRangeEnum.FILE_NAME.getValue())
        .rule(FileFilterRuleEnum.CONTAINS.getValue())
        .value(<span class="hljs-string">"Base"</span>)
        .build();
fileFilterConfigList.add(fileFilterConfig);
fileInfoConfig1.setFilterConfigList(fileFilterConfigList);

TemplateMakerFileConfig.<span class="hljs-type">FileInfoConfig</span> <span class="hljs-variable">fileInfoConfig2</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TemplateMakerFileConfig</span>.FileInfoConfig();
fileInfoConfig2.setPath(inputFilePath2);
templateMakerFileConfig.setFiles(Arrays.asList(fileInfoConfig1, fileInfoConfig2));

<span class="hljs-type">long</span> <span class="hljs-variable">id</span> <span class="hljs-operator">=</span> makeTemplate(meta, originProjectPath, templateMakerFileConfig, modelInfo, searchStr, <span class="hljs-number">1735281524670181376L</span>);
System.out.println(id);
</code></pre>
<p>执行测试，只有 <code>BaseResponse.java</code> 生成了模板文件，符合预期：</p>
<p><img src="https://pic.code-nav.cn/post_picture/1610518142000300034/7357679f-e53f-41c6-b3b7-b785511e1778.png" alt="image.png" class="medium-zoom-image"></p>
<p>生成的元信息配置也没有多余的文件：</p>
<p><img src="https://pic.code-nav.cn/post_picture/1610518142000300034/55fc3580-e5aa-4f25-b1d4-c9ccf41e760c.png" alt="image.png" class="medium-zoom-image"></p>
<h4 data-id="heading-22">完整代码</h4>
<p><code>TemplateMaker</code> 的完整代码如下：</p>
<pre style="position: relative; padding-top: 3em; overflow: auto;"><div class="code-block-extension-header" style="position: absolute; top: 0; left: 0; width: 100%; height:28px; font-size:1em; background-color: rgb(248, 248, 248); box-shadow: 0px 4px 5px -6px #888888; display: flex; justify-content: space-between; align-items: center; padding: 0.5em 1em;"><div class="code-block-extension-headerLeft" style="filter: invert(0.5); opacity: 0.6;"><span class="code-block-extension-lang">java</span></div><div class="code-block-extension-headerRight" style="cursor: pointer;"><div class="code-block-extension-copyCodeBtn" style="filter: invert(0.5); opacity: 0.6;">复制代码</div></div></div><code class="language-java hljs" data-highlighted="yes"><span class="hljs-keyword">package</span> com.yupi.maker.template;

<span class="hljs-keyword">import</span> cn.hutool.core.bean.BeanUtil;
<span class="hljs-keyword">import</span> cn.hutool.core.bean.copier.CopyOptions;
<span class="hljs-keyword">import</span> cn.hutool.core.io.FileUtil;
<span class="hljs-keyword">import</span> cn.hutool.core.util.IdUtil;
<span class="hljs-keyword">import</span> cn.hutool.core.util.StrUtil;
<span class="hljs-keyword">import</span> cn.hutool.json.JSONUtil;
<span class="hljs-keyword">import</span> com.yupi.maker.meta.Meta;
<span class="hljs-keyword">import</span> com.yupi.maker.meta.enums.FileGenerateTypeEnum;
<span class="hljs-keyword">import</span> com.yupi.maker.meta.enums.FileTypeEnum;
<span class="hljs-keyword">import</span> com.yupi.maker.template.enums.FileFilterRangeEnum;
<span class="hljs-keyword">import</span> com.yupi.maker.template.enums.FileFilterRuleEnum;
<span class="hljs-keyword">import</span> com.yupi.maker.template.model.FileFilterConfig;
<span class="hljs-keyword">import</span> com.yupi.maker.template.model.TemplateMakerFileConfig;

<span class="hljs-keyword">import</span> java.io.File;
<span class="hljs-keyword">import</span> java.nio.file.Paths;
<span class="hljs-keyword">import</span> java.util.ArrayList;
<span class="hljs-keyword">import</span> java.util.Arrays;
<span class="hljs-keyword">import</span> java.util.List;
<span class="hljs-keyword">import</span> java.util.stream.Collectors;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TemplateMaker</span> {

    <span class="hljs-comment">/**
     * 制作模板
     *
     * <span class="hljs-doctag">@param</span> newMeta
     * <span class="hljs-doctag">@param</span> originProjectPath
     * <span class="hljs-doctag">@param</span> templateMakerFileConfig
     * <span class="hljs-doctag">@param</span> modelInfo
     * <span class="hljs-doctag">@param</span> searchStr
     * <span class="hljs-doctag">@param</span> id
     * <span class="hljs-doctag">@return</span>
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">long</span> <span class="hljs-title function_">makeTemplate</span><span class="hljs-params">(Meta newMeta, String originProjectPath, TemplateMakerFileConfig templateMakerFileConfig, Meta.ModelConfig.ModelInfo modelInfo, String searchStr, Long id)</span> {
        <span class="hljs-comment">// 没有 id 则生成</span>
        <span class="hljs-keyword">if</span> (id == <span class="hljs-literal">null</span>) {
            id = IdUtil.getSnowflakeNextId();
        }

        <span class="hljs-comment">// 复制目录</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">projectPath</span> <span class="hljs-operator">=</span> System.getProperty(<span class="hljs-string">"user.dir"</span>);
        <span class="hljs-type">String</span> <span class="hljs-variable">tempDirPath</span> <span class="hljs-operator">=</span> projectPath + File.separator + <span class="hljs-string">".temp"</span>;
        <span class="hljs-type">String</span> <span class="hljs-variable">templatePath</span> <span class="hljs-operator">=</span> tempDirPath + File.separator + id;

        <span class="hljs-comment">// 是否为首次制作模板</span>
        <span class="hljs-comment">// 目录不存在，则是首次制作</span>
        <span class="hljs-keyword">if</span> (!FileUtil.exist(templatePath)) {
            FileUtil.mkdir(templatePath);
            FileUtil.copy(originProjectPath, templatePath, <span class="hljs-literal">true</span>);
        }

        <span class="hljs-comment">// 一、输入信息</span>
        <span class="hljs-comment">// 输入文件信息</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">sourceRootPath</span> <span class="hljs-operator">=</span> templatePath + File.separator + FileUtil.getLastPathEle(Paths.get(originProjectPath)).toString();
        <span class="hljs-comment">// 注意 win 系统需要对路径进行转义</span>
		sourceRootPath = sourceRootPath.replaceAll(<span class="hljs-string">"\\\\"</span>, <span class="hljs-string">"/"</span>);
        List&lt;TemplateMakerFileConfig.FileInfoConfig&gt; fileConfigInfoList = templateMakerFileConfig.getFiles();

        <span class="hljs-comment">// 二、生成文件模板</span>
        <span class="hljs-comment">// 遍历输入文件</span>
        List&lt;Meta.FileConfig.FileInfo&gt; newFileInfoList = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();
        <span class="hljs-keyword">for</span> (TemplateMakerFileConfig.FileInfoConfig fileInfoConfig : fileConfigInfoList) {
            <span class="hljs-type">String</span> <span class="hljs-variable">inputFilePath</span> <span class="hljs-operator">=</span> fileInfoConfig.getPath();

            <span class="hljs-comment">// 如果填的是相对路径，要改为绝对路径</span>
            <span class="hljs-keyword">if</span> (!inputFilePath.startsWith(sourceRootPath)) {
                inputFilePath = sourceRootPath + File.separator + inputFilePath;
            }

            <span class="hljs-comment">// 获取过滤后的文件列表（不会存在目录）</span>
            List&lt;File&gt; fileList = FileFilter.doFilter(inputFilePath, fileInfoConfig.getFilterConfigList());
            <span class="hljs-keyword">for</span> (File file : fileList) {
                Meta.FileConfig.<span class="hljs-type">FileInfo</span> <span class="hljs-variable">fileInfo</span> <span class="hljs-operator">=</span> makeFileTemplate(modelInfo, searchStr, sourceRootPath, file);
                newFileInfoList.add(fileInfo);
            }
        }

        <span class="hljs-comment">// 三、生成配置文件</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">metaOutputPath</span> <span class="hljs-operator">=</span> sourceRootPath + File.separator + <span class="hljs-string">"meta.json"</span>;

        <span class="hljs-comment">// 如果已有 meta 文件，说明不是第一次制作，则在 meta 基础上进行修改</span>
        <span class="hljs-keyword">if</span> (FileUtil.exist(metaOutputPath)) {
            <span class="hljs-type">Meta</span> <span class="hljs-variable">oldMeta</span> <span class="hljs-operator">=</span> JSONUtil.toBean(FileUtil.readUtf8String(metaOutputPath), Meta.class);
            BeanUtil.copyProperties(newMeta, oldMeta, CopyOptions.create().ignoreNullValue());
            newMeta = oldMeta;

            <span class="hljs-comment">// 1. 追加配置参数</span>
            List&lt;Meta.FileConfig.FileInfo&gt; fileInfoList = newMeta.getFileConfig().getFiles();
            fileInfoList.addAll(newFileInfoList);
            List&lt;Meta.ModelConfig.ModelInfo&gt; modelInfoList = newMeta.getModelConfig().getModels();
            modelInfoList.add(modelInfo);

            <span class="hljs-comment">// 配置去重</span>
            newMeta.getFileConfig().setFiles(distinctFiles(fileInfoList));
            newMeta.getModelConfig().setModels(distinctModels(modelInfoList));
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-comment">// 1. 构造配置参数</span>
            Meta.<span class="hljs-type">FileConfig</span> <span class="hljs-variable">fileConfig</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Meta</span>.FileConfig();
            newMeta.setFileConfig(fileConfig);
            fileConfig.setSourceRootPath(sourceRootPath);
            List&lt;Meta.FileConfig.FileInfo&gt; fileInfoList = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();
            fileConfig.setFiles(fileInfoList);
            fileInfoList.addAll(newFileInfoList);

            Meta.<span class="hljs-type">ModelConfig</span> <span class="hljs-variable">modelConfig</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Meta</span>.ModelConfig();
            newMeta.setModelConfig(modelConfig);
            List&lt;Meta.ModelConfig.ModelInfo&gt; modelInfoList = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();
            modelConfig.setModels(modelInfoList);
            modelInfoList.add(modelInfo);
        }

        <span class="hljs-comment">// 2. 输出元信息文件</span>
        FileUtil.writeUtf8String(JSONUtil.toJsonPrettyStr(newMeta), metaOutputPath);
        <span class="hljs-keyword">return</span> id;
    }

    <span class="hljs-comment">/**
     * 制作文件模板
     *
     * <span class="hljs-doctag">@param</span> modelInfo
     * <span class="hljs-doctag">@param</span> searchStr
     * <span class="hljs-doctag">@param</span> sourceRootPath
     * <span class="hljs-doctag">@param</span> inputFile
     * <span class="hljs-doctag">@return</span>
     */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Meta.FileConfig.FileInfo <span class="hljs-title function_">makeFileTemplate</span><span class="hljs-params">(Meta.ModelConfig.ModelInfo modelInfo, String searchStr, String sourceRootPath, File inputFile)</span> {
        <span class="hljs-comment">// 要挖坑的文件绝对路径（用于制作模板）</span>
        <span class="hljs-comment">// 注意 win 系统需要对路径进行转义</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">fileInputAbsolutePath</span> <span class="hljs-operator">=</span> inputFile.getAbsolutePath().replaceAll(<span class="hljs-string">"\\\\"</span>, <span class="hljs-string">"/"</span>);
        <span class="hljs-type">String</span> <span class="hljs-variable">fileOutputAbsolutePath</span> <span class="hljs-operator">=</span> fileInputAbsolutePath + <span class="hljs-string">".ftl"</span>;
    
        <span class="hljs-comment">// 文件输入输出相对路径（用于生成配置）</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">fileInputPath</span> <span class="hljs-operator">=</span> fileInputAbsolutePath.replace(sourceRootPath + <span class="hljs-string">"/"</span>, <span class="hljs-string">""</span>);
        <span class="hljs-type">String</span> <span class="hljs-variable">fileOutputPath</span> <span class="hljs-operator">=</span> fileInputPath + <span class="hljs-string">".ftl"</span>;

        <span class="hljs-comment">// 使用字符串替换，生成模板文件</span>
        String fileContent;
        <span class="hljs-comment">// 如果已有模板文件，说明不是第一次制作，则在模板基础上再次挖坑</span>
        <span class="hljs-keyword">if</span> (FileUtil.exist(fileOutputAbsolutePath)) {
            fileContent = FileUtil.readUtf8String(fileOutputAbsolutePath);
        } <span class="hljs-keyword">else</span> {
            fileContent = FileUtil.readUtf8String(fileInputAbsolutePath);
        }
        <span class="hljs-type">String</span> <span class="hljs-variable">replacement</span> <span class="hljs-operator">=</span> String.format(<span class="hljs-string">"${%s}"</span>, modelInfo.getFieldName());
        <span class="hljs-type">String</span> <span class="hljs-variable">newFileContent</span> <span class="hljs-operator">=</span> StrUtil.replace(fileContent, searchStr, replacement);

        <span class="hljs-comment">// 文件配置信息</span>
        Meta.FileConfig.<span class="hljs-type">FileInfo</span> <span class="hljs-variable">fileInfo</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Meta</span>.FileConfig.FileInfo();
        fileInfo.setInputPath(fileInputPath);
        fileInfo.setOutputPath(fileOutputPath);
        fileInfo.setType(FileTypeEnum.FILE.getValue());

        <span class="hljs-comment">// 和原文件一致，没有挖坑，则为静态生成</span>
        <span class="hljs-keyword">if</span> (newFileContent.equals(fileContent)) {
            <span class="hljs-comment">// 输出路径 = 输入路径</span>
            fileInfo.setOutputPath(fileInputPath);
            fileInfo.setGenerateType(FileGenerateTypeEnum.STATIC.getValue());
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-comment">// 生成模板文件</span>
            fileInfo.setGenerateType(FileGenerateTypeEnum.DYNAMIC.getValue());
            FileUtil.writeUtf8String(newFileContent, fileOutputAbsolutePath);
        }
        <span class="hljs-keyword">return</span> fileInfo;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-type">Meta</span> <span class="hljs-variable">meta</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Meta</span>();
        meta.setName(<span class="hljs-string">"acm-template-generator"</span>);
        meta.setDescription(<span class="hljs-string">"ACM 示例模板生成器"</span>);

        <span class="hljs-type">String</span> <span class="hljs-variable">projectPath</span> <span class="hljs-operator">=</span> System.getProperty(<span class="hljs-string">"user.dir"</span>);
        <span class="hljs-type">String</span> <span class="hljs-variable">originProjectPath</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(projectPath).getParent() + File.separator + <span class="hljs-string">"yuzi-generator-demo-projects/springboot-init"</span>;
        <span class="hljs-type">String</span> <span class="hljs-variable">inputFilePath1</span> <span class="hljs-operator">=</span> <span class="hljs-string">"src/main/java/com/yupi/springbootinit/common"</span>;
        <span class="hljs-type">String</span> <span class="hljs-variable">inputFilePath2</span> <span class="hljs-operator">=</span> <span class="hljs-string">"src/main/java/com/yupi/springbootinit/controller"</span>;
        List&lt;String&gt; inputFilePathList = Arrays.asList(inputFilePath1, inputFilePath2);

        <span class="hljs-comment">// 模型参数信息（首次）</span>
<span class="hljs-comment">//        Meta.ModelConfig.ModelInfo modelInfo = new Meta.ModelConfig.ModelInfo();</span>
<span class="hljs-comment">//        modelInfo.setFieldName("outputText");</span>
<span class="hljs-comment">//        modelInfo.setType("String");</span>
<span class="hljs-comment">//        modelInfo.setDefaultValue("sum = ");</span>

        <span class="hljs-comment">// 模型参数信息（第二次）</span>
        Meta.ModelConfig.<span class="hljs-type">ModelInfo</span> <span class="hljs-variable">modelInfo</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Meta</span>.ModelConfig.ModelInfo();
        modelInfo.setFieldName(<span class="hljs-string">"className"</span>);
        modelInfo.setType(<span class="hljs-string">"String"</span>);

        <span class="hljs-comment">// 替换变量（首次）</span>
<span class="hljs-comment">//        String searchStr = "Sum: ";</span>
        <span class="hljs-comment">// 替换变量（第二次）</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">searchStr</span> <span class="hljs-operator">=</span> <span class="hljs-string">"BaseResponse"</span>;

        <span class="hljs-comment">// 文件过滤</span>
        <span class="hljs-type">TemplateMakerFileConfig</span> <span class="hljs-variable">templateMakerFileConfig</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TemplateMakerFileConfig</span>();
        TemplateMakerFileConfig.<span class="hljs-type">FileInfoConfig</span> <span class="hljs-variable">fileInfoConfig1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TemplateMakerFileConfig</span>.FileInfoConfig();
        fileInfoConfig1.setPath(inputFilePath1);
        List&lt;FileFilterConfig&gt; fileFilterConfigList = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();
        <span class="hljs-type">FileFilterConfig</span> <span class="hljs-variable">fileFilterConfig</span> <span class="hljs-operator">=</span> FileFilterConfig.builder()
                .range(FileFilterRangeEnum.FILE_NAME.getValue())
                .rule(FileFilterRuleEnum.CONTAINS.getValue())
                .value(<span class="hljs-string">"Base"</span>)
                .build();
        fileFilterConfigList.add(fileFilterConfig);
        fileInfoConfig1.setFilterConfigList(fileFilterConfigList);

        TemplateMakerFileConfig.<span class="hljs-type">FileInfoConfig</span> <span class="hljs-variable">fileInfoConfig2</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TemplateMakerFileConfig</span>.FileInfoConfig();
        fileInfoConfig2.setPath(inputFilePath2);
        templateMakerFileConfig.setFiles(Arrays.asList(fileInfoConfig1, fileInfoConfig2));

        <span class="hljs-type">long</span> <span class="hljs-variable">id</span> <span class="hljs-operator">=</span> makeTemplate(meta, originProjectPath, templateMakerFileConfig, modelInfo, searchStr, <span class="hljs-number">1735281524670181376L</span>);
        System.out.println(id);
    }

    <span class="hljs-comment">/**
     * 模型去重
     *
     * <span class="hljs-doctag">@param</span> modelInfoList
     * <span class="hljs-doctag">@return</span>
     */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> List&lt;Meta.ModelConfig.ModelInfo&gt; distinctModels(List&lt;Meta.ModelConfig.ModelInfo&gt; modelInfoList) {
        List&lt;Meta.ModelConfig.ModelInfo&gt; newModelInfoList = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;(modelInfoList.stream().collect(Collectors.toMap(Meta.ModelConfig.ModelInfo::getFieldName, o -&gt; o, (e, r) -&gt; r)).values());
        <span class="hljs-keyword">return</span> newModelInfoList;
    }

    <span class="hljs-comment">/**
     * 文件去重
     *
     * <span class="hljs-doctag">@param</span> fileInfoList
     * <span class="hljs-doctag">@return</span>
     */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> List&lt;Meta.FileConfig.FileInfo&gt; distinctFiles(List&lt;Meta.FileConfig.FileInfo&gt; fileInfoList) {
        List&lt;Meta.FileConfig.FileInfo&gt; newFileInfoList = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;(fileInfoList.stream().collect(Collectors.toMap(Meta.FileConfig.FileInfo::getInputPath, o -&gt; o, (e, r) -&gt; r)).values());
        <span class="hljs-keyword">return</span> newFileInfoList;
    }
}
</code></pre>
<h3 data-id="heading-23">3、文件分组</h3>
<p>目前，我们的制作工具已经支持对文件进行分组，并且通过给组设置 condition 的方式，支持用单个模型参数同时控制一组文件。</p>
<p>同样的，我们的模板制作工具也需要拥有快速生成文件组配置的能力。</p>
<h4 data-id="heading-24">实现思路</h4>
<p>怎么实现呢？</p>
<p>我们现在已经能够单次制作多个文件了，而且根据用户习惯，同一次制作的多个文件更有可能属于同一组。那么其实我们不用让用户再手动配置如何分组了，可以自动分组。</p>
<p>有 2 种分组策略：</p>
<ol>
<li>一个文件信息配置（FileInfoConfig）对应一次分组。如果传入的 path 是目录，则目录下的所有文件为同组。</li>
<li>一个完整的文件配置（TemplateMakerFileConfig）对应一次分组。即配置 files 列表中的所有文件都属于同组。</li>
</ol>
<p>这里鱼皮选择第 2 种方案。原因是从需求出发，对于 “要用一个参数控制帖子相关的文件是否生成” 的需求，有可能要把跨目录下的文件设置为一个组。第 2 种方案会更灵活。</p>
<h4 data-id="heading-25">开发实现</h4>
<p>下面我们来实现文件分组功能。</p>
<p>1）首先给 <code>TemplateMakerFileConfig</code> 增加分组配置，和之前 <code>Meta</code> 元信息实体类的分组字段一一对应。</p>
<p>代码如下：</p>
<pre style="position: relative; padding-top: 3em; overflow: auto;"><div class="code-block-extension-header" style="position: absolute; top: 0; left: 0; width: 100%; height:28px; font-size:1em; background-color: rgb(248, 248, 248); box-shadow: 0px 4px 5px -6px #888888; display: flex; justify-content: space-between; align-items: center; padding: 0.5em 1em;"><div class="code-block-extension-headerLeft" style="filter: invert(0.5); opacity: 0.6;"><span class="code-block-extension-lang">java</span></div><div class="code-block-extension-headerRight" style="cursor: pointer;"><div class="code-block-extension-copyCodeBtn" style="filter: invert(0.5); opacity: 0.6;">复制代码</div></div></div><code class="language-java hljs" data-highlighted="yes"><span class="hljs-keyword">package</span> com.yupi.maker.template.model;

<span class="hljs-keyword">import</span> lombok.Data;
<span class="hljs-keyword">import</span> lombok.NoArgsConstructor;

<span class="hljs-keyword">import</span> java.util.List;

<span class="hljs-meta">@Data</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TemplateMakerFileConfig</span> {

    <span class="hljs-keyword">private</span> List&lt;FileInfoConfig&gt; files;

    <span class="hljs-keyword">private</span> FileGroupConfig fileGroupConfig;

    <span class="hljs-meta">@NoArgsConstructor</span>
    <span class="hljs-meta">@Data</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FileInfoConfig</span> {

        <span class="hljs-keyword">private</span> String path;

        <span class="hljs-keyword">private</span> List&lt;FileFilterConfig&gt; filterConfigList;
    }

    <span class="hljs-meta">@Data</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FileGroupConfig</span> {

        <span class="hljs-keyword">private</span> String condition;

        <span class="hljs-keyword">private</span> String groupKey;

        <span class="hljs-keyword">private</span> String groupName;
    }
}
</code></pre>
<p>2）在 <code>TemplateMaker</code> 的 <code>makeTemplate</code> 方法中增加文件组相关代码，思路是将本次得到的所有文件信息都放到同一个分组下。</p>
<p>在 “生成配置文件” 前增加如下代码：</p>
<pre style="position: relative; padding-top: 3em; overflow: auto;"><div class="code-block-extension-header" style="position: absolute; top: 0; left: 0; width: 100%; height:28px; font-size:1em; background-color: rgb(248, 248, 248); box-shadow: 0px 4px 5px -6px #888888; display: flex; justify-content: space-between; align-items: center; padding: 0.5em 1em;"><div class="code-block-extension-headerLeft" style="filter: invert(0.5); opacity: 0.6;"><span class="code-block-extension-lang">java</span></div><div class="code-block-extension-headerRight" style="cursor: pointer;"><div class="code-block-extension-copyCodeBtn" style="filter: invert(0.5); opacity: 0.6;">复制代码</div></div></div><code class="language-java hljs" data-highlighted="yes"><span class="hljs-comment">// 如果是文件组</span>
TemplateMakerFileConfig.<span class="hljs-type">FileGroupConfig</span> <span class="hljs-variable">fileGroupConfig</span> <span class="hljs-operator">=</span> templateMakerFileConfig.getFileGroupConfig();
<span class="hljs-keyword">if</span> (fileGroupConfig != <span class="hljs-literal">null</span>) {
    <span class="hljs-type">String</span> <span class="hljs-variable">condition</span> <span class="hljs-operator">=</span> fileGroupConfig.getCondition();
    <span class="hljs-type">String</span> <span class="hljs-variable">groupKey</span> <span class="hljs-operator">=</span> fileGroupConfig.getGroupKey();
    <span class="hljs-type">String</span> <span class="hljs-variable">groupName</span> <span class="hljs-operator">=</span> fileGroupConfig.getGroupName();

    <span class="hljs-comment">// 新增分组配置</span>
    Meta.FileConfig.<span class="hljs-type">FileInfo</span> <span class="hljs-variable">groupFileInfo</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Meta</span>.FileConfig.FileInfo();
    groupFileInfo.setType(FileTypeEnum.GROUP.getValue());
    groupFileInfo.setCondition(condition);
    groupFileInfo.setGroupKey(groupKey);
    groupFileInfo.setGroupName(groupName);
    <span class="hljs-comment">// 文件全放到一个分组内</span>
    groupFileInfo.setFiles(newFileInfoList);
    newFileInfoList = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();
    newFileInfoList.add(groupFileInfo);
}
</code></pre>
<p>3）在 main 方法中增加分组测试数据，代码如下：</p>
<pre style="position: relative; padding-top: 3em; overflow: auto;"><div class="code-block-extension-header" style="position: absolute; top: 0; left: 0; width: 100%; height:28px; font-size:1em; background-color: rgb(248, 248, 248); box-shadow: 0px 4px 5px -6px #888888; display: flex; justify-content: space-between; align-items: center; padding: 0.5em 1em;"><div class="code-block-extension-headerLeft" style="filter: invert(0.5); opacity: 0.6;"><span class="code-block-extension-lang">java</span></div><div class="code-block-extension-headerRight" style="cursor: pointer;"><div class="code-block-extension-copyCodeBtn" style="filter: invert(0.5); opacity: 0.6;">复制代码</div></div></div><code class="language-java hljs" data-highlighted="yes"><span class="hljs-comment">// 分组配置</span>
TemplateMakerFileConfig.<span class="hljs-type">FileGroupConfig</span> <span class="hljs-variable">fileGroupConfig</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TemplateMakerFileConfig</span>.FileGroupConfig();
fileGroupConfig.setCondition(<span class="hljs-string">"outputText"</span>);
fileGroupConfig.setGroupKey(<span class="hljs-string">"test"</span>);
fileGroupConfig.setGroupName(<span class="hljs-string">"测试分组"</span>);
templateMakerFileConfig.setFileGroupConfig(fileGroupConfig);
</code></pre>
<p>执行，成功生成分组配置：</p>
<p><img src="https://pic.code-nav.cn/post_picture/1610518142000300034/77c8c5d4-c406-4876-87cd-b1ff1df1e1a9.png" alt="image.png" class="medium-zoom-image"></p>
<h4 data-id="heading-26">追加配置能力</h4>
<p>虽然已经实现了文件分组配置的生成，但是实际制作模板的过程中，我们可能没办法一步到位，而是希望能多次制作模板，并将文件追加到之前已有的分组下。</p>
<p>也就是说，文件分组要能支持多次制作时追加配置的能力，可以增加新的分组、也可以在同分组下新增文件。</p>
<p>1）让我们先来明确下需求。</p>
<p>举个例子，假设第 1 次制作得到的分组配置如下：</p>
<pre style="position: relative; padding-top: 3em; overflow: auto;"><div class="code-block-extension-header" style="position: absolute; top: 0; left: 0; width: 100%; height:28px; font-size:1em; background-color: rgb(248, 248, 248); box-shadow: 0px 4px 5px -6px #888888; display: flex; justify-content: space-between; align-items: center; padding: 0.5em 1em;"><div class="code-block-extension-headerLeft" style="filter: invert(0.5); opacity: 0.6;"><span class="code-block-extension-lang">json</span></div><div class="code-block-extension-headerRight" style="cursor: pointer;"><div class="code-block-extension-copyCodeBtn" style="filter: invert(0.5); opacity: 0.6;">复制代码</div></div></div><code class="language-json hljs" data-highlighted="yes"><span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"files"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
      <span class="hljs-punctuation">{</span>
          <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"group"</span><span class="hljs-punctuation">,</span>
          <span class="hljs-attr">"condition"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"outputText"</span><span class="hljs-punctuation">,</span>
          <span class="hljs-attr">"groupKey"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"test"</span><span class="hljs-punctuation">,</span>
          <span class="hljs-attr">"groupName"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"测试分组"</span><span class="hljs-punctuation">,</span>
          <span class="hljs-attr">"files"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
              <span class="hljs-punctuation">{</span>
                  <span class="hljs-attr">"inputPath"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"src/main/java/com/yupi/springbootinit/common/BaseResponse.java"</span><span class="hljs-punctuation">,</span>
                  <span class="hljs-attr">"outputPath"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"src/main/java/com/yupi/springbootinit/common/BaseResponse.java.ftl"</span><span class="hljs-punctuation">,</span>
                  <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"file"</span><span class="hljs-punctuation">,</span>
                  <span class="hljs-attr">"generateType"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"dynamic"</span>
              <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
              <span class="hljs-punctuation">{</span>
                  <span class="hljs-attr">"inputPath"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"src/main/java/com/yupi/springbootinit/controller/PostController.java"</span><span class="hljs-punctuation">,</span>
                  <span class="hljs-attr">"outputPath"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"src/main/java/com/yupi/springbootinit/controller/PostController.java.ftl"</span><span class="hljs-punctuation">,</span>
                  <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"file"</span><span class="hljs-punctuation">,</span>
                  <span class="hljs-attr">"generateType"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"dynamic"</span>
              <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
              <span class="hljs-punctuation">{</span>
                  <span class="hljs-attr">"inputPath"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"src/main/java/com/yupi/springbootinit/controller/UserController.java"</span><span class="hljs-punctuation">,</span>
                  <span class="hljs-attr">"outputPath"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"src/main/java/com/yupi/springbootinit/controller/UserController.java.ftl"</span><span class="hljs-punctuation">,</span>
                  <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"file"</span><span class="hljs-punctuation">,</span>
                  <span class="hljs-attr">"generateType"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"dynamic"</span>
              <span class="hljs-punctuation">}</span>
          <span class="hljs-punctuation">]</span>
      <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">]</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>第 2 次制作得到的分组配置如下，新增了 <code>ResultUtils.java</code> 文件：</p>
<pre style="position: relative; padding-top: 3em; overflow: auto;"><div class="code-block-extension-header" style="position: absolute; top: 0; left: 0; width: 100%; height:28px; font-size:1em; background-color: rgb(248, 248, 248); box-shadow: 0px 4px 5px -6px #888888; display: flex; justify-content: space-between; align-items: center; padding: 0.5em 1em;"><div class="code-block-extension-headerLeft" style="filter: invert(0.5); opacity: 0.6;"><span class="code-block-extension-lang">json</span></div><div class="code-block-extension-headerRight" style="cursor: pointer;"><div class="code-block-extension-copyCodeBtn" style="filter: invert(0.5); opacity: 0.6;">复制代码</div></div></div><code class="language-json hljs" data-highlighted="yes"><span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"files"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
      <span class="hljs-punctuation">{</span>
          <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"group"</span><span class="hljs-punctuation">,</span>
          <span class="hljs-attr">"condition"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"outputText"</span><span class="hljs-punctuation">,</span>
          <span class="hljs-attr">"groupKey"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"test"</span><span class="hljs-punctuation">,</span>
          <span class="hljs-attr">"groupName"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"测试分组"</span><span class="hljs-punctuation">,</span>
          <span class="hljs-attr">"files"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
              <span class="hljs-punctuation">{</span>
                  <span class="hljs-attr">"inputPath"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"src/main/java/com/yupi/springbootinit/common/ResultUtils.java"</span><span class="hljs-punctuation">,</span>
                  <span class="hljs-attr">"outputPath"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"src/main/java/com/yupi/springbootinit/common/ResultUtils.java.ftl"</span><span class="hljs-punctuation">,</span>
                  <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"file"</span><span class="hljs-punctuation">,</span>
                  <span class="hljs-attr">"generateType"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"dynamic"</span>
              <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
              <span class="hljs-punctuation">{</span>
                  <span class="hljs-attr">"inputPath"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"src/main/java/com/yupi/springbootinit/controller/PostController.java"</span><span class="hljs-punctuation">,</span>
                  <span class="hljs-attr">"outputPath"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"src/main/java/com/yupi/springbootinit/controller/PostController.java.ftl"</span><span class="hljs-punctuation">,</span>
                  <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"file"</span><span class="hljs-punctuation">,</span>
                  <span class="hljs-attr">"generateType"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"dynamic"</span>
              <span class="hljs-punctuation">}</span>
          <span class="hljs-punctuation">]</span>
      <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">]</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>由于两个分组的 <code>groupKey</code> 相同，视为同一个组，需要将第 2 次得到的分组内的所有文件和之前分组内的文件进行合并去重。得到如下配置：</p>
<pre style="position: relative; padding-top: 3em; overflow: auto;"><div class="code-block-extension-header" style="position: absolute; top: 0; left: 0; width: 100%; height:28px; font-size:1em; background-color: rgb(248, 248, 248); box-shadow: 0px 4px 5px -6px #888888; display: flex; justify-content: space-between; align-items: center; padding: 0.5em 1em;"><div class="code-block-extension-headerLeft" style="filter: invert(0.5); opacity: 0.6;"><span class="code-block-extension-lang">json</span></div><div class="code-block-extension-headerRight" style="cursor: pointer;"><div class="code-block-extension-copyCodeBtn" style="filter: invert(0.5); opacity: 0.6;">复制代码</div></div></div><code class="language-json hljs" data-highlighted="yes"><span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"files"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
      <span class="hljs-punctuation">{</span>
          <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"group"</span><span class="hljs-punctuation">,</span>
          <span class="hljs-attr">"condition"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"outputText"</span><span class="hljs-punctuation">,</span>
          <span class="hljs-attr">"groupKey"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"test"</span><span class="hljs-punctuation">,</span>
          <span class="hljs-attr">"groupName"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"测试分组"</span><span class="hljs-punctuation">,</span>
          <span class="hljs-attr">"files"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
              <span class="hljs-punctuation">{</span>
                  <span class="hljs-attr">"inputPath"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"src/main/java/com/yupi/springbootinit/common/BaseResponse.java"</span><span class="hljs-punctuation">,</span>
                  <span class="hljs-attr">"outputPath"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"src/main/java/com/yupi/springbootinit/common/BaseResponse.java.ftl"</span><span class="hljs-punctuation">,</span>
                  <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"file"</span><span class="hljs-punctuation">,</span>
                  <span class="hljs-attr">"generateType"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"dynamic"</span>
              <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
              <span class="hljs-punctuation">{</span>
                  <span class="hljs-attr">"inputPath"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"src/main/java/com/yupi/springbootinit/controller/PostController.java"</span><span class="hljs-punctuation">,</span>
                  <span class="hljs-attr">"outputPath"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"src/main/java/com/yupi/springbootinit/controller/PostController.java.ftl"</span><span class="hljs-punctuation">,</span>
                  <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"file"</span><span class="hljs-punctuation">,</span>
                  <span class="hljs-attr">"generateType"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"dynamic"</span>
              <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
              <span class="hljs-punctuation">{</span>
                  <span class="hljs-attr">"inputPath"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"src/main/java/com/yupi/springbootinit/controller/UserController.java"</span><span class="hljs-punctuation">,</span>
                  <span class="hljs-attr">"outputPath"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"src/main/java/com/yupi/springbootinit/controller/UserController.java.ftl"</span><span class="hljs-punctuation">,</span>
                  <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"file"</span><span class="hljs-punctuation">,</span>
                  <span class="hljs-attr">"generateType"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"dynamic"</span>
              <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
            	<span class="hljs-punctuation">{</span>
                  <span class="hljs-attr">"inputPath"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"src/main/java/com/yupi/springbootinit/common/ResultUtils.java"</span><span class="hljs-punctuation">,</span>
                  <span class="hljs-attr">"outputPath"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"src/main/java/com/yupi/springbootinit/common/ResultUtils.java.ftl"</span><span class="hljs-punctuation">,</span>
                  <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"file"</span><span class="hljs-punctuation">,</span>
                  <span class="hljs-attr">"generateType"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"dynamic"</span>
              <span class="hljs-punctuation">}</span>
          <span class="hljs-punctuation">]</span>
      <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">]</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>2）明确需求后，让我们来梳理下文件分组去重的实现流程，分为以下步骤：</p>
<ol>
<li>将所有文件配置（fileInfo）分为有分组的和无分组的</li>
<li>对于有分组的文件配置，如果有相同的分组，同分组内的文件进行合并（merge），不同分组可同时保留</li>
<li>创建新的文件配置列表（结果列表），先将合并后的分组添加到结果列表</li>
<li>再将无分组的文件配置列表添加到结果列表</li>
</ol>
<p>3）根据上述步骤，编写代码实现。</p>
<p>修改后的 <code>distinctFiles</code> 方法代码如下：</p>
<pre style="position: relative; padding-top: 3em; overflow: auto;"><div class="code-block-extension-header" style="position: absolute; top: 0; left: 0; width: 100%; height:28px; font-size:1em; background-color: rgb(248, 248, 248); box-shadow: 0px 4px 5px -6px #888888; display: flex; justify-content: space-between; align-items: center; padding: 0.5em 1em;"><div class="code-block-extension-headerLeft" style="filter: invert(0.5); opacity: 0.6;"><span class="code-block-extension-lang">java</span></div><div class="code-block-extension-headerRight" style="cursor: pointer;"><div class="code-block-extension-copyCodeBtn" style="filter: invert(0.5); opacity: 0.6;">复制代码</div></div></div><code class="language-java hljs" data-highlighted="yes"><span class="hljs-comment">/**
 * 文件去重
 *
 * <span class="hljs-doctag">@param</span> fileInfoList
 * <span class="hljs-doctag">@return</span>
 */</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> List&lt;Meta.FileConfig.FileInfo&gt; distinctFiles(List&lt;Meta.FileConfig.FileInfo&gt; fileInfoList) {
    <span class="hljs-comment">// 策略：同分组内文件 merge，不同分组保留</span>

    <span class="hljs-comment">// 1. 有分组的，以组为单位划分</span>
    Map&lt;String, List&lt;Meta.FileConfig.FileInfo&gt;&gt; groupKeyFileInfoListMap = fileInfoList
            .stream()
            .filter(fileInfo -&gt; StrUtil.isNotBlank(fileInfo.getGroupKey()))
            .collect(
                    Collectors.groupingBy(Meta.FileConfig.FileInfo::getGroupKey)
            );


    <span class="hljs-comment">// 2. 同组内的文件配置合并</span>
    <span class="hljs-comment">// 保存每个组对应的合并后的对象 map</span>
    Map&lt;String, Meta.FileConfig.FileInfo&gt; groupKeyMergedFileInfoMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();
    <span class="hljs-keyword">for</span> (Map.Entry&lt;String, List&lt;Meta.FileConfig.FileInfo&gt;&gt; entry : groupKeyFileInfoListMap.entrySet()) {
        List&lt;Meta.FileConfig.FileInfo&gt; tempFileInfoList = entry.getValue();
        List&lt;Meta.FileConfig.FileInfo&gt; newFileInfoList = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;(tempFileInfoList.stream()
                .flatMap(fileInfo -&gt; fileInfo.getFiles().stream())
                .collect(
                        Collectors.toMap(Meta.FileConfig.FileInfo::getInputPath, o -&gt; o, (e, r) -&gt; r)
                ).values());

        <span class="hljs-comment">// 使用新的 group 配置</span>
        Meta.FileConfig.<span class="hljs-type">FileInfo</span> <span class="hljs-variable">newFileInfo</span> <span class="hljs-operator">=</span> CollUtil.getLast(tempFileInfoList);
        newFileInfo.setFiles(newFileInfoList);
        <span class="hljs-type">String</span> <span class="hljs-variable">groupKey</span> <span class="hljs-operator">=</span> entry.getKey();
        groupKeyMergedFileInfoMap.put(groupKey, newFileInfo);
    }

    <span class="hljs-comment">// 3. 将文件分组添加到结果列表</span>
    List&lt;Meta.FileConfig.FileInfo&gt; resultList = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;(groupKeyMergedFileInfoMap.values());

    <span class="hljs-comment">// 4. 将未分组的文件添加到结果列表</span>
    List&lt;Meta.FileConfig.FileInfo&gt; noGroupFileInfoList = fileInfoList.stream().filter(fileInfo -&gt; StrUtil.isBlank(fileInfo.getGroupKey()))
            .collect(Collectors.toList());
    resultList.addAll(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;(noGroupFileInfoList.stream()
            .collect(
                    Collectors.toMap(Meta.FileConfig.FileInfo::getInputPath, o -&gt; o, (e, r) -&gt; r)
            ).values()));
    <span class="hljs-keyword">return</span> resultList;
}
</code></pre>
<p>4）测试验证</p>
<p>修改 main 方法中的 <code>inputFilePath2</code>，指定一个新的目录：</p>
<pre style="position: relative; padding-top: 3em; overflow: auto;"><div class="code-block-extension-header" style="position: absolute; top: 0; left: 0; width: 100%; height:28px; font-size:1em; background-color: rgb(248, 248, 248); box-shadow: 0px 4px 5px -6px #888888; display: flex; justify-content: space-between; align-items: center; padding: 0.5em 1em;"><div class="code-block-extension-headerLeft" style="filter: invert(0.5); opacity: 0.6;"><span class="code-block-extension-lang">java</span></div><div class="code-block-extension-headerRight" style="cursor: pointer;"><div class="code-block-extension-copyCodeBtn" style="filter: invert(0.5); opacity: 0.6;">复制代码</div></div></div><code class="language-java hljs" data-highlighted="yes"><span class="hljs-type">String</span> <span class="hljs-variable">inputFilePath2</span> <span class="hljs-operator">=</span> <span class="hljs-string">"src/main/java/com/yupi/springbootinit/constant"</span>;
</code></pre>
<p>基于之前制作好的模板再次执行，发现第 2 次新增的文件合并到了之前的分组配置中，符合预期：</p>
<p><img src="https://pic.code-nav.cn/post_picture/1610518142000300034/32593b5a-c4d6-49ee-9cda-b3f263299daf.png" alt="image.png" class="medium-zoom-image"></p>
<p>你还可以试着修改分组的名称、条件等配置，新的配置会覆盖之前的配置。</p>
<h4 data-id="heading-27">完整代码</h4>
<p><code>TemplateMaker</code> 的完整代码如下：</p>
<pre style="position: relative; padding-top: 3em; overflow: auto;"><div class="code-block-extension-header" style="position: absolute; top: 0; left: 0; width: 100%; height:28px; font-size:1em; background-color: rgb(248, 248, 248); box-shadow: 0px 4px 5px -6px #888888; display: flex; justify-content: space-between; align-items: center; padding: 0.5em 1em;"><div class="code-block-extension-headerLeft" style="filter: invert(0.5); opacity: 0.6;"><span class="code-block-extension-lang">java</span></div><div class="code-block-extension-headerRight" style="cursor: pointer;"><div class="code-block-extension-copyCodeBtn" style="filter: invert(0.5); opacity: 0.6;">复制代码</div></div></div><code class="language-java hljs" data-highlighted="yes"><span class="hljs-keyword">package</span> com.yupi.maker.template;

<span class="hljs-keyword">import</span> cn.hutool.core.bean.BeanUtil;
<span class="hljs-keyword">import</span> cn.hutool.core.bean.copier.CopyOptions;
<span class="hljs-keyword">import</span> cn.hutool.core.collection.CollUtil;
<span class="hljs-keyword">import</span> cn.hutool.core.io.FileUtil;
<span class="hljs-keyword">import</span> cn.hutool.core.util.IdUtil;
<span class="hljs-keyword">import</span> cn.hutool.core.util.StrUtil;
<span class="hljs-keyword">import</span> cn.hutool.json.JSONUtil;
<span class="hljs-keyword">import</span> com.yupi.maker.meta.Meta;
<span class="hljs-keyword">import</span> com.yupi.maker.meta.enums.FileGenerateTypeEnum;
<span class="hljs-keyword">import</span> com.yupi.maker.meta.enums.FileTypeEnum;
<span class="hljs-keyword">import</span> com.yupi.maker.template.enums.FileFilterRangeEnum;
<span class="hljs-keyword">import</span> com.yupi.maker.template.enums.FileFilterRuleEnum;
<span class="hljs-keyword">import</span> com.yupi.maker.template.model.FileFilterConfig;
<span class="hljs-keyword">import</span> com.yupi.maker.template.model.TemplateMakerFileConfig;

<span class="hljs-keyword">import</span> java.io.File;
<span class="hljs-keyword">import</span> java.nio.file.Paths;
<span class="hljs-keyword">import</span> java.util.*;
<span class="hljs-keyword">import</span> java.util.stream.Collectors;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TemplateMaker</span> {

    <span class="hljs-comment">/**
     * 制作模板
     *
     * <span class="hljs-doctag">@param</span> newMeta
     * <span class="hljs-doctag">@param</span> originProjectPath
     * <span class="hljs-doctag">@param</span> templateMakerFileConfig
     * <span class="hljs-doctag">@param</span> modelInfo
     * <span class="hljs-doctag">@param</span> searchStr
     * <span class="hljs-doctag">@param</span> id
     * <span class="hljs-doctag">@return</span>
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">long</span> <span class="hljs-title function_">makeTemplate</span><span class="hljs-params">(Meta newMeta, String originProjectPath, TemplateMakerFileConfig templateMakerFileConfig, Meta.ModelConfig.ModelInfo modelInfo, String searchStr, Long id)</span> {
        <span class="hljs-comment">// 没有 id 则生成</span>
        <span class="hljs-keyword">if</span> (id == <span class="hljs-literal">null</span>) {
            id = IdUtil.getSnowflakeNextId();
        }

        <span class="hljs-comment">// 复制目录</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">projectPath</span> <span class="hljs-operator">=</span> System.getProperty(<span class="hljs-string">"user.dir"</span>);
        <span class="hljs-type">String</span> <span class="hljs-variable">tempDirPath</span> <span class="hljs-operator">=</span> projectPath + File.separator + <span class="hljs-string">".temp"</span>;
        <span class="hljs-type">String</span> <span class="hljs-variable">templatePath</span> <span class="hljs-operator">=</span> tempDirPath + File.separator + id;

        <span class="hljs-comment">// 是否为首次制作模板</span>
        <span class="hljs-comment">// 目录不存在，则是首次制作</span>
        <span class="hljs-keyword">if</span> (!FileUtil.exist(templatePath)) {
            FileUtil.mkdir(templatePath);
            FileUtil.copy(originProjectPath, templatePath, <span class="hljs-literal">true</span>);
        }

        <span class="hljs-comment">// 一、输入信息</span>
        <span class="hljs-comment">// 输入文件信息</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">sourceRootPath</span> <span class="hljs-operator">=</span> templatePath + File.separator + FileUtil.getLastPathEle(Paths.get(originProjectPath)).toString();
        <span class="hljs-comment">// 注意 win 系统需要对路径进行转义</span>
    	sourceRootPath = sourceRootPath.replaceAll(<span class="hljs-string">"\\\\"</span>, <span class="hljs-string">"/"</span>);
        List&lt;TemplateMakerFileConfig.FileInfoConfig&gt; fileConfigInfoList = templateMakerFileConfig.getFiles();

        <span class="hljs-comment">// 二、生成文件模板</span>
        <span class="hljs-comment">// 遍历输入文件</span>
        List&lt;Meta.FileConfig.FileInfo&gt; newFileInfoList = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();
        <span class="hljs-keyword">for</span> (TemplateMakerFileConfig.FileInfoConfig fileInfoConfig : fileConfigInfoList) {
            <span class="hljs-type">String</span> <span class="hljs-variable">inputFilePath</span> <span class="hljs-operator">=</span> fileInfoConfig.getPath();

            <span class="hljs-comment">// 如果填的是相对路径，要改为绝对路径</span>
            <span class="hljs-keyword">if</span> (!inputFilePath.startsWith(sourceRootPath)) {
                inputFilePath = sourceRootPath + File.separator + inputFilePath;
            }

            <span class="hljs-comment">// 获取过滤后的文件列表（不会存在目录）</span>
            List&lt;File&gt; fileList = FileFilter.doFilter(inputFilePath, fileInfoConfig.getFilterConfigList());
            <span class="hljs-keyword">for</span> (File file : fileList) {
                Meta.FileConfig.<span class="hljs-type">FileInfo</span> <span class="hljs-variable">fileInfo</span> <span class="hljs-operator">=</span> makeFileTemplate(modelInfo, searchStr, sourceRootPath, file);
                newFileInfoList.add(fileInfo);
            }
        }

        <span class="hljs-comment">// 如果是文件组</span>
        TemplateMakerFileConfig.<span class="hljs-type">FileGroupConfig</span> <span class="hljs-variable">fileGroupConfig</span> <span class="hljs-operator">=</span> templateMakerFileConfig.getFileGroupConfig();
        <span class="hljs-keyword">if</span> (fileGroupConfig != <span class="hljs-literal">null</span>) {
            <span class="hljs-type">String</span> <span class="hljs-variable">condition</span> <span class="hljs-operator">=</span> fileGroupConfig.getCondition();
            <span class="hljs-type">String</span> <span class="hljs-variable">groupKey</span> <span class="hljs-operator">=</span> fileGroupConfig.getGroupKey();
            <span class="hljs-type">String</span> <span class="hljs-variable">groupName</span> <span class="hljs-operator">=</span> fileGroupConfig.getGroupName();

            <span class="hljs-comment">// 新增分组配置</span>
            Meta.FileConfig.<span class="hljs-type">FileInfo</span> <span class="hljs-variable">groupFileInfo</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Meta</span>.FileConfig.FileInfo();
            groupFileInfo.setType(FileTypeEnum.GROUP.getValue());
            groupFileInfo.setCondition(condition);
            groupFileInfo.setGroupKey(groupKey);
            groupFileInfo.setGroupName(groupName);
            <span class="hljs-comment">// 文件全放到一个分组内</span>
            groupFileInfo.setFiles(newFileInfoList);
            newFileInfoList = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();
            newFileInfoList.add(groupFileInfo);
        }

        <span class="hljs-comment">// 三、生成配置文件</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">metaOutputPath</span> <span class="hljs-operator">=</span> sourceRootPath + File.separator + <span class="hljs-string">"meta.json"</span>;

        <span class="hljs-comment">// 如果已有 meta 文件，说明不是第一次制作，则在 meta 基础上进行修改</span>
        <span class="hljs-keyword">if</span> (FileUtil.exist(metaOutputPath)) {
            <span class="hljs-type">Meta</span> <span class="hljs-variable">oldMeta</span> <span class="hljs-operator">=</span> JSONUtil.toBean(FileUtil.readUtf8String(metaOutputPath), Meta.class);
            BeanUtil.copyProperties(newMeta, oldMeta, CopyOptions.create().ignoreNullValue());
            newMeta = oldMeta;

            <span class="hljs-comment">// 1. 追加配置参数</span>
            List&lt;Meta.FileConfig.FileInfo&gt; fileInfoList = newMeta.getFileConfig().getFiles();
            fileInfoList.addAll(newFileInfoList);
            List&lt;Meta.ModelConfig.ModelInfo&gt; modelInfoList = newMeta.getModelConfig().getModels();
            modelInfoList.add(modelInfo);

            <span class="hljs-comment">// 配置去重</span>
            newMeta.getFileConfig().setFiles(distinctFiles(fileInfoList));
            newMeta.getModelConfig().setModels(distinctModels(modelInfoList));
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-comment">// 1. 构造配置参数</span>
            Meta.<span class="hljs-type">FileConfig</span> <span class="hljs-variable">fileConfig</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Meta</span>.FileConfig();
            newMeta.setFileConfig(fileConfig);
            fileConfig.setSourceRootPath(sourceRootPath);
            List&lt;Meta.FileConfig.FileInfo&gt; fileInfoList = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();
            fileConfig.setFiles(fileInfoList);
            fileInfoList.addAll(newFileInfoList);

            Meta.<span class="hljs-type">ModelConfig</span> <span class="hljs-variable">modelConfig</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Meta</span>.ModelConfig();
            newMeta.setModelConfig(modelConfig);
            List&lt;Meta.ModelConfig.ModelInfo&gt; modelInfoList = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();
            modelConfig.setModels(modelInfoList);
            modelInfoList.add(modelInfo);
        }

        <span class="hljs-comment">// 2. 输出元信息文件</span>
        FileUtil.writeUtf8String(JSONUtil.toJsonPrettyStr(newMeta), metaOutputPath);
        <span class="hljs-keyword">return</span> id;
    }

    <span class="hljs-comment">/**
     * 制作文件模板
     *
     * <span class="hljs-doctag">@param</span> modelInfo
     * <span class="hljs-doctag">@param</span> searchStr
     * <span class="hljs-doctag">@param</span> sourceRootPath
     * <span class="hljs-doctag">@param</span> inputFile
     * <span class="hljs-doctag">@return</span>
     */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Meta.FileConfig.FileInfo <span class="hljs-title function_">makeFileTemplate</span><span class="hljs-params">(Meta.ModelConfig.ModelInfo modelInfo, String searchStr, String sourceRootPath, File inputFile)</span> {
        <span class="hljs-comment">// 要挖坑的文件绝对路径（用于制作模板）</span>
        <span class="hljs-comment">// 注意 win 系统需要对路径进行转义</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">fileInputAbsolutePath</span> <span class="hljs-operator">=</span> inputFile.getAbsolutePath().replaceAll(<span class="hljs-string">"\\\\"</span>, <span class="hljs-string">"/"</span>);
        <span class="hljs-type">String</span> <span class="hljs-variable">fileOutputAbsolutePath</span> <span class="hljs-operator">=</span> fileInputAbsolutePath + <span class="hljs-string">".ftl"</span>;
    
        <span class="hljs-comment">// 文件输入输出相对路径（用于生成配置）</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">fileInputPath</span> <span class="hljs-operator">=</span> fileInputAbsolutePath.replace(sourceRootPath + <span class="hljs-string">"/"</span>, <span class="hljs-string">""</span>);
        <span class="hljs-type">String</span> <span class="hljs-variable">fileOutputPath</span> <span class="hljs-operator">=</span> fileInputPath + <span class="hljs-string">".ftl"</span>;

        <span class="hljs-comment">// 使用字符串替换，生成模板文件</span>
        String fileContent;
        <span class="hljs-comment">// 如果已有模板文件，说明不是第一次制作，则在模板基础上再次挖坑</span>
        <span class="hljs-keyword">if</span> (FileUtil.exist(fileOutputAbsolutePath)) {
            fileContent = FileUtil.readUtf8String(fileOutputAbsolutePath);
        } <span class="hljs-keyword">else</span> {
            fileContent = FileUtil.readUtf8String(fileInputAbsolutePath);
        }
        <span class="hljs-type">String</span> <span class="hljs-variable">replacement</span> <span class="hljs-operator">=</span> String.format(<span class="hljs-string">"${%s}"</span>, modelInfo.getFieldName());
        <span class="hljs-type">String</span> <span class="hljs-variable">newFileContent</span> <span class="hljs-operator">=</span> StrUtil.replace(fileContent, searchStr, replacement);

        <span class="hljs-comment">// 文件配置信息</span>
        Meta.FileConfig.<span class="hljs-type">FileInfo</span> <span class="hljs-variable">fileInfo</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Meta</span>.FileConfig.FileInfo();
        fileInfo.setInputPath(fileInputPath);
        fileInfo.setOutputPath(fileOutputPath);
        fileInfo.setType(FileTypeEnum.FILE.getValue());

        <span class="hljs-comment">// 和原文件一致，没有挖坑，则为静态生成</span>
        <span class="hljs-keyword">if</span> (newFileContent.equals(fileContent)) {
            <span class="hljs-comment">// 输出路径 = 输入路径</span>
            fileInfo.setOutputPath(fileInputPath);
            fileInfo.setGenerateType(FileGenerateTypeEnum.STATIC.getValue());
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-comment">// 生成模板文件</span>
            fileInfo.setGenerateType(FileGenerateTypeEnum.DYNAMIC.getValue());
            FileUtil.writeUtf8String(newFileContent, fileOutputAbsolutePath);
        }
        <span class="hljs-keyword">return</span> fileInfo;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-type">Meta</span> <span class="hljs-variable">meta</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Meta</span>();
        meta.setName(<span class="hljs-string">"acm-template-generator"</span>);
        meta.setDescription(<span class="hljs-string">"ACM 示例模板生成器"</span>);

        <span class="hljs-type">String</span> <span class="hljs-variable">projectPath</span> <span class="hljs-operator">=</span> System.getProperty(<span class="hljs-string">"user.dir"</span>);
        <span class="hljs-type">String</span> <span class="hljs-variable">originProjectPath</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(projectPath).getParent() + File.separator + <span class="hljs-string">"yuzi-generator-demo-projects/springboot-init"</span>;
        <span class="hljs-type">String</span> <span class="hljs-variable">inputFilePath1</span> <span class="hljs-operator">=</span> <span class="hljs-string">"src/main/java/com/yupi/springbootinit/common"</span>;
        <span class="hljs-type">String</span> <span class="hljs-variable">inputFilePath2</span> <span class="hljs-operator">=</span> <span class="hljs-string">"src/main/java/com/yupi/springbootinit/constant"</span>;

        <span class="hljs-comment">// 模型参数信息（首次）</span>
<span class="hljs-comment">//        Meta.ModelConfig.ModelInfo modelInfo = new Meta.ModelConfig.ModelInfo();</span>
<span class="hljs-comment">//        modelInfo.setFieldName("outputText");</span>
<span class="hljs-comment">//        modelInfo.setType("String");</span>
<span class="hljs-comment">//        modelInfo.setDefaultValue("sum = ");</span>

        <span class="hljs-comment">// 模型参数信息（第二次）</span>
        Meta.ModelConfig.<span class="hljs-type">ModelInfo</span> <span class="hljs-variable">modelInfo</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Meta</span>.ModelConfig.ModelInfo();
        modelInfo.setFieldName(<span class="hljs-string">"className"</span>);
        modelInfo.setType(<span class="hljs-string">"String"</span>);

        <span class="hljs-comment">// 替换变量（首次）</span>
<span class="hljs-comment">//        String searchStr = "Sum: ";</span>
        <span class="hljs-comment">// 替换变量（第二次）</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">searchStr</span> <span class="hljs-operator">=</span> <span class="hljs-string">"BaseResponse"</span>;

        <span class="hljs-comment">// 文件过滤</span>
        <span class="hljs-type">TemplateMakerFileConfig</span> <span class="hljs-variable">templateMakerFileConfig</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TemplateMakerFileConfig</span>();
        TemplateMakerFileConfig.<span class="hljs-type">FileInfoConfig</span> <span class="hljs-variable">fileInfoConfig1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TemplateMakerFileConfig</span>.FileInfoConfig();
        fileInfoConfig1.setPath(inputFilePath1);
        List&lt;FileFilterConfig&gt; fileFilterConfigList = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();
        <span class="hljs-type">FileFilterConfig</span> <span class="hljs-variable">fileFilterConfig</span> <span class="hljs-operator">=</span> FileFilterConfig.builder()
                .range(FileFilterRangeEnum.FILE_NAME.getValue())
                .rule(FileFilterRuleEnum.CONTAINS.getValue())
                .value(<span class="hljs-string">"Base"</span>)
                .build();
        fileFilterConfigList.add(fileFilterConfig);
        fileInfoConfig1.setFilterConfigList(fileFilterConfigList);

        TemplateMakerFileConfig.<span class="hljs-type">FileInfoConfig</span> <span class="hljs-variable">fileInfoConfig2</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TemplateMakerFileConfig</span>.FileInfoConfig();
        fileInfoConfig2.setPath(inputFilePath2);
        templateMakerFileConfig.setFiles(Arrays.asList(fileInfoConfig1, fileInfoConfig2));

        <span class="hljs-comment">// 分组配置</span>
        TemplateMakerFileConfig.<span class="hljs-type">FileGroupConfig</span> <span class="hljs-variable">fileGroupConfig</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TemplateMakerFileConfig</span>.FileGroupConfig();
        fileGroupConfig.setCondition(<span class="hljs-string">"outputText"</span>);
        fileGroupConfig.setGroupKey(<span class="hljs-string">"test"</span>);
        fileGroupConfig.setGroupName(<span class="hljs-string">"测试分组"</span>);
        templateMakerFileConfig.setFileGroupConfig(fileGroupConfig);

        <span class="hljs-type">long</span> <span class="hljs-variable">id</span> <span class="hljs-operator">=</span> makeTemplate(meta, originProjectPath, templateMakerFileConfig, modelInfo, searchStr, <span class="hljs-number">1735281524670181376L</span>);
        System.out.println(id);
    }

    <span class="hljs-comment">/**
     * 模型去重
     *
     * <span class="hljs-doctag">@param</span> modelInfoList
     * <span class="hljs-doctag">@return</span>
     */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> List&lt;Meta.ModelConfig.ModelInfo&gt; distinctModels(List&lt;Meta.ModelConfig.ModelInfo&gt; modelInfoList) {
        List&lt;Meta.ModelConfig.ModelInfo&gt; newModelInfoList = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;(modelInfoList.stream().collect(Collectors.toMap(Meta.ModelConfig.ModelInfo::getFieldName, o -&gt; o, (e, r) -&gt; r)).values());
        <span class="hljs-keyword">return</span> newModelInfoList;
    }

    <span class="hljs-comment">/**
     * 文件去重
     *
     * <span class="hljs-doctag">@param</span> fileInfoList
     * <span class="hljs-doctag">@return</span>
     */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> List&lt;Meta.FileConfig.FileInfo&gt; distinctFiles(List&lt;Meta.FileConfig.FileInfo&gt; fileInfoList) {
        <span class="hljs-comment">// 策略：同分组内文件 merge，不同分组保留</span>

        <span class="hljs-comment">// 1. 有分组的，以组为单位划分</span>
        Map&lt;String, List&lt;Meta.FileConfig.FileInfo&gt;&gt; groupKeyFileInfoListMap = fileInfoList
                .stream()
                .filter(fileInfo -&gt; StrUtil.isNotBlank(fileInfo.getGroupKey()))
                .collect(
                        Collectors.groupingBy(Meta.FileConfig.FileInfo::getGroupKey)
                );


        <span class="hljs-comment">// 2. 同组内的文件配置合并</span>
        <span class="hljs-comment">// 保存每个组对应的合并后的对象 map</span>
        Map&lt;String, Meta.FileConfig.FileInfo&gt; groupKeyMergedFileInfoMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();
        <span class="hljs-keyword">for</span> (Map.Entry&lt;String, List&lt;Meta.FileConfig.FileInfo&gt;&gt; entry : groupKeyFileInfoListMap.entrySet()) {
            List&lt;Meta.FileConfig.FileInfo&gt; tempFileInfoList = entry.getValue();
            List&lt;Meta.FileConfig.FileInfo&gt; newFileInfoList = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;(tempFileInfoList.stream()
                    .flatMap(fileInfo -&gt; fileInfo.getFiles().stream())
                    .collect(
                            Collectors.toMap(Meta.FileConfig.FileInfo::getInputPath, o -&gt; o, (e, r) -&gt; r)
                    ).values());

            <span class="hljs-comment">// 使用新的 group 配置</span>
            Meta.FileConfig.<span class="hljs-type">FileInfo</span> <span class="hljs-variable">newFileInfo</span> <span class="hljs-operator">=</span> CollUtil.getLast(tempFileInfoList);
            newFileInfo.setFiles(newFileInfoList);
            <span class="hljs-type">String</span> <span class="hljs-variable">groupKey</span> <span class="hljs-operator">=</span> entry.getKey();
            groupKeyMergedFileInfoMap.put(groupKey, newFileInfo);
        }

        <span class="hljs-comment">// 3. 将文件分组添加到结果列表</span>
        List&lt;Meta.FileConfig.FileInfo&gt; resultList = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;(groupKeyMergedFileInfoMap.values());

        <span class="hljs-comment">// 4. 将未分组的文件添加到结果列表</span>
        List&lt;Meta.FileConfig.FileInfo&gt; noGroupFileInfoList = fileInfoList.stream().filter(fileInfo -&gt; StrUtil.isBlank(fileInfo.getGroupKey()))
                .collect(Collectors.toList());
        resultList.addAll(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;(noGroupFileInfoList.stream()
                .collect(
                        Collectors.toMap(Meta.FileConfig.FileInfo::getInputPath, o -&gt; o, (e, r) -&gt; r)
                ).values()));
        <span class="hljs-keyword">return</span> resultList;
    }
}

</code></pre>
<h3 data-id="heading-28">4、模型分组</h3>
<p>和文件分组一样，之前我们的制作工具已经实现了模型分组的能力。那现在我们的模板制作工具也需要能够同时指定多个模型参数进行 “挖坑”，并生成模型分组配置。</p>
<h4 data-id="heading-29">实现思路</h4>
<p>模型分组的实现思路和文件分组逻辑几乎一致，此处不再赘述。</p>
<p>但有一点需要注意，之前我们在测试模板制作工具时，传入的都是单个模型参数和要替换的字符串参数（searchStr）。但现在如果要一次性输入多个模型参数，也要传入多个要替换的字符串。准确地说，每个模型和要替换的字符串参数应该一一对应。所以我们需要用额外的类来封装这些参数。</p>
<h4 data-id="heading-30">开发实现</h4>
<p>1）首先像封装文件配置类（TemplateMakerFileConfig）一样，封装所有模型参数、分组参数为模型配置类 <code>TemplateMakerModelConfig</code>，放到 <code>template.model</code> 目录下。</p>
<p>代码如下：</p>
<pre style="position: relative; padding-top: 3em; overflow: auto;"><div class="code-block-extension-header" style="position: absolute; top: 0; left: 0; width: 100%; height:28px; font-size:1em; background-color: rgb(248, 248, 248); box-shadow: 0px 4px 5px -6px #888888; display: flex; justify-content: space-between; align-items: center; padding: 0.5em 1em;"><div class="code-block-extension-headerLeft" style="filter: invert(0.5); opacity: 0.6;"><span class="code-block-extension-lang">java</span></div><div class="code-block-extension-headerRight" style="cursor: pointer;"><div class="code-block-extension-copyCodeBtn" style="filter: invert(0.5); opacity: 0.6;">复制代码</div></div></div><code class="language-java hljs" data-highlighted="yes"><span class="hljs-keyword">package</span> com.yupi.maker.template.model;

<span class="hljs-keyword">import</span> lombok.Data;
<span class="hljs-keyword">import</span> lombok.NoArgsConstructor;

<span class="hljs-keyword">import</span> java.util.List;

<span class="hljs-meta">@Data</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TemplateMakerModelConfig</span> {

    <span class="hljs-keyword">private</span> List&lt;ModelInfoConfig&gt; models;

    <span class="hljs-keyword">private</span> ModelGroupConfig modelGroupConfig;

    <span class="hljs-meta">@NoArgsConstructor</span>
    <span class="hljs-meta">@Data</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ModelInfoConfig</span> {

        <span class="hljs-keyword">private</span> String fieldName;

        <span class="hljs-keyword">private</span> String type;

        <span class="hljs-keyword">private</span> String description;

        <span class="hljs-keyword">private</span> Object defaultValue;

        <span class="hljs-keyword">private</span> String abbr;

        <span class="hljs-comment">// 用于替换哪些文本</span>
        <span class="hljs-keyword">private</span> String replaceText;
    }

    <span class="hljs-meta">@Data</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ModelGroupConfig</span> {

        <span class="hljs-keyword">private</span> String condition;

        <span class="hljs-keyword">private</span> String groupKey;

        <span class="hljs-keyword">private</span> String groupName;
    }
}
</code></pre>
<p>2）修改模型去重方法，和文件去重逻辑一致，实现同组模型信息的去重合并。</p>
<p>模型去重方法的代码如下：</p>
<pre style="position: relative; padding-top: 3em; overflow: auto;"><div class="code-block-extension-header" style="position: absolute; top: 0; left: 0; width: 100%; height:28px; font-size:1em; background-color: rgb(248, 248, 248); box-shadow: 0px 4px 5px -6px #888888; display: flex; justify-content: space-between; align-items: center; padding: 0.5em 1em;"><div class="code-block-extension-headerLeft" style="filter: invert(0.5); opacity: 0.6;"><span class="code-block-extension-lang">java</span></div><div class="code-block-extension-headerRight" style="cursor: pointer;"><div class="code-block-extension-copyCodeBtn" style="filter: invert(0.5); opacity: 0.6;">复制代码</div></div></div><code class="language-java hljs" data-highlighted="yes"><span class="hljs-comment">/**
 * 模型去重
 *
 * <span class="hljs-doctag">@param</span> modelInfoList
 * <span class="hljs-doctag">@return</span>
 */</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> List&lt;Meta.ModelConfig.ModelInfo&gt; distinctModels(List&lt;Meta.ModelConfig.ModelInfo&gt; modelInfoList) {
    <span class="hljs-comment">// 策略：同分组内模型 merge，不同分组保留</span>

    <span class="hljs-comment">// 1. 有分组的，以组为单位划分</span>
    Map&lt;String, List&lt;Meta.ModelConfig.ModelInfo&gt;&gt; groupKeyModelInfoListMap = modelInfoList
            .stream()
            .filter(modelInfo -&gt; StrUtil.isNotBlank(modelInfo.getGroupKey()))
            .collect(
                    Collectors.groupingBy(Meta.ModelConfig.ModelInfo::getGroupKey)
            );


    <span class="hljs-comment">// 2. 同组内的模型配置合并</span>
    <span class="hljs-comment">// 保存每个组对应的合并后的对象 map</span>
    Map&lt;String, Meta.ModelConfig.ModelInfo&gt; groupKeyMergedModelInfoMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();
    <span class="hljs-keyword">for</span> (Map.Entry&lt;String, List&lt;Meta.ModelConfig.ModelInfo&gt;&gt; entry : groupKeyModelInfoListMap.entrySet()) {
        List&lt;Meta.ModelConfig.ModelInfo&gt; tempModelInfoList = entry.getValue();
        List&lt;Meta.ModelConfig.ModelInfo&gt; newModelInfoList = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;(tempModelInfoList.stream()
                .flatMap(modelInfo -&gt; modelInfo.getModels().stream())
                .collect(
                        Collectors.toMap(Meta.ModelConfig.ModelInfo::getFieldName, o -&gt; o, (e, r) -&gt; r)
                ).values());

        <span class="hljs-comment">// 使用新的 group 配置</span>
        Meta.ModelConfig.<span class="hljs-type">ModelInfo</span> <span class="hljs-variable">newModelInfo</span> <span class="hljs-operator">=</span> CollUtil.getLast(tempModelInfoList);
        newModelInfo.setModels(newModelInfoList);
        <span class="hljs-type">String</span> <span class="hljs-variable">groupKey</span> <span class="hljs-operator">=</span> entry.getKey();
        groupKeyMergedModelInfoMap.put(groupKey, newModelInfo);
    }

    <span class="hljs-comment">// 3. 将模型分组添加到结果列表</span>
    List&lt;Meta.ModelConfig.ModelInfo&gt; resultList = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;(groupKeyMergedModelInfoMap.values());

    <span class="hljs-comment">// 4. 将未分组的模型添加到结果列表</span>
    List&lt;Meta.ModelConfig.ModelInfo&gt; noGroupModelInfoList = modelInfoList.stream().filter(modelInfo -&gt; StrUtil.isBlank(modelInfo.getGroupKey()))
            .collect(Collectors.toList());
    resultList.addAll(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;(noGroupModelInfoList.stream()
            .collect(
                    Collectors.toMap(Meta.ModelConfig.ModelInfo::getFieldName, o -&gt; o, (e, r) -&gt; r)
            ).values()));
    <span class="hljs-keyword">return</span> resultList;
}
</code></pre>
<p>3）修改 <code>makeTemplate</code> 的输入参数，使用封装好的模型配置类 <code>TemplateMakerModelConfig</code> 代替 modelInfo 和 searchStr。</p>
<p>修改后的方法参数如下：</p>
<pre style="position: relative; padding-top: 3em; overflow: auto;"><div class="code-block-extension-header" style="position: absolute; top: 0; left: 0; width: 100%; height:28px; font-size:1em; background-color: rgb(248, 248, 248); box-shadow: 0px 4px 5px -6px #888888; display: flex; justify-content: space-between; align-items: center; padding: 0.5em 1em;"><div class="code-block-extension-headerLeft" style="filter: invert(0.5); opacity: 0.6;"><span class="code-block-extension-lang">java</span></div><div class="code-block-extension-headerRight" style="cursor: pointer;"><div class="code-block-extension-copyCodeBtn" style="filter: invert(0.5); opacity: 0.6;">复制代码</div></div></div><code class="language-java hljs" data-highlighted="yes"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">long</span> <span class="hljs-title function_">makeTemplate</span><span class="hljs-params">(Meta newMeta,
                                String originProjectPath,
                                TemplateMakerFileConfig templateMakerFileConfig,
                                TemplateMakerModelConfig templateMakerModelConfig,
                                Long id)</span> {}
</code></pre>
<p>由于参数修改了，我们也要像从文件配置中读取信息一样，从模型配置中读出分组和模型列表信息，并转换为用于生成元信息配置的 <code>newModelInfoList</code>。</p>
<p>代码如下：</p>
<pre style="position: relative; padding-top: 3em; overflow: auto;"><div class="code-block-extension-header" style="position: absolute; top: 0; left: 0; width: 100%; height:28px; font-size:1em; background-color: rgb(248, 248, 248); box-shadow: 0px 4px 5px -6px #888888; display: flex; justify-content: space-between; align-items: center; padding: 0.5em 1em;"><div class="code-block-extension-headerLeft" style="filter: invert(0.5); opacity: 0.6;"><span class="code-block-extension-lang">java</span></div><div class="code-block-extension-headerRight" style="cursor: pointer;"><div class="code-block-extension-copyCodeBtn" style="filter: invert(0.5); opacity: 0.6;">复制代码</div></div></div><code class="language-java hljs" data-highlighted="yes"><span class="hljs-comment">// 处理模型信息</span>
List&lt;TemplateMakerModelConfig.ModelInfoConfig&gt; models = templateMakerModelConfig.getModels();
<span class="hljs-comment">// - 转换为配置接受的 ModelInfo 对象</span>
List&lt;Meta.ModelConfig.ModelInfo&gt; inputModelInfoList = models.stream().map(modelInfoConfig -&gt; {
    Meta.ModelConfig.<span class="hljs-type">ModelInfo</span> <span class="hljs-variable">modelInfo</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Meta</span>.ModelConfig.ModelInfo();
    BeanUtil.copyProperties(modelInfoConfig, modelInfo);
    <span class="hljs-keyword">return</span> modelInfo;
}).collect(Collectors.toList());

<span class="hljs-comment">// - 本次新增的模型配置列表</span>
List&lt;Meta.ModelConfig.ModelInfo&gt; newModelInfoList = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();

<span class="hljs-comment">// - 如果是模型组</span>
TemplateMakerModelConfig.<span class="hljs-type">ModelGroupConfig</span> <span class="hljs-variable">modelGroupConfig</span> <span class="hljs-operator">=</span> templateMakerModelConfig.getModelGroupConfig();
<span class="hljs-keyword">if</span> (modelGroupConfig != <span class="hljs-literal">null</span>) {
    <span class="hljs-type">String</span> <span class="hljs-variable">condition</span> <span class="hljs-operator">=</span> modelGroupConfig.getCondition();
    <span class="hljs-type">String</span> <span class="hljs-variable">groupKey</span> <span class="hljs-operator">=</span> modelGroupConfig.getGroupKey();
    <span class="hljs-type">String</span> <span class="hljs-variable">groupName</span> <span class="hljs-operator">=</span> modelGroupConfig.getGroupName();
    Meta.ModelConfig.<span class="hljs-type">ModelInfo</span> <span class="hljs-variable">groupModelInfo</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Meta</span>.ModelConfig.ModelInfo();
    groupModelInfo.setGroupKey(groupKey);
    groupModelInfo.setGroupName(groupName);
    groupModelInfo.setCondition(condition);

    <span class="hljs-comment">// 模型全放到一个分组内</span>
    groupModelInfo.setModels(inputModelInfoList);
    newModelInfoList.add(groupModelInfo);
} <span class="hljs-keyword">else</span> {
    <span class="hljs-comment">// 不分组，添加所有的模型信息到列表</span>
    newModelInfoList.addAll(inputModelInfoList);
}
</code></pre>
<p>之前生成元信息配置，是增加了单个 ModelInfo 对象，现在需要改为增加 <code>newModelInfoList</code> 列表：</p>
<pre style="position: relative; padding-top: 3em; overflow: auto;"><div class="code-block-extension-header" style="position: absolute; top: 0; left: 0; width: 100%; height:28px; font-size:1em; background-color: rgb(248, 248, 248); box-shadow: 0px 4px 5px -6px #888888; display: flex; justify-content: space-between; align-items: center; padding: 0.5em 1em;"><div class="code-block-extension-headerLeft" style="filter: invert(0.5); opacity: 0.6;"><span class="code-block-extension-lang">java</span></div><div class="code-block-extension-headerRight" style="cursor: pointer;"><div class="code-block-extension-copyCodeBtn" style="filter: invert(0.5); opacity: 0.6;">复制代码</div></div></div><code class="language-java hljs" data-highlighted="yes"><span class="hljs-comment">// 1. 追加配置参数</span>
List&lt;Meta.FileConfig.FileInfo&gt; fileInfoList = newMeta.getFileConfig().getFiles();
fileInfoList.addAll(newFileInfoList);
List&lt;Meta.ModelConfig.ModelInfo&gt; modelInfoList = newMeta.getModelConfig().getModels();
modelInfoList.addAll(newModelInfoList);
</code></pre>
<p>4）修改 <code>makeFileTemplate</code> 方法，要能够支持使用多个模型参数对文件 “挖坑”。</p>
<p>实现思路是依次遍历模型参数，对文件内容进行替换，将上一轮替换后的结果作为新一轮要替换的内容，从而实现多轮替换。</p>
<p>先调整方法的输入参数，以及调用该方法时传入的参数：</p>
<pre style="position: relative; padding-top: 3em; overflow: auto;"><div class="code-block-extension-header" style="position: absolute; top: 0; left: 0; width: 100%; height:28px; font-size:1em; background-color: rgb(248, 248, 248); box-shadow: 0px 4px 5px -6px #888888; display: flex; justify-content: space-between; align-items: center; padding: 0.5em 1em;"><div class="code-block-extension-headerLeft" style="filter: invert(0.5); opacity: 0.6;"><span class="code-block-extension-lang">java</span></div><div class="code-block-extension-headerRight" style="cursor: pointer;"><div class="code-block-extension-copyCodeBtn" style="filter: invert(0.5); opacity: 0.6;">复制代码</div></div></div><code class="language-java hljs" data-highlighted="yes"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Meta.FileConfig.FileInfo <span class="hljs-title function_">makeFileTemplate</span><span class="hljs-params">(
    TemplateMakerModelConfig templateMakerModelConfig,
    String sourceRootPath,
    File inputFile)</span> {}
</code></pre>
<p>然后实现多轮替换逻辑，修改的关键代码如下：</p>
<pre style="position: relative; padding-top: 3em; overflow: auto;"><div class="code-block-extension-header" style="position: absolute; top: 0; left: 0; width: 100%; height:28px; font-size:1em; background-color: rgb(248, 248, 248); box-shadow: 0px 4px 5px -6px #888888; display: flex; justify-content: space-between; align-items: center; padding: 0.5em 1em;"><div class="code-block-extension-headerLeft" style="filter: invert(0.5); opacity: 0.6;"><span class="code-block-extension-lang">java</span></div><div class="code-block-extension-headerRight" style="cursor: pointer;"><div class="code-block-extension-copyCodeBtn" style="filter: invert(0.5); opacity: 0.6;">复制代码</div></div></div><code class="language-java hljs" data-highlighted="yes"><span class="hljs-comment">// 支持多个模型：对同一个文件的内容，遍历模型进行多轮替换</span>
TemplateMakerModelConfig.<span class="hljs-type">ModelGroupConfig</span> <span class="hljs-variable">modelGroupConfig</span> <span class="hljs-operator">=</span> templateMakerModelConfig.getModelGroupConfig();
<span class="hljs-type">String</span> <span class="hljs-variable">newFileContent</span> <span class="hljs-operator">=</span> fileContent;
String replacement;
<span class="hljs-keyword">for</span> (TemplateMakerModelConfig.ModelInfoConfig modelInfoConfig : templateMakerModelConfig.getModels()) {
    <span class="hljs-comment">// 不是分组</span>
    <span class="hljs-keyword">if</span> (modelGroupConfig == <span class="hljs-literal">null</span>) {
        replacement = String.format(<span class="hljs-string">"${%s}"</span>, modelInfoConfig.getFieldName());
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-comment">// 是分组</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">groupKey</span> <span class="hljs-operator">=</span> modelGroupConfig.getGroupKey();
        <span class="hljs-comment">// 注意挖坑要多一个层级</span>
        replacement = String.format(<span class="hljs-string">"${%s.%s}"</span>, groupKey, modelInfoConfig.getFieldName());
    }
    <span class="hljs-comment">// 多次替换</span>
    newFileContent = StrUtil.replace(newFileContent, modelInfoConfig.getReplaceText(), replacement);
}
</code></pre>
<p>5）测试验证，定义一组能够替换 MySQL 配置的模型组参数，用来替换 <code>application.yml</code> 配置文件。</p>
<p>代码如下：</p>
<pre style="position: relative; padding-top: 3em; overflow: auto;"><div class="code-block-extension-header" style="position: absolute; top: 0; left: 0; width: 100%; height:28px; font-size:1em; background-color: rgb(248, 248, 248); box-shadow: 0px 4px 5px -6px #888888; display: flex; justify-content: space-between; align-items: center; padding: 0.5em 1em;"><div class="code-block-extension-headerLeft" style="filter: invert(0.5); opacity: 0.6;"><span class="code-block-extension-lang">java</span></div><div class="code-block-extension-headerRight" style="cursor: pointer;"><div class="code-block-extension-copyCodeBtn" style="filter: invert(0.5); opacity: 0.6;">复制代码</div></div></div><code class="language-java hljs" data-highlighted="yes"><span class="hljs-type">String</span> <span class="hljs-variable">inputFilePath2</span> <span class="hljs-operator">=</span> <span class="hljs-string">"src/main/resources/application.yml"</span>;

<span class="hljs-comment">// 模型参数配置</span>
<span class="hljs-type">TemplateMakerModelConfig</span> <span class="hljs-variable">templateMakerModelConfig</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TemplateMakerModelConfig</span>();

<span class="hljs-comment">// - 模型组配置</span>
TemplateMakerModelConfig.<span class="hljs-type">ModelGroupConfig</span> <span class="hljs-variable">modelGroupConfig</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TemplateMakerModelConfig</span>.ModelGroupConfig();
modelGroupConfig.setGroupKey(<span class="hljs-string">"mysql"</span>);
modelGroupConfig.setGroupName(<span class="hljs-string">"数据库配置"</span>);
templateMakerModelConfig.setModelGroupConfig(modelGroupConfig);

<span class="hljs-comment">// - 模型配置</span>
TemplateMakerModelConfig.<span class="hljs-type">ModelInfoConfig</span> <span class="hljs-variable">modelInfoConfig1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TemplateMakerModelConfig</span>.ModelInfoConfig();
modelInfoConfig1.setFieldName(<span class="hljs-string">"url"</span>);
modelInfoConfig1.setType(<span class="hljs-string">"String"</span>);
modelInfoConfig1.setDefaultValue(<span class="hljs-string">"jdbc:mysql://localhost:3306/my_db"</span>);
modelInfoConfig1.setReplaceText(<span class="hljs-string">"jdbc:mysql://localhost:3306/my_db"</span>);

TemplateMakerModelConfig.<span class="hljs-type">ModelInfoConfig</span> <span class="hljs-variable">modelInfoConfig2</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TemplateMakerModelConfig</span>.ModelInfoConfig();
modelInfoConfig2.setFieldName(<span class="hljs-string">"username"</span>);
modelInfoConfig2.setType(<span class="hljs-string">"String"</span>);
modelInfoConfig2.setDefaultValue(<span class="hljs-string">"root"</span>);
modelInfoConfig2.setReplaceText(<span class="hljs-string">"root"</span>);

List&lt;TemplateMakerModelConfig.ModelInfoConfig&gt; modelInfoConfigList = Arrays.asList(modelInfoConfig1, modelInfoConfig2);
templateMakerModelConfig.setModels(modelInfoConfigList);
</code></pre>
<p>执行，成功制作出了有多个参数的模板文件：</p>
<p><img src="https://pic.code-nav.cn/post_picture/1610518142000300034/c435db43-7700-4284-a4ea-4ce838ebfa27.png" alt="image.png" class="medium-zoom-image"></p>
<p>也成功生成了元信息文件：</p>
<p><img src="https://pic.code-nav.cn/post_picture/1610518142000300034/362ca9af-b54f-474d-810d-ae86a593f82f.png" alt="image.png" class="medium-zoom-image"></p>
<p>可以尝试更换模型参数组的 groupKey 或模型的 fieldName，测试能够正常追加模型配置。</p>
<p>至此，模型分组能力开发完成。</p>
<h4 data-id="heading-31">完整代码</h4>
<p><code>TemplateMaker</code> 的完整代码如下：</p>
<pre style="position: relative; padding-top: 3em; overflow: auto;"><div class="code-block-extension-header" style="position: absolute; top: 0; left: 0; width: 100%; height:28px; font-size:1em; background-color: rgb(248, 248, 248); box-shadow: 0px 4px 5px -6px #888888; display: flex; justify-content: space-between; align-items: center; padding: 0.5em 1em;"><div class="code-block-extension-headerLeft" style="filter: invert(0.5); opacity: 0.6;"><span class="code-block-extension-lang">java</span></div><div class="code-block-extension-headerRight" style="cursor: pointer;"><div class="code-block-extension-copyCodeBtn" style="filter: invert(0.5); opacity: 0.6;">复制代码</div></div></div><code class="language-java hljs" data-highlighted="yes"><span class="hljs-keyword">package</span> com.yupi.maker.template;

<span class="hljs-keyword">import</span> cn.hutool.core.bean.BeanUtil;
<span class="hljs-keyword">import</span> cn.hutool.core.bean.copier.CopyOptions;
<span class="hljs-keyword">import</span> cn.hutool.core.collection.CollUtil;
<span class="hljs-keyword">import</span> cn.hutool.core.io.FileUtil;
<span class="hljs-keyword">import</span> cn.hutool.core.util.IdUtil;
<span class="hljs-keyword">import</span> cn.hutool.core.util.StrUtil;
<span class="hljs-keyword">import</span> cn.hutool.json.JSONUtil;
<span class="hljs-keyword">import</span> com.yupi.maker.meta.Meta;
<span class="hljs-keyword">import</span> com.yupi.maker.meta.enums.FileGenerateTypeEnum;
<span class="hljs-keyword">import</span> com.yupi.maker.meta.enums.FileTypeEnum;
<span class="hljs-keyword">import</span> com.yupi.maker.template.enums.FileFilterRangeEnum;
<span class="hljs-keyword">import</span> com.yupi.maker.template.enums.FileFilterRuleEnum;
<span class="hljs-keyword">import</span> com.yupi.maker.template.model.FileFilterConfig;
<span class="hljs-keyword">import</span> com.yupi.maker.template.model.TemplateMakerFileConfig;
<span class="hljs-keyword">import</span> com.yupi.maker.template.model.TemplateMakerModelConfig;

<span class="hljs-keyword">import</span> java.io.File;
<span class="hljs-keyword">import</span> java.nio.file.Paths;
<span class="hljs-keyword">import</span> java.util.*;
<span class="hljs-keyword">import</span> java.util.stream.Collectors;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TemplateMaker</span> {

    <span class="hljs-comment">/**
     * 制作模板
     *
     * <span class="hljs-doctag">@param</span> newMeta
     * <span class="hljs-doctag">@param</span> originProjectPath
     * <span class="hljs-doctag">@param</span> templateMakerFileConfig
     * <span class="hljs-doctag">@param</span> templateMakerModelConfig
     * <span class="hljs-doctag">@param</span> id
     * <span class="hljs-doctag">@return</span>
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">long</span> <span class="hljs-title function_">makeTemplate</span><span class="hljs-params">(Meta newMeta, String originProjectPath, TemplateMakerFileConfig templateMakerFileConfig, TemplateMakerModelConfig templateMakerModelConfig, Long id)</span> {
        <span class="hljs-comment">// 没有 id 则生成</span>
        <span class="hljs-keyword">if</span> (id == <span class="hljs-literal">null</span>) {
            id = IdUtil.getSnowflakeNextId();
        }

        <span class="hljs-comment">// 复制目录</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">projectPath</span> <span class="hljs-operator">=</span> System.getProperty(<span class="hljs-string">"user.dir"</span>);
        <span class="hljs-type">String</span> <span class="hljs-variable">tempDirPath</span> <span class="hljs-operator">=</span> projectPath + File.separator + <span class="hljs-string">".temp"</span>;
        <span class="hljs-type">String</span> <span class="hljs-variable">templatePath</span> <span class="hljs-operator">=</span> tempDirPath + File.separator + id;

        <span class="hljs-comment">// 是否为首次制作模板</span>
        <span class="hljs-comment">// 目录不存在，则是首次制作</span>
        <span class="hljs-keyword">if</span> (!FileUtil.exist(templatePath)) {
            FileUtil.mkdir(templatePath);
            FileUtil.copy(originProjectPath, templatePath, <span class="hljs-literal">true</span>);
        }

        <span class="hljs-comment">// 一、输入信息</span>
        <span class="hljs-comment">// 输入文件信息</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">sourceRootPath</span> <span class="hljs-operator">=</span> templatePath + File.separator + FileUtil.getLastPathEle(Paths.get(originProjectPath)).toString();
        <span class="hljs-comment">// 注意 win 系统需要对路径进行转义</span>
    	sourceRootPath = sourceRootPath.replaceAll(<span class="hljs-string">"\\\\"</span>, <span class="hljs-string">"/"</span>);
        List&lt;TemplateMakerFileConfig.FileInfoConfig&gt; fileConfigInfoList = templateMakerFileConfig.getFiles();

        <span class="hljs-comment">// 二、生成文件模板</span>
        <span class="hljs-comment">// 遍历输入文件</span>
        List&lt;Meta.FileConfig.FileInfo&gt; newFileInfoList = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();
        <span class="hljs-keyword">for</span> (TemplateMakerFileConfig.FileInfoConfig fileInfoConfig : fileConfigInfoList) {
            <span class="hljs-type">String</span> <span class="hljs-variable">inputFilePath</span> <span class="hljs-operator">=</span> fileInfoConfig.getPath();

            <span class="hljs-comment">// 如果填的是相对路径，要改为绝对路径</span>
            <span class="hljs-keyword">if</span> (!inputFilePath.startsWith(sourceRootPath)) {
                inputFilePath = sourceRootPath + File.separator + inputFilePath;
            }

            <span class="hljs-comment">// 获取过滤后的文件列表（不会存在目录）</span>
            List&lt;File&gt; fileList = FileFilter.doFilter(inputFilePath, fileInfoConfig.getFilterConfigList());
            <span class="hljs-keyword">for</span> (File file : fileList) {
                Meta.FileConfig.<span class="hljs-type">FileInfo</span> <span class="hljs-variable">fileInfo</span> <span class="hljs-operator">=</span> makeFileTemplate(templateMakerModelConfig, sourceRootPath, file);
                newFileInfoList.add(fileInfo);
            }
        }

        <span class="hljs-comment">// 如果是文件组</span>
        TemplateMakerFileConfig.<span class="hljs-type">FileGroupConfig</span> <span class="hljs-variable">fileGroupConfig</span> <span class="hljs-operator">=</span> templateMakerFileConfig.getFileGroupConfig();
        <span class="hljs-keyword">if</span> (fileGroupConfig != <span class="hljs-literal">null</span>) {
            <span class="hljs-type">String</span> <span class="hljs-variable">condition</span> <span class="hljs-operator">=</span> fileGroupConfig.getCondition();
            <span class="hljs-type">String</span> <span class="hljs-variable">groupKey</span> <span class="hljs-operator">=</span> fileGroupConfig.getGroupKey();
            <span class="hljs-type">String</span> <span class="hljs-variable">groupName</span> <span class="hljs-operator">=</span> fileGroupConfig.getGroupName();

            <span class="hljs-comment">// 新增分组配置</span>
            Meta.FileConfig.<span class="hljs-type">FileInfo</span> <span class="hljs-variable">groupFileInfo</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Meta</span>.FileConfig.FileInfo();
            groupFileInfo.setType(FileTypeEnum.GROUP.getValue());
            groupFileInfo.setCondition(condition);
            groupFileInfo.setGroupKey(groupKey);
            groupFileInfo.setGroupName(groupName);
            <span class="hljs-comment">// 文件全放到一个分组内</span>
            groupFileInfo.setFiles(newFileInfoList);
            newFileInfoList = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();
            newFileInfoList.add(groupFileInfo);
        }

        <span class="hljs-comment">// 处理模型信息</span>
        List&lt;TemplateMakerModelConfig.ModelInfoConfig&gt; models = templateMakerModelConfig.getModels();
        <span class="hljs-comment">// - 转换为配置接受的 ModelInfo 对象</span>
        List&lt;Meta.ModelConfig.ModelInfo&gt; inputModelInfoList = models.stream().map(modelInfoConfig -&gt; {
            Meta.ModelConfig.<span class="hljs-type">ModelInfo</span> <span class="hljs-variable">modelInfo</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Meta</span>.ModelConfig.ModelInfo();
            BeanUtil.copyProperties(modelInfoConfig, modelInfo);
            <span class="hljs-keyword">return</span> modelInfo;
        }).collect(Collectors.toList());

        <span class="hljs-comment">// - 本次新增的模型配置列表</span>
        List&lt;Meta.ModelConfig.ModelInfo&gt; newModelInfoList = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();

        <span class="hljs-comment">// - 如果是模型组</span>
        TemplateMakerModelConfig.<span class="hljs-type">ModelGroupConfig</span> <span class="hljs-variable">modelGroupConfig</span> <span class="hljs-operator">=</span> templateMakerModelConfig.getModelGroupConfig();
        <span class="hljs-keyword">if</span> (modelGroupConfig != <span class="hljs-literal">null</span>) {
            <span class="hljs-type">String</span> <span class="hljs-variable">condition</span> <span class="hljs-operator">=</span> modelGroupConfig.getCondition();
            <span class="hljs-type">String</span> <span class="hljs-variable">groupKey</span> <span class="hljs-operator">=</span> modelGroupConfig.getGroupKey();
            <span class="hljs-type">String</span> <span class="hljs-variable">groupName</span> <span class="hljs-operator">=</span> modelGroupConfig.getGroupName();
            Meta.ModelConfig.<span class="hljs-type">ModelInfo</span> <span class="hljs-variable">groupModelInfo</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Meta</span>.ModelConfig.ModelInfo();
            groupModelInfo.setGroupKey(groupKey);
            groupModelInfo.setGroupName(groupName);
            groupModelInfo.setCondition(condition);

            <span class="hljs-comment">// 模型全放到一个分组内</span>
            groupModelInfo.setModels(inputModelInfoList);
            newModelInfoList.add(groupModelInfo);
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-comment">// 不分组，添加所有的模型信息到列表</span>
            newModelInfoList.addAll(inputModelInfoList);
        }

        <span class="hljs-comment">// 三、生成配置文件</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">metaOutputPath</span> <span class="hljs-operator">=</span> sourceRootPath + File.separator + <span class="hljs-string">"meta.json"</span>;

        <span class="hljs-comment">// 如果已有 meta 文件，说明不是第一次制作，则在 meta 基础上进行修改</span>
        <span class="hljs-keyword">if</span> (FileUtil.exist(metaOutputPath)) {
            <span class="hljs-type">Meta</span> <span class="hljs-variable">oldMeta</span> <span class="hljs-operator">=</span> JSONUtil.toBean(FileUtil.readUtf8String(metaOutputPath), Meta.class);
            BeanUtil.copyProperties(newMeta, oldMeta, CopyOptions.create().ignoreNullValue());
            newMeta = oldMeta;

            <span class="hljs-comment">// 1. 追加配置参数</span>
            List&lt;Meta.FileConfig.FileInfo&gt; fileInfoList = newMeta.getFileConfig().getFiles();
            fileInfoList.addAll(newFileInfoList);
            List&lt;Meta.ModelConfig.ModelInfo&gt; modelInfoList = newMeta.getModelConfig().getModels();
            modelInfoList.addAll(newModelInfoList);

            <span class="hljs-comment">// 配置去重</span>
            newMeta.getFileConfig().setFiles(distinctFiles(fileInfoList));
            newMeta.getModelConfig().setModels(distinctModels(modelInfoList));
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-comment">// 1. 构造配置参数</span>
            Meta.<span class="hljs-type">FileConfig</span> <span class="hljs-variable">fileConfig</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Meta</span>.FileConfig();
            newMeta.setFileConfig(fileConfig);
            fileConfig.setSourceRootPath(sourceRootPath);
            List&lt;Meta.FileConfig.FileInfo&gt; fileInfoList = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();
            fileConfig.setFiles(fileInfoList);
            fileInfoList.addAll(newFileInfoList);

            Meta.<span class="hljs-type">ModelConfig</span> <span class="hljs-variable">modelConfig</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Meta</span>.ModelConfig();
            newMeta.setModelConfig(modelConfig);
            List&lt;Meta.ModelConfig.ModelInfo&gt; modelInfoList = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();
            modelConfig.setModels(modelInfoList);
            modelInfoList.addAll(newModelInfoList);
        }

        <span class="hljs-comment">// 2. 输出元信息文件</span>
        FileUtil.writeUtf8String(JSONUtil.toJsonPrettyStr(newMeta), metaOutputPath);
        <span class="hljs-keyword">return</span> id;
    }

    <span class="hljs-comment">/**
     * 制作文件模板
     *
     * <span class="hljs-doctag">@param</span> templateMakerModelConfig
     * <span class="hljs-doctag">@param</span> sourceRootPath
     * <span class="hljs-doctag">@param</span> inputFile
     * <span class="hljs-doctag">@return</span>
     */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Meta.FileConfig.FileInfo <span class="hljs-title function_">makeFileTemplate</span><span class="hljs-params">(TemplateMakerModelConfig templateMakerModelConfig, String sourceRootPath, File inputFile)</span> {
        <span class="hljs-comment">// 要挖坑的文件绝对路径（用于制作模板）</span>
        <span class="hljs-comment">// 注意 win 系统需要对路径进行转义</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">fileInputAbsolutePath</span> <span class="hljs-operator">=</span> inputFile.getAbsolutePath().replaceAll(<span class="hljs-string">"\\\\"</span>, <span class="hljs-string">"/"</span>);
        <span class="hljs-type">String</span> <span class="hljs-variable">fileOutputAbsolutePath</span> <span class="hljs-operator">=</span> fileInputAbsolutePath + <span class="hljs-string">".ftl"</span>;
    
        <span class="hljs-comment">// 文件输入输出相对路径（用于生成配置）</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">fileInputPath</span> <span class="hljs-operator">=</span> fileInputAbsolutePath.replace(sourceRootPath + <span class="hljs-string">"/"</span>, <span class="hljs-string">""</span>);
        <span class="hljs-type">String</span> <span class="hljs-variable">fileOutputPath</span> <span class="hljs-operator">=</span> fileInputPath + <span class="hljs-string">".ftl"</span>;
        
        <span class="hljs-comment">// 使用字符串替换，生成模板文件</span>
        String fileContent;
        <span class="hljs-comment">// 如果已有模板文件，说明不是第一次制作，则在模板基础上再次挖坑</span>
        <span class="hljs-keyword">if</span> (FileUtil.exist(fileOutputAbsolutePath)) {
            fileContent = FileUtil.readUtf8String(fileOutputAbsolutePath);
        } <span class="hljs-keyword">else</span> {
            fileContent = FileUtil.readUtf8String(fileInputAbsolutePath);
        }

        <span class="hljs-comment">// 支持多个模型：对同一个文件的内容，遍历模型进行多轮替换</span>
        TemplateMakerModelConfig.<span class="hljs-type">ModelGroupConfig</span> <span class="hljs-variable">modelGroupConfig</span> <span class="hljs-operator">=</span> templateMakerModelConfig.getModelGroupConfig();
        <span class="hljs-type">String</span> <span class="hljs-variable">newFileContent</span> <span class="hljs-operator">=</span> fileContent;
        String replacement;
        <span class="hljs-keyword">for</span> (TemplateMakerModelConfig.ModelInfoConfig modelInfoConfig : templateMakerModelConfig.getModels()) {
            <span class="hljs-comment">// 不是分组</span>
            <span class="hljs-keyword">if</span> (modelGroupConfig == <span class="hljs-literal">null</span>) {
                replacement = String.format(<span class="hljs-string">"${%s}"</span>, modelInfoConfig.getFieldName());
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-comment">// 是分组</span>
                <span class="hljs-type">String</span> <span class="hljs-variable">groupKey</span> <span class="hljs-operator">=</span> modelGroupConfig.getGroupKey();
                <span class="hljs-comment">// 注意挖坑要多一个层级</span>
                replacement = String.format(<span class="hljs-string">"${%s.%s}"</span>, groupKey, modelInfoConfig.getFieldName());
            }
            <span class="hljs-comment">// 多次替换</span>
            newFileContent = StrUtil.replace(newFileContent, modelInfoConfig.getReplaceText(), replacement);
        }

        <span class="hljs-comment">// 文件配置信息</span>
        Meta.FileConfig.<span class="hljs-type">FileInfo</span> <span class="hljs-variable">fileInfo</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Meta</span>.FileConfig.FileInfo();
        fileInfo.setInputPath(fileInputPath);
        fileInfo.setOutputPath(fileOutputPath);
        fileInfo.setType(FileTypeEnum.FILE.getValue());

        <span class="hljs-comment">// 和原文件一致，没有挖坑，则为静态生成</span>
        <span class="hljs-keyword">if</span> (newFileContent.equals(fileContent)) {
            <span class="hljs-comment">// 输出路径 = 输入路径</span>
            fileInfo.setOutputPath(fileInputPath);
            fileInfo.setGenerateType(FileGenerateTypeEnum.STATIC.getValue());
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-comment">// 生成模板文件</span>
            fileInfo.setGenerateType(FileGenerateTypeEnum.DYNAMIC.getValue());
            FileUtil.writeUtf8String(newFileContent, fileOutputAbsolutePath);
        }
        <span class="hljs-keyword">return</span> fileInfo;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-type">Meta</span> <span class="hljs-variable">meta</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Meta</span>();
        meta.setName(<span class="hljs-string">"acm-template-generator"</span>);
        meta.setDescription(<span class="hljs-string">"ACM 示例模板生成器"</span>);

        <span class="hljs-type">String</span> <span class="hljs-variable">projectPath</span> <span class="hljs-operator">=</span> System.getProperty(<span class="hljs-string">"user.dir"</span>);
        <span class="hljs-type">String</span> <span class="hljs-variable">originProjectPath</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(projectPath).getParent() + File.separator + <span class="hljs-string">"yuzi-generator-demo-projects/springboot-init"</span>;
        <span class="hljs-type">String</span> <span class="hljs-variable">inputFilePath1</span> <span class="hljs-operator">=</span> <span class="hljs-string">"src/main/java/com/yupi/springbootinit/common"</span>;
        <span class="hljs-type">String</span> <span class="hljs-variable">inputFilePath2</span> <span class="hljs-operator">=</span> <span class="hljs-string">"src/main/resources/application.yml"</span>;

        <span class="hljs-comment">// 模型参数配置</span>
        <span class="hljs-type">TemplateMakerModelConfig</span> <span class="hljs-variable">templateMakerModelConfig</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TemplateMakerModelConfig</span>();

        <span class="hljs-comment">// - 模型组配置</span>
        TemplateMakerModelConfig.<span class="hljs-type">ModelGroupConfig</span> <span class="hljs-variable">modelGroupConfig</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TemplateMakerModelConfig</span>.ModelGroupConfig();
        modelGroupConfig.setGroupKey(<span class="hljs-string">"mysql"</span>);
        modelGroupConfig.setGroupName(<span class="hljs-string">"数据库配置"</span>);
        templateMakerModelConfig.setModelGroupConfig(modelGroupConfig);

        <span class="hljs-comment">// - 模型配置</span>
        TemplateMakerModelConfig.<span class="hljs-type">ModelInfoConfig</span> <span class="hljs-variable">modelInfoConfig1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TemplateMakerModelConfig</span>.ModelInfoConfig();
        modelInfoConfig1.setFieldName(<span class="hljs-string">"url"</span>);
        modelInfoConfig1.setType(<span class="hljs-string">"String"</span>);
        modelInfoConfig1.setDefaultValue(<span class="hljs-string">"jdbc:mysql://localhost:3306/my_db"</span>);
        modelInfoConfig1.setReplaceText(<span class="hljs-string">"jdbc:mysql://localhost:3306/my_db"</span>);

        TemplateMakerModelConfig.<span class="hljs-type">ModelInfoConfig</span> <span class="hljs-variable">modelInfoConfig2</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TemplateMakerModelConfig</span>.ModelInfoConfig();
        modelInfoConfig2.setFieldName(<span class="hljs-string">"username"</span>);
        modelInfoConfig2.setType(<span class="hljs-string">"String"</span>);
        modelInfoConfig2.setDefaultValue(<span class="hljs-string">"root"</span>);
        modelInfoConfig2.setReplaceText(<span class="hljs-string">"root"</span>);

        List&lt;TemplateMakerModelConfig.ModelInfoConfig&gt; modelInfoConfigList = Arrays.asList(modelInfoConfig1, modelInfoConfig2);
        templateMakerModelConfig.setModels(modelInfoConfigList);

        <span class="hljs-comment">// 替换变量（首次）</span>
<span class="hljs-comment">//        String searchStr = "Sum: ";</span>
        <span class="hljs-comment">// 替换变量（第二次）</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">searchStr</span> <span class="hljs-operator">=</span> <span class="hljs-string">"BaseResponse"</span>;

        <span class="hljs-comment">// 文件过滤</span>
        <span class="hljs-type">TemplateMakerFileConfig</span> <span class="hljs-variable">templateMakerFileConfig</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TemplateMakerFileConfig</span>();
        TemplateMakerFileConfig.<span class="hljs-type">FileInfoConfig</span> <span class="hljs-variable">fileInfoConfig1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TemplateMakerFileConfig</span>.FileInfoConfig();
        fileInfoConfig1.setPath(inputFilePath1);
        List&lt;FileFilterConfig&gt; fileFilterConfigList = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();
        <span class="hljs-type">FileFilterConfig</span> <span class="hljs-variable">fileFilterConfig</span> <span class="hljs-operator">=</span> FileFilterConfig.builder()
                .range(FileFilterRangeEnum.FILE_NAME.getValue())
                .rule(FileFilterRuleEnum.CONTAINS.getValue())
                .value(<span class="hljs-string">"Base"</span>)
                .build();
        fileFilterConfigList.add(fileFilterConfig);
        fileInfoConfig1.setFilterConfigList(fileFilterConfigList);

        TemplateMakerFileConfig.<span class="hljs-type">FileInfoConfig</span> <span class="hljs-variable">fileInfoConfig2</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TemplateMakerFileConfig</span>.FileInfoConfig();
        fileInfoConfig2.setPath(inputFilePath2);
        templateMakerFileConfig.setFiles(Arrays.asList(fileInfoConfig1, fileInfoConfig2));

        <span class="hljs-comment">// 分组配置</span>
        TemplateMakerFileConfig.<span class="hljs-type">FileGroupConfig</span> <span class="hljs-variable">fileGroupConfig</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TemplateMakerFileConfig</span>.FileGroupConfig();
        fileGroupConfig.setCondition(<span class="hljs-string">"outputText"</span>);
        fileGroupConfig.setGroupKey(<span class="hljs-string">"test"</span>);
        fileGroupConfig.setGroupName(<span class="hljs-string">"测试分组"</span>);
        templateMakerFileConfig.setFileGroupConfig(fileGroupConfig);

        <span class="hljs-type">long</span> <span class="hljs-variable">id</span> <span class="hljs-operator">=</span> makeTemplate(meta, originProjectPath, templateMakerFileConfig, templateMakerModelConfig, <span class="hljs-number">1735281524670181376L</span>);
        System.out.println(id);
    }

    <span class="hljs-comment">/**
     * 模型去重
     *
     * <span class="hljs-doctag">@param</span> modelInfoList
     * <span class="hljs-doctag">@return</span>
     */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> List&lt;Meta.ModelConfig.ModelInfo&gt; distinctModels(List&lt;Meta.ModelConfig.ModelInfo&gt; modelInfoList) {
        <span class="hljs-comment">// 策略：同分组内模型 merge，不同分组保留</span>

        <span class="hljs-comment">// 1. 有分组的，以组为单位划分</span>
        Map&lt;String, List&lt;Meta.ModelConfig.ModelInfo&gt;&gt; groupKeyModelInfoListMap = modelInfoList
                .stream()
                .filter(modelInfo -&gt; StrUtil.isNotBlank(modelInfo.getGroupKey()))
                .collect(
                        Collectors.groupingBy(Meta.ModelConfig.ModelInfo::getGroupKey)
                );


        <span class="hljs-comment">// 2. 同组内的模型配置合并</span>
        <span class="hljs-comment">// 保存每个组对应的合并后的对象 map</span>
        Map&lt;String, Meta.ModelConfig.ModelInfo&gt; groupKeyMergedModelInfoMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();
        <span class="hljs-keyword">for</span> (Map.Entry&lt;String, List&lt;Meta.ModelConfig.ModelInfo&gt;&gt; entry : groupKeyModelInfoListMap.entrySet()) {
            List&lt;Meta.ModelConfig.ModelInfo&gt; tempModelInfoList = entry.getValue();
            List&lt;Meta.ModelConfig.ModelInfo&gt; newModelInfoList = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;(tempModelInfoList.stream()
                    .flatMap(modelInfo -&gt; modelInfo.getModels().stream())
                    .collect(
                            Collectors.toMap(Meta.ModelConfig.ModelInfo::getFieldName, o -&gt; o, (e, r) -&gt; r)
                    ).values());

            <span class="hljs-comment">// 使用新的 group 配置</span>
            Meta.ModelConfig.<span class="hljs-type">ModelInfo</span> <span class="hljs-variable">newModelInfo</span> <span class="hljs-operator">=</span> CollUtil.getLast(tempModelInfoList);
            newModelInfo.setModels(newModelInfoList);
            <span class="hljs-type">String</span> <span class="hljs-variable">groupKey</span> <span class="hljs-operator">=</span> entry.getKey();
            groupKeyMergedModelInfoMap.put(groupKey, newModelInfo);
        }

        <span class="hljs-comment">// 3. 将模型分组添加到结果列表</span>
        List&lt;Meta.ModelConfig.ModelInfo&gt; resultList = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;(groupKeyMergedModelInfoMap.values());

        <span class="hljs-comment">// 4. 将未分组的模型添加到结果列表</span>
        List&lt;Meta.ModelConfig.ModelInfo&gt; noGroupModelInfoList = modelInfoList.stream().filter(modelInfo -&gt; StrUtil.isBlank(modelInfo.getGroupKey()))
                .collect(Collectors.toList());
        resultList.addAll(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;(noGroupModelInfoList.stream()
                .collect(
                        Collectors.toMap(Meta.ModelConfig.ModelInfo::getFieldName, o -&gt; o, (e, r) -&gt; r)
                ).values()));
        <span class="hljs-keyword">return</span> resultList;
    }

    <span class="hljs-comment">/**
     * 文件去重
     *
     * <span class="hljs-doctag">@param</span> fileInfoList
     * <span class="hljs-doctag">@return</span>
     */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> List&lt;Meta.FileConfig.FileInfo&gt; distinctFiles(List&lt;Meta.FileConfig.FileInfo&gt; fileInfoList) {
        <span class="hljs-comment">// 策略：同分组内文件 merge，不同分组保留</span>

        <span class="hljs-comment">// 1. 有分组的，以组为单位划分</span>
        Map&lt;String, List&lt;Meta.FileConfig.FileInfo&gt;&gt; groupKeyFileInfoListMap = fileInfoList
                .stream()
                .filter(fileInfo -&gt; StrUtil.isNotBlank(fileInfo.getGroupKey()))
                .collect(
                        Collectors.groupingBy(Meta.FileConfig.FileInfo::getGroupKey)
                );


        <span class="hljs-comment">// 2. 同组内的文件配置合并</span>
        <span class="hljs-comment">// 保存每个组对应的合并后的对象 map</span>
        Map&lt;String, Meta.FileConfig.FileInfo&gt; groupKeyMergedFileInfoMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();
        <span class="hljs-keyword">for</span> (Map.Entry&lt;String, List&lt;Meta.FileConfig.FileInfo&gt;&gt; entry : groupKeyFileInfoListMap.entrySet()) {
            List&lt;Meta.FileConfig.FileInfo&gt; tempFileInfoList = entry.getValue();
            List&lt;Meta.FileConfig.FileInfo&gt; newFileInfoList = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;(tempFileInfoList.stream()
                    .flatMap(fileInfo -&gt; fileInfo.getFiles().stream())
                    .collect(
                            Collectors.toMap(Meta.FileConfig.FileInfo::getInputPath, o -&gt; o, (e, r) -&gt; r)
                    ).values());

            <span class="hljs-comment">// 使用新的 group 配置</span>
            Meta.FileConfig.<span class="hljs-type">FileInfo</span> <span class="hljs-variable">newFileInfo</span> <span class="hljs-operator">=</span> CollUtil.getLast(tempFileInfoList);
            newFileInfo.setFiles(newFileInfoList);
            <span class="hljs-type">String</span> <span class="hljs-variable">groupKey</span> <span class="hljs-operator">=</span> entry.getKey();
            groupKeyMergedFileInfoMap.put(groupKey, newFileInfo);
        }

        <span class="hljs-comment">// 3. 将文件分组添加到结果列表</span>
        List&lt;Meta.FileConfig.FileInfo&gt; resultList = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;(groupKeyMergedFileInfoMap.values());

        <span class="hljs-comment">// 4. 将未分组的文件添加到结果列表</span>
        List&lt;Meta.FileConfig.FileInfo&gt; noGroupFileInfoList = fileInfoList.stream().filter(fileInfo -&gt; StrUtil.isBlank(fileInfo.getGroupKey()))
                .collect(Collectors.toList());
        resultList.addAll(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;(noGroupFileInfoList.stream()
                .collect(
                        Collectors.toMap(Meta.FileConfig.FileInfo::getInputPath, o -&gt; o, (e, r) -&gt; r)
                ).values()));
        <span class="hljs-keyword">return</span> resultList;
    }
}

</code></pre>
<h2 data-id="heading-32">最后</h2>
<p>以上就是本节教程，我们给制作工具项目增加了模板制作功能，能够根据用户指定的文件和模型参数快速生成模板和元信息配置。并且支持了单次制作多个模板、文件过滤、文件分组、模型分组等多个功能。</p>
<p>本节教程涉及到大量的编码，在编码中，其实蕴含了很多小技巧，比如 Lambda 表达式编程、复用变量、抽象封装方法等。建议大家自己实现这些代码，锻炼一下自己的逻辑思维能力。</p>
<p>在下节教程中，我们将进一步完善模板制作工具，并且使用本阶段开发的制作工具，来快速制作 Spring Boot 项目模板代码生成器。</p>
<h2 data-id="heading-33">本期作业</h2>
<p>1）掌握文件逻辑机制的设计，再遇到类似的需求，能想到更灵活的设计方式。</p>
<p>2）掌握本节代码用到的 API，尤其是 Lambda 表达式编程，能自己编写出同样的代码。</p>
<p>3）自己编写代码实现本节项目，并且在自己的代码仓库完成一次提交。</p></div></div></div><div style="margin-bottom: 16px;"></div><div style="margin-bottom: 16px;"></div><div id="toggleArea" class="ant-row ant-row-no-wrap ant-row-space-between" style="margin-left: -10px; margin-right: -10px; margin-top: 40px; row-gap: 20px;"><div class="ant-col" style="padding-left: 10px; padding-right: 10px;"><div>上一节</div><a href="/course/1790980795074654209/section/1790995923979513857"><div class="ant-space ant-space-horizontal ant-space-align-center" style="gap: 8px;"><div class="ant-space-item" style=""><span role="img" aria-label="double-left" class="anticon anticon-double-left" style="font-size: 10px;"><svg viewBox="64 64 896 896" focusable="false" data-icon="double-left" width="1em" height="1em" fill="currentColor" aria-hidden="true"><path d="M272.9 512l265.4-339.1c4.1-5.2.4-12.9-6.3-12.9h-77.3c-4.9 0-9.6 2.3-12.6 6.1L186.8 492.3a31.99 31.99 0 000 39.5l255.3 326.1c3 3.9 7.7 6.1 12.6 6.1H532c6.7 0 10.4-7.7 6.3-12.9L272.9 512zm304 0l265.4-339.1c4.1-5.2.4-12.9-6.3-12.9h-77.3c-4.9 0-9.6 2.3-12.6 6.1L490.8 492.3a31.99 31.99 0 000 39.5l255.3 326.1c3 3.9 7.7 6.1 12.6 6.1H836c6.7 0 10.4-7.7 6.3-12.9L576.9 512z"></path></svg></span></div><div class="ant-space-item"><div class="text-ellipsis">6. 配置能力增强</div></div></div></a></div><div class="ant-col" style="padding-left: 10px; padding-right: 10px;"><div>下一节</div><a href="/course/1790980795074654209/section/1790996017009176577"><div class="ant-space ant-space-horizontal ant-space-align-center" style="gap: 8px;"><div class="ant-space-item" style=""><div class="text-ellipsis">8. 模板项目生成</div></div><div class="ant-space-item"><span role="img" aria-label="double-right" class="anticon anticon-double-right" style="font-size: 10px;"><svg viewBox="64 64 896 896" focusable="false" data-icon="double-right" width="1em" height="1em" fill="currentColor" aria-hidden="true"><path d="M533.2 492.3L277.9 166.1c-3-3.9-7.7-6.1-12.6-6.1H188c-6.7 0-10.4 7.7-6.3 12.9L447.1 512 181.7 851.1A7.98 7.98 0 00188 864h77.3c4.9 0 9.6-2.3 12.6-6.1l255.3-326.1c9.1-11.7 9.1-27.9 0-39.5zm304 0L581.9 166.1c-3-3.9-7.7-6.1-12.6-6.1H492c-6.7 0-10.4 7.7-6.3 12.9L751.1 512 485.7 851.1A7.98 7.98 0 00492 864h77.3c4.9 0 9.6-2.3 12.6-6.1l255.3-326.1c9.1-11.7 9.1-27.9 0-39.5z"></path></svg></span></div></div></a></div></div></div>